
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WhatsApp Clone Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --whatsapp-green: #075E54;
            --whatsapp-light-green: #128C7E;
            --message-bg-sender: #DCF8C6;
            --message-bg-receiver: #FFFFFF;
            --bg-body: #ECE5DD;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        /* Full height for auth screen */
        #auth-container {
            min-height: 100vh;
            background-color: var(--bg-body);
        }
        .auth-card {
            background-color: white;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .app-main-container {
            max-width: 1200px;
            height: 95vh;
            margin: 0 auto;
            border: 1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex; /* Enable flex for split view */
        }
        .header-bg {
            background-color: var(--whatsapp-green);
        }
        .sender-bubble {
            background-color: var(--message-bg-sender);
            border-radius: 10px 10px 0 10px;
            max-width: 80%;
            padding: 8px 10px;
            word-wrap: break-word;
        }
        .receiver-bubble {
            background-color: var(--message-bg-receiver);
            border-radius: 10px 10px 10px 0;
            max-width: 80%;
            padding: 8px 10px;
            word-wrap: break-word;
        }
        #message-display {
            overflow-y: auto;
            overflow-x: hidden;
            height: calc(100% - 78px); /* Adjusted for new chat layout */
            padding: 16px;
            box-sizing: border-box;
            /* WhatsApp-like light green + cream doodle pattern */
            background-color: #f7f5ef; /* soft cream */
            background-image: 
                linear-gradient(135deg, #f9f7f2 0%, #eaf7ea 100%),
                url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='360' height='360' viewBox='0 0 360 360'><defs><pattern id='doodles' width='180' height='180' patternUnits='userSpaceOnUse'><g fill='none' stroke='%2374b49b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' opacity='0.45'><path d='M20 20c0-8 12-8 12 0s-12 8-12 0z'/><path d='M52 22l14 8-14 8z'/><path d='M86 18h20v14H86z'/><path d='M130 15a10 10 0 1 0 0.1 0z'/><path d='M18 70l22-6 22 6-22 6z'/><path d='M74 64c8 0 8 12 0 12s-8-12 0-12z'/><path d='M110 60l10 10 10-10'/><path d='M148 50v20'/><path d='M26 118c10-8 26-8 36 0M26 130c10-8 26-8 36 0'/><path d='M80 112l10 22h-20z'/><path d='M114 110h28v16H114z m6-6h16'/><path d='M150 106l14 6-6 14-14-6z'/></g></pattern></defs><rect width='100%' height='100%' fill='transparent'/><rect width='100%' height='100%' fill='url(%23doodles)'/></svg>");
            background-size: cover, 520px 520px; /* gradient cover + crisp pattern */
            background-attachment: fixed, fixed;
            /* Ensure proper scrolling behavior */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .media-button {
            transition: all 0.2s;
        }
        .media-button:hover {
            transform: scale(1.1);
        }
        .recording-indicator {
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        /* Responsive Split View */
        .left-panel {
            width: 35%;
            min-width: 300px;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow-y: hidden; /* Main panel overflow handled by children */
        }
        .right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Global mobile improvements */
        * {
            box-sizing: border-box;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            /* Prevent zoom on input focus */
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
        }
        
        body {
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior: none;
            /* Better touch scrolling */
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .app-main-container {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                max-width: none;
            }
            .left-panel {
                width: 100%;
                min-width: unset;
                border-right: none;
            }
            .right-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                z-index: 10; /* Bring chat view to front */
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #message-display {
                height: calc(100vh - 120px - env(safe-area-inset-bottom, 0px) - 20px);
                height: calc(100dvh - 120px - env(safe-area-inset-bottom, 0px) - 20px);
                padding: 8px 12px;
                padding-bottom: 80px;
                box-sizing: border-box;
                overflow-x: hidden;
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                /* Ensure messages don't overlap with input area */
                margin-bottom: 0;
                /* Better mobile scrolling */
                overscroll-behavior: contain;
                /* Prevent bounce scrolling */
                -webkit-overflow-scrolling: touch;
                /* Better touch interaction */
                touch-action: pan-y;
            }
            
            /* Mobile header improvements */
            .mobile-header {
                padding: 12px 16px;
                padding-top: calc(12px + env(safe-area-inset-top, 0px) + 10px);
                min-height: 60px;
            }
            
            .mobile-whatsapp-title {
                font-size: 20px;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            
            /* Mobile message input improvements - Compact design */
            #chat-input-area {
                padding: 8px 6px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px) + 8px);
                background: #f0f0f0;
                border-top: 1px solid #e0e0e0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                width: 100%;
                box-sizing: border-box;
                /* Compact height for mobile */
                min-height: 60px;
                display: flex;
                align-items: center;
                /* Add shadow for better separation */
                box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
                /* Better mobile touch interaction */
                -webkit-tap-highlight-color: transparent;
                /* Prevent pull-to-refresh interference */
                overscroll-behavior: contain;
            }
            
            .message-input-container {
                min-height: 36px;
                padding: 4px 4px;
                background: white;
                border-radius: 18px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 4px;
                width: 100%;
                box-sizing: border-box;
                max-width: 100%;
                position: relative;
                z-index: 1001;
                /* Compact mobile button positioning */
                padding-left: 4px;
                padding-right: 4px;
                /* Better mobile touch interaction */
                -webkit-tap-highlight-color: transparent;
                /* Prevent text selection */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            .message-input {
                font-size: 16px;
                padding: 4px 6px;
                min-height: 24px;
                flex: 1;
                border: none;
                outline: none;
                background: transparent;
                /* Prevent zoom on input focus */
                font-size: 16px !important;
                /* Better touch interaction */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                /* Prevent text selection issues */
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
            
            /* Mobile button improvements - Compact design */
            .emoji-btn, .attachment-btn, .send-btn, .mic-btn {
                width: 28px;
                height: 28px;
                min-width: 28px;
                min-height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                background: transparent;
                border-radius: 50%;
                cursor: pointer;
                transition: background-color 0.2s;
                flex-shrink: 0;
                /* Compact mobile positioning - moved more to the left */
                margin: 0 1px;
                /* Better touch interaction */
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                /* Ensure buttons are touchable */
                touch-action: manipulation;
            }
            
            .emoji-btn:hover, .attachment-btn:hover, .send-btn:hover, .mic-btn:hover {
                background-color: rgba(0,0,0,0.1);
            }
            
            /* Mobile-specific button positioning - ensure they're on the left */
            .emoji-btn {
                order: 1;
                margin-left: 0;
            }
            
            .attachment-btn {
                order: 2;
            }
            
            .message-input {
                order: 3;
                flex: 1;
                min-width: 0; /* Allow input to shrink */
            }
            
            .send-btn, .mic-btn {
                order: 4;
                margin-right: 0;
                /* Ensure buttons fit on mobile screen */
                flex-shrink: 0;
            }
            
            /* Ensure proper spacing for mobile */
            .message-input-container {
                justify-content: flex-start;
                align-items: center;
                /* Ensure container doesn't overflow */
                max-width: 100%;
                overflow: hidden;
            }
            
            /* Mobile-specific adjustments for better fit */
            @media (max-width: 480px) {
                .message-input-container {
                    gap: 2px; /* Smaller gap on very small screens */
                    padding: 3px 3px;
                }
                
                .emoji-btn, .attachment-btn, .send-btn, .mic-btn {
                    width: 26px;
                    height: 26px;
                    min-width: 26px;
                    min-height: 26px;
                    margin: 0 0.5px;
                }
                
                .message-input {
                    padding: 3px 4px;
                    font-size: 15px;
                }
            }
            
            /* Mobile chat header improvements */
            .chat-header-mobile {
                padding: 12px 16px;
                padding-top: calc(12px + env(safe-area-inset-top, 0px) + 10px);
                min-height: 60px;
            }
            
            .chat-header-mobile h1 {
                font-size: 18px;
                font-weight: 600;
            }
            
            /* Mobile attachment menu improvements */
            .attachment-menu {
                bottom: 100%;
                left: 0;
                right: 0;
                margin-bottom: 8px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            /* Mobile message spacing improvements */
            .message-row {
                margin-bottom: 8px;
            }
            
            .message-bubble {
                margin-bottom: 4px;
            }
            
            /* Ensure last message has proper spacing */
            .message-row:last-child {
                margin-bottom: 20px;
            }
            
            /* Message display container spacing */
            .message-display-container {
                padding-bottom: 20px;
            }
            
            /* Mobile emoji and sticker panels */
            #emoji-panel, #sticker-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 40vh;
                z-index: 50;
                border-radius: 12px 12px 0 0;
            }
            
            /* Mobile message bubbles */
            .sender-bubble, .receiver-bubble {
                max-width: 85%;
                margin: 4px 0;
                margin-left: 8px;
                margin-right: 8px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                box-sizing: border-box;
                /* Better mobile touch interaction */
                -webkit-tap-highlight-color: transparent;
                /* Prevent text selection on long press */
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                /* Better touch handling */
                touch-action: manipulation;
            }
            
            /* Fix message container alignment */
            .message-container {
                width: 100%;
                padding: 0 4px;
                box-sizing: border-box;
            }
            
            /* Ensure proper flex alignment for messages */
            .flex.justify-start {
                padding-left: 0;
                margin-left: 0;
            }
            
            .flex.justify-end {
                padding-right: 0;
                margin-right: 0;
            }
            
            /* Mobile touch improvements */
            button, input, textarea {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Mobile safe area improvements */
            .app-main-container {
                padding-bottom: max(env(safe-area-inset-bottom, 0px), 8px);
            }
            
            /* Fix message alignment and prevent overflow */
            .message-display-container {
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                min-height: 100%;
            }
            
            /* Improve message bubble positioning */
            .message-bubble {
                max-width: calc(100% - 16px);
                margin-left: 8px;
                margin-right: 8px;
            }
            
            /* Fix flex containers for messages */
            .message-row {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                padding: 0 4px;
            }
            
            /* Ensure proper text wrapping */
            .message-content {
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }
            
            /* Mobile-specific input improvements */
            #message-input {
                font-size: 16px; /* Prevents zoom on iOS */
                -webkit-appearance: none;
                appearance: none;
                border-radius: 21px;
            }
            
            /* Fix mobile header positioning */
            .chat-header {
                position: sticky;
                top: 0;
                z-index: 20;
                background: var(--whatsapp-green);
            }
            
            /* Additional mobile fixes */
            .app-main-container {
                position: relative;
                overflow: hidden;
            }
            
            /* Ensure proper scrolling on mobile */
            #message-display {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            /* Fix any potential horizontal scroll issues */
            .right-panel {
                overflow-x: hidden;
            }
            
            /* Improve touch targets for mobile */
            button, .cursor-pointer {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Keyboard handling improvements */
            @supports (-webkit-touch-callout: none) {
                /* iOS specific fixes */
                #message-display {
                    height: calc(100vh - 110px);
                    height: calc(100dvh - 110px);
                }
                
                #chat-input-area {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    z-index: 1000;
                    padding: 8px 12px;
                    box-sizing: border-box;
                }
            }
            
            /* Ensure send button is fully visible */
            .send-btn {
                background-color: #25D366 !important;
                color: white !important;
                border-radius: 50% !important;
                min-width: 24px !important;
                min-height: 24px !important;
                width: 24px !important;
                height: 24px !important;
                flex-shrink: 0 !important;
            }
            
            /* Prevent input area from being cut off */
            #chat-input-area {
                max-width: 100vw;
                overflow: hidden;
            }
            
            /* Ensure microphone button is always visible */
            .mic-btn {
                position: relative;
                z-index: 10;
                flex-shrink: 0;
            }
            
            /* Better keyboard behavior */
            .right-panel {
                display: flex;
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
            }
            
            /* Fix for when keyboard appears */
            @media (max-height: 600px) {
                #message-display {
                    height: calc(100vh - 100px);
                    height: calc(100dvh - 100px);
                }
            }
        }
        
        /* Message status animations */
        .status-icon {
            transition: all 0.3s ease;
        }
        
        .status-icon.animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Message bubble animations */
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Status transition animations */
        .status-transition {
            transition: color 0.3s ease, transform 0.2s ease;
        }
        
        .status-transition:hover {
            transform: scale(1.1);
        }
        /* Welcome Animation Styles */
        #welcome-screen {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 50%, #075E54 100%);
            animation: welcomeFadeIn 0.5s ease-in-out;
        }
        
        @keyframes welcomeFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes welcomeFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        #whatsapp-logo {
            animation: logoFloat 2s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-animate-in {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        
        .welcome-animate-out {
            animation: welcomeFadeOut 0.5s ease-in-out forwards;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Image Modal Styles - WhatsApp-like */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            touch-action: none;
        }
        
        .image-modal-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            padding: 20px 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .image-modal-back {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 20px;
            backdrop-filter: blur(10px);
        }
        
        .image-modal-actions {
            display: flex;
            gap: 8px;
        }
        
        .image-modal-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
            backdrop-filter: blur(10px);
            transition: background-color 0.2s;
        }
        
        .image-modal-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .image-modal-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .image-modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .image-modal-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 16px 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .image-modal-zoom-controls {
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .zoom-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            color: white;
            transition: background-color 0.2s;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .image-modal-header {
                padding: 12px 16px 8px;
            }
            
            .image-modal-back,
            .image-modal-action-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .image-modal-footer {
                padding: 12px 16px 16px;
            }
            
            .zoom-btn {
                min-width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }

        /* WhatsApp-style Message Input */
        .message-input-container {
            background: #f0f0f0;
            border-radius: 25px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 50px;
            position: relative;
        }

        .attachment-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px;
            margin-bottom: 8px;
            min-width: 200px;
            z-index: 50;
        }

        .attachment-menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            gap: 12px;
        }

        .attachment-menu-item:hover {
            background-color: #f5f5f5;
        }

        .attachment-menu-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attachment-menu-text {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .emoji-btn, .attachment-btn, .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }

        .emoji-btn:hover, .attachment-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .send-btn {
            background-color: #25D366;
            color: white;
        }

        .send-btn:hover {
            background-color: #128C7E;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            padding: 8px 12px;
            color: #333;
        }

        .message-input::placeholder {
            color: #999;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .message-input-container {
                padding: 6px 10px;
                min-height: 44px;
            }

            .emoji-btn, .attachment-btn, .send-btn {
                width: 36px;
                height: 36px;
            }

            .message-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 6px 10px;
            }

            .attachment-menu {
                min-width: 180px;
                left: -10px;
            }

            .attachment-menu-item {
                padding: 10px 14px;
            }

            .attachment-menu-text {
                font-size: 15px;
            }

        }
    </style>
    <!-- Firebase Compat (non-ESM) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Enable verbose Firestore logs
        if (firebase && firebase.firestore && firebase.firestore.setLogLevel) {
            firebase.firestore.setLogLevel('debug');
        }

        // === Modular API compatibility wrappers (map to compat SDK) ===
        const initializeApp = (config) => firebase.initializeApp(config);
        const getFirestore = (app) => firebase.firestore();
        const getAuth = (app) => firebase.auth();
        const signInWithEmailAndPassword = (auth, email, password) => firebase.auth().signInWithEmailAndPassword(email, password);
        const createUserWithEmailAndPassword = (auth, email, password) => firebase.auth().createUserWithEmailAndPassword(email, password);
        const onAuthStateChanged = (auth, cb) => firebase.auth().onAuthStateChanged(cb);
        const signOut = (auth) => firebase.auth().signOut();
        const signInWithCustomToken = (auth, token) => firebase.auth().signInWithCustomToken(token);

        const serverTimestamp = () => firebase.firestore.FieldValue.serverTimestamp();
        const arrayUnion = (...args) => firebase.firestore.FieldValue.arrayUnion(...args);
        const arrayRemove = (...args) => firebase.firestore.FieldValue.arrayRemove(...args);
        const FieldPath = firebase.firestore.FieldPath;

        const collection = (db, ...segments) => db.collection(segments.join('/'));
        const doc = (db, ...segments) => db.doc(segments.join('/'));
        const setDoc = (ref, data) => ref.set(data);
        const addDoc = (colRef, data) => colRef.add(data);
        const updateDoc = (ref, data) => ref.update(data);
        const deleteDoc = (ref) => ref.delete();
        const getDoc = (ref) => ref.get();
        const getDocs = (q) => q.get();
        const where = (field, op, value) => ({ __type: 'where', field, op, value });
        const query = (ref, ...clauses) => {
            let q = ref;
            clauses.forEach(c => { if (c && c.__type === 'where') { q = q.where(c.field, c.op, c.value); } });
            return q;
        };
        const onSnapshot = (q, next, error) => q.onSnapshot(next, error);

        // === FIREBASE CONFIGURATION ===
        const userProvidedConfig = {
            apiKey: "AIzaSyBvK-1Stea6-28HAopJqII4k4f78iLPq9E",
            authDomain: "chatapptry-1164e.firebaseapp.com",
            projectId: "chatapptry-1164e",
            storageBucket: "chatapptry-1164e.firebasestorage.app",
            messagingSenderId: "506480059651",
            appId: "1:506480059651:web:1c3bf7e8d2e64fa456f536",
            measurementId: "G-K5G581E348"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-whatsapp-clone';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;
        let currentUserName = "User"; // Default name
        let currentUserPhotoUrl = null;
        let currentChatId = null; // ID of the currently active chat (1:1 or Group ID)
        let selectedChat = null; // Object {id, name, type, uid? } of the current conversation
        let currentContacts = []; // Array of user's contacts (for 1:1)
        let currentGroups = []; // Array of groups the user belongs to
        let currentView = 'contacts'; // FIX: Initialize currentView to prevent ReferenceError
        let chatSearchTerm = '';
        const userProfileCache = {}; // uid -> { name, photoURL }
        // Enforce Firebase-only (no local demo mode)
        const isDemoMode = false;

        let unsubscribeMessages = null; // To manage real-time message listener
        let unsubscribeContacts = null; // To manage real-time contacts listener
        let unsubscribeGroups = null; // To manage real-time groups listener

        window.mediaRecorder = null; 
        let audioChunks = [];
        
        // Reaction system variables
        let lastTapTime = 0;
        let lastTapMessageId = null;

        // === CLOUDINARY CONFIGURATION START ===
        // !!! IMPORTANT: REPLACE THESE WITH YOUR CLOUDINARY CREDENTIALS !!!
        const CLOUDINARY_CLOUD_NAME = 'dbx4azfjo'; 
        const CLOUDINARY_UPLOAD_PRESET = 'cheque_uploads'; 
        // === CLOUDINARY CONFIGURATION END ===
        
        // ===================================
        // UTILITIES & NAVIGATION
        // ===================================

        let currentTab = 'chats'; // Track current active tab

        function showChatScreen() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('chat-app-container').classList.remove('hidden');
            document.body.classList.remove('bg-gray-100', 'p-0', 'sm:p-4');
            updateUserAvatar(); // Update user avatar in header
            renderApp(); // Render the initial view
        }

        // WhatsApp-style tab switching
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('text-green-600', 'border-green-500');
                tab.classList.add('text-gray-600', 'border-transparent');
            });
            
            const activeTab = document.getElementById(tabName + '-tab');
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'border-transparent');
                activeTab.classList.add('text-green-600', 'border-green-500');
            }
            
            // Show/hide content sections
            document.querySelectorAll('[id$="-content"]').forEach(content => {
                content.classList.add('hidden');
            });
            
            const activeContent = document.getElementById(tabName + '-content');
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            
            // Load content based on tab
            switch(tabName) {
                case 'chats':
                    renderChatList();
                    break;
                case 'contacts':
                    renderContactsList();
                    break;
                case 'groups':
                    renderGroupsList();
                    break;
            }
        }

        function showAuthScreen() {
            document.getElementById('chat-app-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            document.body.classList.add('bg-gray-100', 'p-0', 'sm:p-4'); 
        }

        /**
         * Switches the application view and potentially sets a new chat.
         * @param {string} view - 'contacts', 'chat', 'profile'
         * @param {Object} chatObject - { id, name, type, uid? }
         */
        window.navigateTo = function(view, chatObject = null) {
            currentView = view;
            
            if (view === 'chat' && chatObject) {
                selectedChat = chatObject;
                
                if (selectedChat.type === 'contact') {
                    currentChatId = getPrivateChatId(currentUserId, selectedChat.uid);
                    // Load avatar and name for contact in header
                    loadUserPublicProfile(selectedChat.uid).then((p) => {
                        const avatar = document.getElementById('chat-avatar');
                        const nameElement = document.getElementById('chat-partner-name');
                        
                        // Update name with actual profile name
                        if (p && p.name) {
                            nameElement.textContent = p.name;
                        } else {
                            nameElement.textContent = selectedChat.name;
                        }
                        
                        // Update avatar
                        if (avatar && p && p.photoURL) {
                            avatar.innerHTML = `<img src="${p.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'">`;
                        } else if (avatar) {
                            avatar.innerHTML = defaultHeaderAvatarIcon();
                        }
                    });
                } else if (selectedChat.type === 'group') {
                    currentChatId = selectedChat.id;
                    document.getElementById('chat-partner-name').textContent = selectedChat.name + ' (Group)';
                    const avatar = document.getElementById('chat-avatar');
                    if (avatar) {
                        if (selectedChat.photoURL) {
                            avatar.innerHTML = `<img src="${selectedChat.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'">`;
                        } else {
                            avatar.innerHTML = defaultHeaderAvatarIcon();
                        }
                    }
                } else {
                    currentChatId = null;
                }
                
                // Clear and restart the message listener
                startChatListener(currentChatId);
                
                // Hide the left panel on mobile when navigating to chat
                const leftPanel = document.getElementById('left-panel');
                if (window.innerWidth <= 768) {
                    leftPanel.classList.add('hidden');
                    
                    console.log('🚀 Navigate to chat on mobile - Smart scroll behavior (WhatsApp-like)...');
                    
                    // Start smart scroll monitor for mobile
                    startMobileScrollMonitor();
                    
                    // Start at bottom when navigating to chat
                    const display = document.getElementById('message-display');
                    if (display) {
                        console.log('📱 Navigating to chat - Starting at bottom');
                        display.scrollTop = display.scrollHeight;
                        
                        // Gentle scrolls to ensure we're at bottom
                        setTimeout(() => {
                            display.scrollTop = display.scrollHeight;
                        }, 50);
                        setTimeout(() => {
                            display.scrollTop = display.scrollHeight;
                        }, 100);
                    }
                }
            } else if (view === 'contacts') {
                // Show the left panel on mobile when navigating back to contacts
                if (window.innerWidth <= 768) {
                    const leftPanel = document.getElementById('left-panel');
                    leftPanel.classList.remove('hidden');
                    
                    // Stop mobile scroll monitor when leaving chat
                    stopMobileScrollMonitor();
                }
            }
            
            renderApp();
        }

        // Function to select a chat by ID (used by contacts and groups lists)
        window.selectChat = function(chatId) {
            // First, try to find the chat in contacts
            let chat = currentContacts.find(contact => contact.id === chatId);
            if (chat) {
                // It's a contact, create the proper chat object
                const profile = userProfileCache[chat.uid] ? userProfileCache[chat.uid] : null;
                let displayName = chat.name;
                if (profile && profile.name) {
                    displayName = profile.name;
                }
                
                const chatObject = {
                    id: chat.id,
                    name: displayName,
                    uid: chat.uid,
                    type: 'contact'
                };
                navigateTo('chat', chatObject);
                return;
            }
            
            // If not found in contacts, try to find in groups
            chat = currentGroups.find(group => group.id === chatId);
            if (chat) {
                // It's a group, create the proper chat object
                const chatObject = {
                    id: chat.id,
                    name: chat.name,
                    type: 'group',
                    photoURL: chat.photoURL,
                    members: chat.members
                };
                navigateTo('chat', chatObject);
                return;
            }
            
            console.error('Chat not found with ID:', chatId);
        }

        function defaultHeaderAvatarIcon() {
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
        }
        
        /**
         * Main render function to decide which view components to show/hide.
         */
        function renderApp() {
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const chatView = document.getElementById('chat-view');
            const profileView = document.getElementById('profile-settings-view');
            
            // Handle Responsive Display
            if (window.innerWidth <= 768) {
                // Mobile: Only show one full-screen panel
                leftPanel.classList.toggle('hidden', currentView !== 'contacts');
                chatView.classList.toggle('hidden', currentView !== 'chat');
                profileView.classList.toggle('hidden', currentView !== 'profile');
                rightPanel.classList.toggle('hidden', currentView === 'contacts');
                
            } else {
                // Desktop: Always show left panel, switch content in right panel
                leftPanel.classList.remove('hidden');
                chatView.classList.toggle('hidden', currentView !== 'chat');
                profileView.classList.toggle('hidden', currentView !== 'profile');
                rightPanel.classList.toggle('hidden', false);
            }
            
            if (currentView === 'profile') {
                renderProfileSettings();
            }

            // Update header button text
            document.getElementById('current-user-name-display').textContent = currentUserName;
            
            // Initialize tabs if we're on contacts view
            if (currentView === 'contacts' && currentUserId) {
                switchTab('chats');
            }
        }

        // ===================================
        // FIREBASE AUTHENTICATION & PROFILES
        // ===================================

        async function initFirebase() {
            // Environment checks to improve mobile reliability (Android browsers/WebView)
            if (!navigator.onLine) {
                displayError('You appear to be offline. Check your internet connection.');
            }
            if (!firebaseConfig) {
                displayError('Firebase configuration is missing. Cannot initialize the application.');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Expose auth so environment checks and listeners that rely on it work consistently across devices
                window.auth = auth;

                // Set auth persistence: use in-memory on file:// to avoid IndexedDB restrictions on mobile
                try {
                    const desired = (location.protocol === 'file:') 
                        ? firebase.auth.Auth.Persistence.NONE 
                        : firebase.auth.Auth.Persistence.LOCAL;
                    await firebase.auth().setPersistence(desired);
                } catch (e) {
                    console.warn('Failed to set auth persistence:', e);
                }

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await setupUserProfile(user);
                        
                        // Store login state for persistent login
                        storeLoginState(user.uid, currentUserName);
                        
                        startContactsListener(); // Start listening to real contacts
                        startGroupsListener(); // Start listening to groups
                        
                        // Check if we're showing welcome screen
                        const welcomeScreen = document.getElementById('welcome-screen');
                        if (welcomeScreen && !welcomeScreen.classList.contains('hidden')) {
                            // Hide welcome screen after a delay and show chat
                            setTimeout(() => {
                                hideWelcomeScreen();
                                setTimeout(() => {
                                    showChatScreen();
                                    renderApp();
                                }, 500);
                            }, 2000); // Show welcome animation for 2 seconds
                        } else {
                            // Direct login (not from welcome screen)
                            showChatScreen();
                            renderApp();
                        }
                    } else {
                        currentUserId = null;
                        currentChatId = null;
                        selectedChat = null;
                        if (unsubscribeMessages) unsubscribeMessages();
                        if (unsubscribeContacts) unsubscribeContacts();
                        if (unsubscribeGroups) unsubscribeGroups();
                        
                        // Clear login state on sign out
                        clearLoginState();
                        
                        // Hide welcome screen if it's showing
                        hideWelcomeScreen();
                        showAuthScreen();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                displayError(`Failed to initialize Firebase: ${error.message}`);
            }
        }
        
        /**
         * Ensures a user profile exists upon authentication and populates the public directory.
         */
        async function setupUserProfile(user) {
            const userProfileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, user.uid);
            
            let profile;
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists) {
                    profile = docSnap.data();
                    currentUserName = profile.name || `User-${user.uid.substring(0, 6)}`;
                    currentUserPhotoUrl = profile.photoURL || null;
                } else {
                    // Create initial profile if it doesn't exist
                    currentUserName = `User-${user.uid.substring(0, 6)}`;
                    profile = { 
                        uid: user.uid,
                        name: currentUserName, 
                        email: user.email || null,
                        createdAt: serverTimestamp(),
                        photoURL: null
                    };
                    await setDoc(userProfileRef, profile);
                }
                
                // Update or create the public directory entry
                await setDoc(userDirectoryRef, {
                    uid: user.uid,
                    name: currentUserName,
                    photoURL: currentUserPhotoUrl || null,
                });
                
                document.getElementById('user-id-display').textContent = currentUserId.substring(0, 8);
                document.getElementById('profile-uid-display').textContent = currentUserId; // Show full UID in profile
            } catch (error) {
                console.error("Error setting up user profile or directory:", error);
                displayError(`Profile setup failed: ${error.message}`);
            }
        }

        /**
         * Handles user sign-in.
         */
        window.handleSignIn = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) { displayError("Email and password are required."); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error-message').textContent = '';
                
                // Store login state immediately after successful sign in
                const user = auth.currentUser;
                if (user) {
                    storeLoginState(user.uid, user.email || 'User');
                }
                
                // Fallback: if onAuthStateChanged is delayed on some mobile contexts, push UI forward
                setTimeout(() => {
                    if (firebase.auth().currentUser) {
                        showChatScreen();
                        renderApp();
                    }
                }, 300);
            } catch (error) {
                const msg =
                    error.message.includes('auth/unauthorized-domain') ?
                        'Unauthorized domain. Add this domain in Firebase Console > Authentication > Settings > Authorized domains.' :
                    error.message.includes('auth/invalid-credential') ?
                        'Invalid Email or Password.' :
                    error.message;
                document.getElementById('auth-error-message').textContent = `Sign In Failed: ${msg}`;
                if (error.message.includes('auth/unauthorized-domain') || location.protocol === 'file:') {
                    displayError('Login blocked by environment. Host the file via HTTP/HTTPS (not file://) and add the domain to Firebase Authorized domains.');
                }
            }
        }

        /**
         * Handles user sign-up.
         */
        window.handleSignUp = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) { displayError("Email and password are required."); return; }
            if (password.length < 6) { document.getElementById('auth-error-message').textContent = "Password must be at least 6 characters."; return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error-message').textContent = '';
                
                // Store login state immediately after successful sign up
                const user = auth.currentUser;
                if (user) {
                    storeLoginState(user.uid, user.email || 'User');
                }
                
                setTimeout(() => {
                    if (firebase.auth().currentUser) {
                        showChatScreen();
                        renderApp();
                    }
                }, 300);
            } catch (error) {
                const msg = error.message.includes('auth/unauthorized-domain') ?
                    'Unauthorized domain. Add this domain in Firebase Console > Authentication > Settings > Authorized domains.' : error.message;
                document.getElementById('auth-error-message').textContent = `Sign Up Failed: ${msg}`;
                if (error.message.includes('auth/unauthorized-domain') || location.protocol === 'file:') {
                    displayError('Sign up blocked by environment. Host the file via HTTP/HTTPS (not file://) and add the domain to Firebase Authorized domains.');
                }
            }
        }

        /**
         * Handles user sign-out.
         */
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                displayError("Signed out successfully.");
            } catch (error) {
                displayError(`Sign out failed: ${error.message}`);
            }
        }

        // ===================================
        // PROFILE SETTINGS LOGIC
        // ===================================

        function renderProfileSettings() {
            document.getElementById('current-profile-name').value = currentUserName;
            document.getElementById('profile-uid-display').textContent = currentUserId;
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                if (currentUserPhotoUrl) {
                    profileAvatar.innerHTML = `<img src="${currentUserPhotoUrl}" class="w-24 h-24 rounded-full object-cover" onerror="this.style.display='none'">`;
                }
            }
        }

        window.handleUpdateProfile = async function() {
            const newName = document.getElementById('current-profile-name').value.trim();
            const photoInput = document.getElementById('profile-picture-input');
            if (!newName) {
                displayError("Profile name cannot be empty.");
                return;
            }

            const userProfileRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, currentUserId);

            try {
                // 1. Update private profile
                const updates = { name: newName };
                if (currentUserPhotoUrl) updates.photoURL = currentUserPhotoUrl;
                await updateDoc(userProfileRef, updates);
                // 2. Update public directory
                const dirUpdates = { name: newName };
                if (currentUserPhotoUrl) dirUpdates.photoURL = currentUserPhotoUrl;
                await updateDoc(userDirectoryRef, dirUpdates);
                
                currentUserName = newName;
                document.getElementById('profile-status-message').textContent = "Profile updated successfully!";
                setTimeout(() => { document.getElementById('profile-status-message').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error updating profile:", error);
                document.getElementById('profile-status-message').textContent = "Failed to update profile.";
            }
        }

        window.handleUploadProfilePicture = async function() {
            const fileInput = document.getElementById('profile-picture-input');
            const file = fileInput.files && fileInput.files[0];
            if (!file) { displayError('Please choose a profile picture.'); return; }
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Uploading profile picture...';
            const url = await uploadToCloudinary(file, 'image');
            document.getElementById('loading-indicator').classList.add('hidden');
            if (!url) return;
            currentUserPhotoUrl = url;
            const userProfileRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, currentUserId);
            try {
                await updateDoc(userProfileRef, { photoURL: url });
                await updateDoc(userDirectoryRef, { photoURL: url });
                const profileAvatar = document.getElementById('profile-avatar');
                if (profileAvatar) {
                    profileAvatar.innerHTML = `<img src="${url}" class="w-24 h-24 rounded-full object-cover">`;
                }
                document.getElementById('profile-status-message').textContent = 'Photo updated!';
                setTimeout(() => { document.getElementById('profile-status-message').textContent = ''; }, 2000);
            } catch (e) {
                displayError('Failed to save profile picture: ' + e.message);
            }
        }

        // ===================================
        // CONTACTS & GROUP LIST LOGIC
        // ===================================

        function startContactsListener() {
            if (unsubscribeContacts) unsubscribeContacts();
            if (!currentUserId) return;

            // Path: /artifacts/{appId}/users/{userId}/contacts
            const contactsRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/contacts`);
            const q = query(contactsRef);

            unsubscribeContacts = onSnapshot(q, async (snapshot) => {
                currentContacts = [];
                const uidsToFetch = [];
                snapshot.forEach(doc => {
                    // Convert contact to a universal chat object type
                    currentContacts.push({ 
                        id: doc.id, 
                        name: doc.data().name, 
                        uid: doc.data().uid,
                        type: 'contact',
                        ...doc.data() 
                    });
                    if (!userProfileCache[doc.data().uid]) uidsToFetch.push(doc.data().uid);
                });
                // Load public profiles for contacts so avatars show to everyone
                await Promise.all(uidsToFetch.map(uid => loadUserPublicProfile(uid)));
                renderChatList();
            }, (error) => {
                console.error("Error listening to contacts:", error);
            });
        }
        
        function startGroupsListener() {
            if (unsubscribeGroups) unsubscribeGroups();
            if (!currentUserId) return;

            // Path: /artifacts/{appId}/public/data/group_directory
            const groupsRef = collection(db, `/artifacts/${appId}/public/data/group_directory`);
            // Query for groups where the current user is a member (requires 'members' field to be an array)
            const q = query(groupsRef, where('members', 'array-contains', currentUserId));

            unsubscribeGroups = onSnapshot(q, (snapshot) => {
                currentGroups = [];
                snapshot.forEach(doc => {
                    // Convert group to a universal chat object type
                    currentGroups.push({ 
                        id: doc.id, 
                        name: doc.data().name, 
                        type: 'group',
                        ...doc.data() 
                    });
                });
                renderChatList();
            }, (error) => {
                console.error("Error listening to groups:", error);
                displayError("Group list error: Check Firebase security rules for 'group_directory'.");
            });
        }

        function renderChatList() {
            const chatsListDiv = document.getElementById('chats-list');
            chatsListDiv.innerHTML = '';
            
            const term = (chatSearchTerm || '').toLowerCase().trim();
            const allChats = [...currentGroups, ...currentContacts].filter(c => {
                if (!term) return true;
                const name = (c.name || '').toLowerCase();
                const uid = (c.uid || '').toLowerCase();
                const type = (c.type || '').toLowerCase();
                
                // Search in name, UID, and type
                return name.includes(term) || 
                       (uid && uid.includes(term)) || 
                       type.includes(term) ||
                       (c.type === 'group' && 'group'.includes(term)) ||
                       (c.type === 'contact' && 'contact'.includes(term));
            });
            
            if (allChats.length === 0) {
                if (term) {
                    chatsListDiv.innerHTML = `<p class="p-4 text-center text-gray-500">No chats or groups found for "${chatSearchTerm}"</p>`;
                } else {
                    chatsListDiv.innerHTML = '<p class="p-4 text-center text-gray-500">No chats or groups. Add a contact or create a group!</p>';
                }
                return;
            }

            // Sort by a combination of creation/added time (or just alphabetically for simplicity)
            allChats.sort((a, b) => a.name.localeCompare(b.name));

            const chatItem = (chat) => {
                const isGroup = chat.type === 'group';
                const profile = !isGroup && userProfileCache[chat.uid] ? userProfileCache[chat.uid] : null;
                
                // Use actual profile name if available, otherwise fall back to stored name
                let displayName = chat.name;
                if (!isGroup && profile && profile.name) {
                    displayName = profile.name;
                }
                
                const nameDisplay = displayName + (isGroup ? ' (Group)' : (chat.uid === currentUserId ? ' (Self)' : ''));
                const subText = isGroup ? `${chat.members.length} members` : `UID: ${chat.uid.substring(0, 8)}...`;
                const icon = isGroup ? '👥' : displayName.charAt(0).toUpperCase();

                return `
                    <div onclick="navigateTo('chat', {id: '${chat.id}', name: '${displayName}', uid: '${chat.uid || ''}', type: '${chat.type}'})"
                        class="flex items-center p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-150">
                        <div class="w-12 h-12 rounded-full ${isGroup ? 'bg-blue-400' : 'bg-gray-300'} flex items-center justify-center text-white font-bold text-lg mr-3 flex-shrink-0 overflow-hidden">
                            ${isGroup ? (chat.photoURL ? `<img src='${chat.photoURL}' class='w-full h-full object-cover' onerror=\"this.style.display='none'\">` : icon) : (profile && profile.photoURL ? `<img src='${profile.photoURL}' class='w-full h-full object-cover' onerror=\"this.style.display='none'\">` : icon)}
                        </div>
                        <div class="truncate">
                            <p class="font-semibold text-gray-800 truncate">${nameDisplay}</p>
                            <p class="text-xs text-gray-500">${subText}</p>
                        </div>
                    </div>
                `;
            };

            chatsListDiv.innerHTML = allChats.map(chatItem).join('');
            
            // Update search results count
            const searchCount = document.getElementById('search-results-count');
            if (searchCount) {
                searchCount.textContent = allChats.length;
            }
        }

        // Search handler for chat list
        window.handleChatSearch = function(value) {
            chatSearchTerm = value || '';
            console.log('Search term:', chatSearchTerm, 'Current tab:', currentTab);
            
            // Show/hide search results info
            const searchInfo = document.getElementById('search-results-info');
            if (searchInfo) {
                if (chatSearchTerm.trim()) {
                    searchInfo.classList.remove('hidden');
                } else {
                    searchInfo.classList.add('hidden');
                }
            }
            
            // Update all tabs based on current active tab
            if (currentTab === 'chats') {
                renderChatList();
            } else if (currentTab === 'contacts') {
                renderContactsList();
            } else if (currentTab === 'groups') {
                renderGroupsList();
            }
        }

        // Clear main search function
        window.clearMainSearch = function() {
            const searchInput = document.getElementById('chat-search-input');
            searchInput.value = '';
            chatSearchTerm = '';
            
            // Hide search results info
            const searchInfo = document.getElementById('search-results-info');
            if (searchInfo) {
                searchInfo.classList.add('hidden');
            }
            
            // Update all tabs based on current active tab
            if (currentTab === 'chats') {
                renderChatList();
            } else if (currentTab === 'contacts') {
                renderContactsList();
            } else if (currentTab === 'groups') {
                renderGroupsList();
            }
        }

        // Render contacts list for contacts tab
        function renderContactsList() {
            const contactsListDiv = document.getElementById('contacts-list');
            if (!contactsListDiv) return;
            
            contactsListDiv.innerHTML = '';
            
            const term = (chatSearchTerm || '').toLowerCase().trim();
            const filteredContacts = currentContacts.filter(c => {
                if (!term) return true;
                const name = (c.name || '').toLowerCase();
                const uid = (c.uid || '').toLowerCase();
                return name.includes(term) || (uid && uid.includes(term));
            });
            
            if (filteredContacts.length === 0) {
                if (term) {
                    contactsListDiv.innerHTML = `<div class="p-3 text-center text-gray-500">No contacts found for "${chatSearchTerm}"</div>`;
                } else {
                    contactsListDiv.innerHTML = '<div class="p-3 text-center text-gray-500">No contacts found</div>';
                }
                return;
            }
            
            // Sort contacts alphabetically
            filteredContacts.sort((a, b) => a.name.localeCompare(b.name));
            
            const contactItem = (contact) => {
                const profile = userProfileCache[contact.uid] ? userProfileCache[contact.uid] : null;
                let displayName = contact.name;
                if (profile && profile.name) {
                    displayName = profile.name;
                }
                
                return `
                    <div onclick="selectChat('${contact.id}')" class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                        <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg mr-3 overflow-hidden">
                            ${profile && profile.photoURL ? 
                                `<img src="${profile.photoURL}" class="w-12 h-12 rounded-full object-cover" onerror="this.style.display='none'">` :
                                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`
                            }
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-gray-900">${displayName}</h3>
                            <p class="text-sm text-gray-500">${contact.uid}</p>
                        </div>
                    </div>
                `;
            };
            
            contactsListDiv.innerHTML = filteredContacts.map(contactItem).join('');
            
            // Update search results count
            const searchCount = document.getElementById('search-results-count');
            if (searchCount) {
                searchCount.textContent = filteredContacts.length;
            }
        }

        // Render groups list for groups tab
        function renderGroupsList() {
            const groupsListDiv = document.getElementById('groups-list');
            if (!groupsListDiv) return;
            
            groupsListDiv.innerHTML = '';
            
            const term = (chatSearchTerm || '').toLowerCase().trim();
            const filteredGroups = currentGroups.filter(g => {
                if (!term) return true;
                const name = (g.name || '').toLowerCase();
                const memberCount = (g.members || []).length;
                return name.includes(term) || 
                       `group`.includes(term) ||
                       `${memberCount} members`.includes(term);
            });
            
            if (filteredGroups.length === 0) {
                if (term) {
                    groupsListDiv.innerHTML = `<div class="p-3 text-center text-gray-500">No groups found for "${chatSearchTerm}"</div>`;
                } else {
                    groupsListDiv.innerHTML = '<div class="p-3 text-center text-gray-500">No groups found</div>';
                }
                return;
            }
            
            // Sort groups alphabetically
            filteredGroups.sort((a, b) => a.name.localeCompare(b.name));
            
            const groupItem = (group) => {
                return `
                    <div onclick="selectChat('${group.id}')" class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                        <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg mr-3 overflow-hidden">
                            ${group.photoURL ? 
                                `<img src="${group.photoURL}" class="w-12 h-12 rounded-full object-cover" onerror="this.style.display='none'">` :
                                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`
                            }
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-gray-900">${group.name}</h3>
                            <p class="text-sm text-gray-500">${group.members ? group.members.length : 0} members</p>
                        </div>
                    </div>
                `;
            };
            
            groupsListDiv.innerHTML = filteredGroups.map(groupItem).join('');
            
            // Update search results count
            const searchCount = document.getElementById('search-results-count');
            if (searchCount) {
                searchCount.textContent = filteredGroups.length;
            }
        }

        async function loadUserPublicProfile(uid) {
            try {
                if (userProfileCache[uid]) return userProfileCache[uid];
                const ref = doc(db, `/artifacts/${appId}/public/data/user_directory`, uid);
                const snap = await getDoc(ref);
                if (snap.exists) {
                    const data = snap.data();
                    userProfileCache[uid] = { name: data.name, photoURL: data.photoURL || null };
                    return userProfileCache[uid];
                } else {
                    userProfileCache[uid] = { name: '', photoURL: null };
                    return userProfileCache[uid];
                }
            } catch (e) {
                console.warn('Failed to load public profile for', uid, e);
                return null;
            }
        }
        
        // ===================================
        // ADD CONTACT MODAL LOGIC (Unchanged)
        // ===================================

        window.showAddContactModal = function() {
            document.getElementById('add-contact-modal').classList.remove('hidden');
        }

        window.hideAddContactModal = function() {
            document.getElementById('add-contact-modal').classList.add('hidden');
            document.getElementById('add-contact-status').textContent = '';
            document.getElementById('contact-search-input').value = '';
        }

        // Status Functions
        let currentStatusType = 'text';
        let selectedStatusPhoto = null;

        window.addMyStatus = function() {
            document.getElementById('status-modal').classList.remove('hidden');
            selectStatusType('text');
        }

        window.hideStatusModal = function() {
            document.getElementById('status-modal').classList.add('hidden');
            document.getElementById('status-error-message').textContent = '';
            document.getElementById('status-text-input').value = '';
            document.getElementById('status-photo-preview').classList.add('hidden');
            selectedStatusPhoto = null;
        }

        window.selectStatusType = function(type) {
            currentStatusType = type;
            
            // Update button styles
            document.getElementById('text-status-btn').classList.remove('bg-green-500', 'text-white');
            document.getElementById('photo-status-btn').classList.remove('bg-green-500', 'text-white');
            document.getElementById('text-status-btn').classList.add('border-gray-300');
            document.getElementById('photo-status-btn').classList.add('border-gray-300');
            
            if (type === 'text') {
                document.getElementById('text-status-btn').classList.add('bg-green-500', 'text-white');
                document.getElementById('text-status-btn').classList.remove('border-gray-300');
                document.getElementById('text-status-input').classList.remove('hidden');
                document.getElementById('photo-status-input').classList.add('hidden');
            } else {
                document.getElementById('photo-status-btn').classList.add('bg-green-500', 'text-white');
                document.getElementById('photo-status-btn').classList.remove('border-gray-300');
                document.getElementById('text-status-input').classList.add('hidden');
                document.getElementById('photo-status-input').classList.remove('hidden');
            }
        }

        window.handleStatusPhotoSelect = function() {
            const file = document.getElementById('status-photo-input').files[0];
            if (file) {
                selectedStatusPhoto = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('status-preview-img').src = e.target.result;
                    document.getElementById('status-photo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        window.handlePostStatus = async function() {
            const errorMessage = document.getElementById('status-error-message');
            errorMessage.textContent = '';

            if (currentStatusType === 'text') {
                const text = document.getElementById('status-text-input').value.trim();
                if (!text) {
                    errorMessage.textContent = 'Please enter some text for your status.';
                    return;
                }
                
                // Post text status
                await postStatusUpdate('text', { text: text });
            } else {
                if (!selectedStatusPhoto) {
                    errorMessage.textContent = 'Please select a photo for your status.';
                    return;
                }
                
                // Post photo status
                await postStatusUpdate('photo', { photo: selectedStatusPhoto });
            }
            
            hideStatusModal();
        }

        async function postStatusUpdate(type, data) {
            try {
                const statusData = {
                    type: type,
                    userId: currentUserId,
                    timestamp: new Date(),
                    ...data
                };

                // In a real app, you would save this to Firebase
                // For now, we'll just add it to the UI
                addStatusToUI(statusData);
                
                console.log('Status posted:', statusData);
            } catch (error) {
                console.error('Error posting status:', error);
                document.getElementById('status-error-message').textContent = 'Failed to post status. Please try again.';
            }
        }

        function addStatusToUI(statusData) {
            const statusList = document.getElementById('status-updates-list');
            const statusItem = document.createElement('div');
            statusItem.className = 'flex items-center p-2 hover:bg-gray-50 rounded-lg transition duration-150';
            
            const timeAgo = getTimeAgo(statusData.timestamp);
            
            statusItem.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-sm mr-3 overflow-hidden">
                    <span>${currentUserId.charAt(0).toUpperCase()}</span>
                </div>
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800">My Status</h4>
                    <p class="text-sm text-gray-500">${timeAgo}</p>
                </div>
                <div class="text-xs text-gray-400">
                    ${statusData.type === 'text' ? '📝' : '📷'}
                </div>
            `;
            
            // Remove "No status updates yet" message if it exists
            const noStatusMessage = statusList.querySelector('.p-3.text-center.text-gray-500');
            if (noStatusMessage) {
                noStatusMessage.remove();
            }
            
            statusList.insertBefore(statusItem, statusList.firstChild);
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // Switch between tabs (Status, Chats, Contacts, Groups)
        window.switchTab = function(tab) {
            currentTab = tab;
            
            // Update tab button styles
            const tabs = ['status', 'chats', 'contacts', 'groups'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById(`${t}-tab`);
                const tabContent = document.getElementById(`${t}-content`);
                
                if (t === tab) {
                    tabBtn.classList.add('text-green-600', 'border-green-500');
                    tabBtn.classList.remove('text-gray-600', 'border-transparent');
                    tabContent.classList.remove('hidden');
                } else {
                    tabBtn.classList.remove('text-green-600', 'border-green-500');
                    tabBtn.classList.add('text-gray-600', 'border-transparent');
                    tabContent.classList.add('hidden');
                }
            });
            
            // Render the appropriate list
            if (tab === 'chats') {
                renderChatList();
            } else if (tab === 'contacts') {
                renderContactsList();
            } else if (tab === 'groups') {
                renderGroupsList();
            }
            
            // Clear search when switching tabs
            clearMainSearch();
        }

        window.handleAddContact = async function() {
            const targetUid = document.getElementById('contact-search-input').value.trim();
            const statusMessage = document.getElementById('add-contact-status');
            statusMessage.textContent = 'Searching...';

            if (!targetUid || targetUid.length < 8) {
                statusMessage.textContent = 'Please enter a valid User ID.';
                return;
            }
            if (targetUid === currentUserId) {
                statusMessage.textContent = 'You cannot add yourself.';
                return;
            }
            if (currentContacts.some(c => c.uid === targetUid)) {
                statusMessage.textContent = 'This user is already in your contacts.';
                return;
            }

            try {
                const targetRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, targetUid);
                const targetSnap = await getDoc(targetRef);

                if (targetSnap.exists) {
                    const targetUser = targetSnap.data();
                    
                    // Add the user to the current user's private contacts subcollection
                    const newContactRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/contacts`, targetUid);
                    await setDoc(newContactRef, {
                        uid: targetUser.uid,
                        name: targetUser.name,
                        addedAt: serverTimestamp()
                    });

                    statusMessage.textContent = `Success! Added ${targetUser.name} to your contacts.`;
                    document.getElementById('contact-search-input').value = '';
                    setTimeout(window.hideAddContactModal, 2000);

                } else {
                    statusMessage.textContent = 'User not found. Please check the UID.';
                }
            } catch (error) {
                console.error("Error adding contact:", error);
                statusMessage.textContent = 'An error occurred while adding the contact.';
            }
        }
        
        // ===================================
        // NEW GROUP MODAL LOGIC
        // ===================================
        
        window.showNewGroupModal = async function() {
            const listContainer = document.getElementById('group-contact-list');
            listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Loading contacts...</p>';
            
            if (currentContacts.length === 0) {
                listContainer.innerHTML = '<p class="text-red-500 text-center">Please add at least one contact first to create a group.</p>';
                document.getElementById('create-group-button').classList.add('hidden');
            } else {
                document.getElementById('create-group-button').classList.remove('hidden');
                
                // Load profile names for all contacts first
                await Promise.all(currentContacts.map(contact => loadUserPublicProfile(contact.uid)));
                
                // Clear loading message
                listContainer.innerHTML = '';
                
                // Add the current user first (they are always a member)
                const selfCheck = `
                    <div class="flex items-center p-2 border-b border-gray-100">
                        <input type="checkbox" id="member-${currentUserId}" name="group-member" value="${currentUserId}" 
                                data-name="${currentUserName}" class="w-4 h-4 text-green-600 bg-gray-100 rounded focus:ring-green-500" 
                                checked disabled>
                        <label for="member-${currentUserId}" class="ml-3 font-semibold text-gray-800 flex-grow">
                            ${currentUserName} (You, Owner)
                        </label>
                    </div>
                `;
                listContainer.innerHTML += selfCheck;

                // Add contacts with proper profile names
                currentContacts.forEach(contact => {
                    // Get the actual profile name if available
                    const profile = userProfileCache[contact.uid];
                    const displayName = profile && profile.name ? profile.name : contact.name;
                    
                    const item = `
                        <div class="flex items-center p-2 border-b border-gray-100">
                            <input type="checkbox" id="member-${contact.uid}" name="group-member" value="${contact.uid}" 
                                    data-name="${displayName}" class="w-4 h-4 text-green-600 bg-gray-100 rounded focus:ring-green-500">
                            <label for="member-${contact.uid}" class="ml-3 font-medium text-gray-700 flex-grow">
                                ${displayName}
                            </label>
                        </div>
                    `;
                    listContainer.innerHTML += item;
                });
            }

            document.getElementById('new-group-modal').classList.remove('hidden');
        }
        
        window.hideNewGroupModal = function() {
            document.getElementById('new-group-modal').classList.add('hidden');
            document.getElementById('group-status-message').textContent = '';
            document.getElementById('group-name-input').value = '';
        }
        
        window.handleCreateGroup = async function() {
            const groupName = document.getElementById('group-name-input').value.trim();
            const statusMessage = document.getElementById('group-status-message');
            
            if (!groupName) {
                statusMessage.textContent = 'Group name is required.';
                return;
            }
            if (groupName.length > 30) {
                 statusMessage.textContent = 'Group name must be 30 characters or less.';
                 return;
            }

            // Get selected members (including the current user, who is disabled but its UID is used)
            const selectedMemberUids = [currentUserId]; // Start with the owner
            
            document.querySelectorAll('input[name="group-member"]:checked:not(:disabled)').forEach(input => {
                selectedMemberUids.push(input.value);
            });
            
            // Need at least one other member besides self
            if (selectedMemberUids.length < 2) {
                statusMessage.textContent = 'A group needs at least two members (You + 1 contact).';
                return;
            }
            
            statusMessage.textContent = 'Creating group...';
            
            try {
                // 1. Create the group document in the public directory
                const groupRef = collection(db, `/artifacts/${appId}/public/data/group_directory`);
                const newGroupDoc = await addDoc(groupRef, {
                    name: groupName,
                    members: selectedMemberUids,
                    ownerId: currentUserId,
                    createdAt: serverTimestamp()
                });
                
                statusMessage.textContent = `Group \"${groupName}\" created successfully!`;
                
                // 2. Navigate to the new group chat
                navigateTo('chat', { 
                    id: newGroupDoc.id, 
                    name: groupName, 
                    type: 'group' 
                });
                
                // 3. Hide modal after a short delay
                setTimeout(window.hideNewGroupModal, 1000);
            } catch (error) {
                console.error("Error creating group:", error);
                statusMessage.textContent = `Failed to create group: ${error.message}. Check Rules.`;
            }
        }

        // ===================================
        // CHAT DATA & MESSAGING LOGIC (Updated to use selectedChat)
        // ===================================

        /**
         * Generates a deterministic chat ID for a 1:1 conversation by sorting UIDs.
         */
        function getPrivateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        /**
         * Gets the Firestore collection path for messages in the current chat.
         */
        function getMessagesCollectionRef(chatId) {
            // Path: /artifacts/{appId}/public/data/chats/{chatId}/messages
            return collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
        }

        // ===== Reactions (emoji) =====
        const REACTION_EMOJIS = ['👍','❤️','😂','😮','😢','🔥'];

        // Floating reaction picker (dblclick / double-tap)
        let activeReactionPicker = null; // DOM element
        let activeReactionMessageId = null;

        function closeReactionPicker() {
            if (activeReactionPicker && activeReactionPicker.parentNode) {
                activeReactionPicker.parentNode.removeChild(activeReactionPicker);
            }
            activeReactionPicker = null;
            activeReactionMessageId = null;
            document.removeEventListener('click', onOutsideClickClose, true);
        }

        function onOutsideClickClose(evt) {
            if (!activeReactionPicker) return;
            if (!activeReactionPicker.contains(evt.target)) {
                closeReactionPicker();
            }
        }

        function openReactionPicker(messageId, clientX, clientY) {
            closeReactionPicker();
            activeReactionMessageId = messageId;
            const picker = document.createElement('div');
            picker.id = 'reaction-picker';
            picker.className = 'fixed z-50 bg-white/95 backdrop-blur border shadow-lg rounded-full px-2 py-1 flex space-x-1';
            picker.style.left = Math.max(8, clientX - 100) + 'px';
            picker.style.top = Math.max(8, clientY - 50) + 'px';
            REACTION_EMOJIS.forEach(e => {
                const btn = document.createElement('button');
                btn.className = 'text-lg px-1';
                btn.textContent = e;
                btn.onclick = () => { window.toggleReaction(activeReactionMessageId, e); closeReactionPicker(); };
                picker.appendChild(btn);
            });
            document.body.appendChild(picker);
            activeReactionPicker = picker;
            setTimeout(() => document.addEventListener('click', onOutsideClickClose, true), 0);
        }

        /**
         * Toggle a reaction for the current user on a message.
         * Message doc will have field: reactions: { [emoji]: string[] } where array holds userIds
         */
        window.toggleReaction = async function(messageId, emoji) {
            try {
                const messageRef = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                const snap = await getDoc(messageRef);
                if (!snap.exists) return;
                const data = snap.data() || {};
                const reactions = data.reactions || {};
                const currentArray = Array.isArray(reactions[emoji]) ? reactions[emoji] : [];
                const hasReacted = currentArray.includes(currentUserId);

                // Use atomic array operations on nested field using string path
                const fieldKey = `reactions.${emoji}`;
                await updateDoc(messageRef, {
                    [fieldKey]: hasReacted ? arrayRemove(currentUserId) : arrayUnion(currentUserId)
                });
            } catch (e) {
                displayError('Failed to react: ' + e.message);
            }
        }

        /**
         * Starts the real-time listener for messages.
         */
        function startChatListener(chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Stop previous listener
                unsubscribeMessages = null;
            }
            
            // Reset status tracking flags when switching chats
            window.deliveryMarked = false;
            window.readMarked = false;
            
            // Reset scroll position when switching to a new chat
            window.chatScrollPosition = null;
            
            document.getElementById('message-display').innerHTML = '<div class="text-center text-gray-500 p-4">Loading messages...</div>';

            if (!chatId || !selectedChat) {
                document.getElementById('message-display').innerHTML = '<div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>';
                return;
            }

            const messagesRef = getMessagesCollectionRef(chatId);
            const q = query(messagesRef);

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Sort client-side since Firestore query ordering is complex for this path
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                renderMessages(messages);
                
                // MOBILE: Smart scroll behavior - Start at bottom (WhatsApp-like)
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    console.log('📱 MOBILE CHAT LISTENER - Smart scroll behavior (WhatsApp-like)');
                    
                    // Start smart scroll monitor
                    startMobileScrollMonitor();
                    
                    // For new chat, start at bottom
                    const display = document.getElementById('message-display');
                    if (display) {
                        console.log('📱 Starting chat at bottom');
                        display.scrollTop = display.scrollHeight;
                        
                        // Gentle scrolls to ensure we're at bottom
                        setTimeout(() => {
                            display.scrollTop = display.scrollHeight;
                        }, 50);
                        setTimeout(() => {
                            display.scrollTop = display.scrollHeight;
                        }, 100);
                    }
                }
                
                // Mark messages as delivered when chat is opened (only once per chat session)
                if (!window.deliveryMarked) {
                    setTimeout(() => {
                        markMessagesAsDelivered();
                        window.deliveryMarked = true;
                    }, 3000); // Increased delay to reduce blinking
                }
                
                // Mark messages as read when they are visible (throttled)
                if (!window.readMarked) {
                    setTimeout(() => {
                        markAllMessagesAsRead();
                        window.readMarked = true;
                    }, 5000); // Increased delay to reduce blinking
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                displayError("Real-time update error: Missing or insufficient permissions. (Did you set the Firebase Rules?)");
            });
        }

        /**
         * Sends a message to Firestore.
         */
        async function sendMessage(type, content, fileName = null) {
            // Validate Firebase connection first
            if (!validateFirebaseConnection()) {
                displayError("Connection error. Please refresh and try again.");
                return;
            }
            
            if (!currentChatId || !currentUserId || !selectedChat) {
                displayError("Chat not selected or user not authenticated. Cannot send message.");
                return;
            }
            if (!content || content.trim() === '') {
                console.warn("Empty message content, not sending");
                return;
            }

            // Validate and sanitize data
            const sanitizedContent = content.trim();
            const sanitizedType = type || 'text';
            const sanitizedUserName = currentUserName || 'Unknown User';

            // Prepare the message for Firestore with validation
            const newMessage = {
                userId: currentUserId,
                userName: sanitizedUserName,
                type: sanitizedType,
                content: sanitizedContent,
                timestamp: serverTimestamp(),
                status: 'sent',
                readBy: []
            };

            // Add fileName for document messages (with validation)
            if (sanitizedType === 'document' && fileName && fileName.trim() !== '') {
                newMessage.fileName = fileName.trim();
            }

            // Additional validation
            if (!newMessage.userId || newMessage.userId.length < 5) {
                console.error("Invalid userId:", newMessage.userId);
                displayError("Invalid user ID. Please refresh and try again.");
                return;
            }

            if (!newMessage.content || newMessage.content.length > 10000) {
                console.error("Invalid message content length:", newMessage.content?.length);
                displayError("Message too long. Please shorten your message.");
                return;
            }

            try {
                console.log("Sending message to Firestore:", {
                    chatId: currentChatId,
                    messageType: newMessage.type,
                    contentLength: newMessage.content.length,
                    hasFileName: !!newMessage.fileName
                });

                // Send message directly to Firestore - let real-time listener handle the UI
                const docRef = await addDoc(getMessagesCollectionRef(currentChatId), newMessage);
                console.log("Message sent successfully:", docRef.id);
                
            } catch (error) {
                console.error("Error sending message:", error);
                
                // More specific error handling
                if (error.code === 'permission-denied') {
                    displayError("Permission denied. Please check your authentication.");
                } else if (error.code === 'invalid-argument') {
                    displayError("Invalid message data. Please try again.");
                } else if (error.code === 'unavailable') {
                    displayError("Service temporarily unavailable. Please try again.");
                } else {
                    displayError(`Failed to send message: ${error.message}`);
                }
            }
        }

        // Debounce message sending to prevent rapid sends
        let messageSendTimeout = null;
        
        /**
         * Handles the click event for sending a text message.
         */
        window.handleSendText = function() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text) {
                // Clear any existing timeout
                if (messageSendTimeout) {
                    clearTimeout(messageSendTimeout);
                }
                
                // Debounce the message sending
                messageSendTimeout = setTimeout(async () => {
                    // Show loading state on send button
                    const sendButton = document.getElementById('send-button');
                    if (sendButton) {
                        sendButton.disabled = true;
                        sendButton.innerHTML = `
                            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                                <path d="M12 6v6l4 2" stroke-width="2"/>
                            </svg>
                        `;
                    }
                    
                    await sendMessage('text', text);
                    input.value = ''; // Clear input field
                    
                    // Update button visibility after clearing input
                    updateMessageButtons();
                    
                    // Scroll to bottom after sending message
                    setTimeout(() => {
                        const isMobile = window.innerWidth <= 768;
                        if (isMobile) {
                            // More aggressive scrolling for mobile after sending
                            forceScrollToBottomMobile();
                            
                            // Additional scroll attempts for mobile
                            setTimeout(() => {
                                forceScrollToBottomMobile();
                            }, 200);
                            
                            setTimeout(() => {
                                forceScrollToBottomMobile();
                            }, 500);
                        } else {
                            scrollToBottom(true);
                        }
                    }, 100);
                    
                    // Reset send button
                    if (sendButton) {
                        sendButton.disabled = false;
                        sendButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        `;
                    }
                }, 100); // Small delay to prevent rapid sends
            }
        }


        /**
         * Returns the appropriate status icon based on status
         */
        function getStatusIcon(status) {
            switch (status) {
                case 'sending':
                    // Clock icon for sending with spinning animation
                    return `
                        <svg class="w-4 h-3 text-gray-400 status-icon animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path d="M12 6v6l4 2" stroke-width="2"/>
                        </svg>
                    `;
                case 'sent':
                    // Single gray tick
                    return `
                        <svg class="w-4 h-3 text-gray-500 status-icon status-transition" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                        </svg>
                    `;
                case 'delivered':
                    // Double gray tick
                    return `
                        <svg class="w-4 h-3 text-gray-500 status-icon status-transition" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" transform="translate(2, 0)"/>
                        </svg>
                    `;
                case 'read':
                    // Blue double tick
                    return `
                        <svg class="w-4 h-3 text-blue-500 status-icon status-transition" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/>
                            <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" transform="translate(2, 0)"/>
                        </svg>
                    `;
                case 'failed':
                    // Error icon
                    return `
                        <svg class="w-4 h-3 text-red-500 status-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    `;
                default:
                    return '';
            }
        }

        /**
         * Updates message status (sent -> delivered -> read)
         */
        async function updateMessageStatus(messageId, status) {
            try {
                const messageRef = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                await updateDoc(messageRef, { status: status });
            } catch (error) {
                console.error("Error updating message status:", error);
            }
        }

        /**
         * Marks a message as read by the current user
         */
        async function markMessageAsRead(messageId) {
            try {
                const messageRef = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                const messageSnap = await getDoc(messageRef);
                
                if (messageSnap.exists) {
                    const messageData = messageSnap.data();
                    const readBy = messageData.readBy || [];
                    
                    // Only add if not already read by this user
                    if (!readBy.includes(currentUserId)) {
                        await updateDoc(messageRef, {
                            readBy: arrayUnion(currentUserId),
                            status: 'read'
                        });
                    }
                }
            } catch (error) {
                console.error("Error marking message as read:", error);
            }
        }

        /**
         * Marks all messages in current chat as delivered (for other users)
         */
        async function markMessagesAsDelivered() {
            if (!currentChatId || !selectedChat || !currentUserId) return;
            
            try {
                const messagesRef = getMessagesCollectionRef(currentChatId);
                // Simplified query - get all messages and filter client-side
                const snapshot = await getDocs(messagesRef);
                
                const updatePromises = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Only update messages from other users that are still 'sent'
                    if (data.userId && data.userId !== currentUserId && data.status === 'sent') {
                        updatePromises.push(
                            updateDoc(doc.ref, { status: 'delivered' }).catch(err => {
                                console.warn("Failed to update message status:", err);
                                return null; // Continue with other updates
                            })
                        );
                    }
                });
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                    console.log(`Marked ${updatePromises.length} messages as delivered`);
                }
            } catch (error) {
                console.error("Error marking messages as delivered:", error);
                // Don't show error to user for background operations
            }
        }

        /**
         * Marks all unread messages in current chat as read
         */
        async function markAllMessagesAsRead() {
            if (!currentChatId || !selectedChat || !currentUserId) return;
            
            try {
                const messagesRef = getMessagesCollectionRef(currentChatId);
                // Simplified query - get all messages and filter client-side
                const snapshot = await getDocs(messagesRef);
                
                const updatePromises = [];
                snapshot.forEach(doc => {
                    const messageData = doc.data();
                    const readBy = messageData.readBy || [];
                    
                    // Only update messages from other users that haven't been read by current user
                    if (messageData.userId && messageData.userId !== currentUserId && !readBy.includes(currentUserId)) {
                        updatePromises.push(
                            updateDoc(doc.ref, {
                                readBy: arrayUnion(currentUserId),
                                status: 'read'
                            }).catch(err => {
                                console.warn("Failed to mark message as read:", err);
                                return null; // Continue with other updates
                            })
                        );
                    }
                });
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                    console.log(`Marked ${updatePromises.length} messages as read`);
                }
            } catch (error) {
                console.error("Error marking all messages as read:", error);
                // Don't show error to user for background operations
            }
        }

        /**
         * Sets up intersection observer to mark messages as read when they come into view
         */
        function setupReadReceiptObserver() {
            if (!currentChatId || !selectedChat) return;
            
            const messageDisplay = document.getElementById('message-display');
            if (!messageDisplay) return;
            
            // Throttle read receipt updates
            let readReceiptTimeout = null;
            const processedMessages = new Set();
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageId = entry.target.dataset.messageId;
                        if (messageId && !processedMessages.has(messageId)) {
                            processedMessages.add(messageId);
                            
                            // Clear previous timeout and set new one
                            if (readReceiptTimeout) {
                                clearTimeout(readReceiptTimeout);
                            }
                            
                            readReceiptTimeout = setTimeout(() => {
                                markMessageAsRead(messageId);
                            }, 1000); // Increased delay to reduce frequency
                        }
                    }
                });
            }, {
                threshold: 0.7, // Increased threshold to 70% visibility
                rootMargin: '0px 0px -100px 0px' // Only when message is well into view
            });
            
            // Observe all message elements
            const messageElements = messageDisplay.querySelectorAll('[data-message-id]');
            messageElements.forEach(element => {
                observer.observe(element);
            });
        }

        /**
         * Scrolls the message display to the bottom
         */
        function scrollToBottom(force = false) {
            const display = document.getElementById('message-display');
            if (!display) return;
            
            // Force scroll to bottom
            if (force) {
                display.scrollTop = display.scrollHeight;
                return;
            }
            
            // Check if user is near the bottom (within 200px)
            const isNearBottom = display.scrollHeight - display.scrollTop < display.clientHeight + 200;
            
            if (isNearBottom || !window.chatScrollPosition) {
                display.scrollTop = display.scrollHeight;
            }
        }

        /**
         * Force scroll to bottom for mobile - EXTREME aggressive approach (WhatsApp-like behavior)
         */
        function forceScrollToBottomMobile() {
            const display = document.getElementById('message-display');
            if (!display) return;
            
            console.log('🚀 Starting ULTIMATE mobile scroll - WhatsApp-like behavior...');
            
            // IMMEDIATE force scroll - 10 attempts right away
            for (let i = 0; i < 10; i++) {
                display.scrollTop = display.scrollHeight;
            }
            
            // Use requestAnimationFrame for better mobile performance
            requestAnimationFrame(() => {
                // Another 10 immediate scrolls
                for (let i = 0; i < 10; i++) {
                    display.scrollTop = display.scrollHeight;
                }
                
                // ULTIMATE aggressive timing - 100 attempts with very short intervals
                const scrollAttempts = [];
                for (let i = 1; i <= 100; i++) {
                    scrollAttempts.push(i);
                }
                
                scrollAttempts.forEach((delay, index) => {
                    setTimeout(() => {
                        // Triple scroll for each attempt
                        display.scrollTop = display.scrollHeight;
                        display.scrollTop = display.scrollHeight;
                        display.scrollTop = display.scrollHeight;
                        
                        console.log(`🔥 ULTIMATE mobile scroll ${index + 1} (${delay}ms):`, display.scrollTop, display.scrollHeight);
                        
                        // Additional micro-scrolls
                        setTimeout(() => {
                            display.scrollTop = display.scrollHeight;
                            setTimeout(() => {
                                display.scrollTop = display.scrollHeight;
                                setTimeout(() => {
                                    display.scrollTop = display.scrollHeight;
                                }, 1);
                            }, 1);
                        }, 1);
                    }, delay);
                });
            });
            
            // Continuous final attempts every 100ms for 10 seconds
            let finalAttempts = 0;
            const finalInterval = setInterval(() => {
                display.scrollTop = display.scrollHeight;
                display.scrollTop = display.scrollHeight;
                display.scrollTop = display.scrollHeight;
                finalAttempts++;
                
                if (finalAttempts >= 100) { // 10 seconds
                    clearInterval(finalInterval);
                }
            }, 100);
        }

        /**
         * Smart mobile scroll monitor - Only scrolls to bottom when user is at bottom (WhatsApp-like)
         */
        function startMobileScrollMonitor() {
            if (window.innerWidth > 768) return; // Only for mobile
            
            console.log('📱 Starting smart mobile scroll monitor - WhatsApp-like behavior...');
            
            // Stop any existing monitor
            if (window.mobileScrollInterval) {
                clearInterval(window.mobileScrollInterval);
            }
            
            // Smart scroll - only when user is at bottom
            const scrollInterval = setInterval(() => {
                const display = document.getElementById('message-display');
                if (!display || !currentChatId) return;
                
                // Check if user is at bottom (within 50px)
                const isAtBottom = display.scrollTop >= (display.scrollHeight - display.clientHeight - 50);
                
                // Only auto-scroll if user is at bottom (like WhatsApp)
                if (isAtBottom) {
                    display.scrollTop = display.scrollHeight;
                }
            }, 100); // Check every 100ms - reasonable frequency
            
            // Store interval ID for cleanup
            window.mobileScrollInterval = scrollInterval;
        }

        /**
         * Stop mobile scroll monitor
         */
        function stopMobileScrollMonitor() {
            if (window.mobileScrollInterval) {
                clearInterval(window.mobileScrollInterval);
                window.mobileScrollInterval = null;
                console.log('📱 Stopped mobile scroll monitor');
            }
        }

        /**
         * Show mobile notification for new messages
         */
        function showMobileNotification(message, senderName) {
            if (window.innerWidth > 768) return; // Only for mobile
            
            console.log('📱 Attempting to show mobile notification...');
            
            // Check if notifications are supported
            if (!('Notification' in window)) {
                console.log('📱 Notifications not supported');
                return;
            }
            
            // Check if user is currently viewing the chat
            if (document.visibilityState === 'visible' && currentChatId) {
                console.log('📱 User is viewing chat - not showing notification');
                return;
            }
            
            // Request permission if not granted
            if (Notification.permission === 'default') {
                console.log('📱 Requesting notification permission...');
                Notification.requestPermission().then(permission => {
                    console.log('📱 Notification permission:', permission);
                    if (permission === 'granted') {
                        showMobileNotification(message, senderName);
                    }
                });
                return;
            }
            
            if (Notification.permission === 'granted') {
                console.log('📱 Showing notification for:', senderName);
                
                // Get message content
                let messageBody = 'New message';
                if (message.text) {
                    messageBody = message.text;
                } else if (message.type === 'image') {
                    messageBody = '📷 Photo';
                } else if (message.type === 'video') {
                    messageBody = '🎥 Video';
                } else if (message.type === 'audio') {
                    messageBody = '🎤 Voice message';
                } else if (message.type === 'document') {
                    messageBody = '📄 Document';
                }
                
                const notification = new Notification(`💬 ${senderName}`, {
                    body: messageBody,
                    icon: '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: 'whatsapp-message',
                    requireInteraction: false,
                    silent: false,
                    vibrate: [200, 100, 200] // Vibration pattern
                });
                
                // Auto-close notification after 5 seconds
                setTimeout(() => {
                    notification.close();
                }, 5000);
                
                // Handle notification click
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // Handle notification error
                notification.onerror = function(error) {
                    console.error('📱 Notification error:', error);
                };
            } else {
                console.log('📱 Notification permission denied');
            }
        }

        /**
         * Renders the list of messages in the display area.
         */
        function renderMessages(messages) {
            const display = document.getElementById('message-display');
            display.innerHTML = ''; 
            
            // Create a container for proper mobile layout
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-display-container';
            display.appendChild(messageContainer);
            
            if (messages.length === 0 && selectedChat) {
                 messageContainer.innerHTML = `<div class="text-center text-gray-500 p-4">Start a conversation with ${selectedChat.name}!</div>`;
            } else if (!selectedChat) {
                 messageContainer.innerHTML = '<div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>';
            }

            messages.forEach(msg => {
                const isSender = msg.userId === currentUserId;
                const alignment = isSender ? 'justify-end' : 'justify-start';
                const bubbleClass = isSender ? 'sender-bubble' : 'receiver-bubble';
                const showSenderName = selectedChat && selectedChat.type === 'group' && !isSender;

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${alignment} mb-2 message-row`;

                let contentHTML = '';
                
                switch (msg.type) {
                    case 'text':
                        contentHTML = msg.content;
                        break;
                    case 'image':
                        contentHTML = `<div class=\"relative\">\n` +
                            `<img src=\"${msg.content}\" class=\"w-full max-h-64 object-cover rounded-lg cursor-pointer\" onclick=\"window.openImageModal('${msg.content}')\" onerror=\"this.onerror=null;this.src='https://placehold.co/200x150/ff0000/ffffff?text=Image+Load+Error';\" alt=\"Image Message\">` +
                        `</div>`;
                        break;
                    case 'video':
                        contentHTML = `<video src="${msg.content}" controls class="w-full max-h-64 rounded-lg bg-black"></video>`;
                        break;
                    case 'audio':
                        contentHTML = `<audio src="${msg.content}" controls class="w-full"></audio>`;
                        break;
                    case 'document':
                        const fileName = msg.fileName || 'Document';
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        const fileIcon = getFileIcon(fileExtension);
                        contentHTML = `
                            <div class="flex items-center p-3 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition-colors" onclick="window.open('${msg.content}', '_blank')">
                                <div class="flex-shrink-0 mr-3">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <span class="text-2xl">${fileIcon}</span>
                                    </div>
                                </div>
                                <div class="flex-grow min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                                    <p class="text-xs text-gray-500">Tap to download</p>
                                </div>
                                <div class="flex-shrink-0 ml-2">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                            </div>
                        `;
                        break;
                }

                const bubble = document.createElement('div');
                bubble.className = `${bubbleClass} flex flex-col p-2 shadow-md relative group message-bubble message-content`;
                bubble.dataset.messageId = msg.id;
                
                if (msg.type === 'text') {
                    bubble.textContent = contentHTML;
                } else {
                    bubble.innerHTML = contentHTML;
                }
                
                if (showSenderName && msg.userName) {
                    const userIdText = document.createElement('span');
                    userIdText.className = 'text-xs font-semibold mb-1' + (msg.userName ? ' text-green-700' : ' text-gray-500');
                    userIdText.textContent = msg.userName;
                    bubble.prepend(userIdText);
                }

                // Reactions summary (below content)
                if (msg.reactions && typeof msg.reactions === 'object') {
                    const entries = Object.entries(msg.reactions).filter(([k, v]) => Array.isArray(v) && v.length > 0);
                    if (entries.length > 0) {
                        const reactionBar = document.createElement('div');
                        reactionBar.className = 'mt-1 self-start text-xs flex flex-wrap gap-1';
                        entries.forEach(([emoji, users]) => {
                            const pill = document.createElement('span');
                            const me = Array.isArray(users) && users.includes(currentUserId);
                            pill.className = 'px-2 py-0.5 rounded-full border bg-white ' + (me ? 'border-green-500' : 'border-gray-200');
                            pill.textContent = `${emoji} ${users.length}`;
                            pill.onclick = () => window.toggleReaction(msg.id, emoji);
                            reactionBar.appendChild(pill);
                        });
                        bubble.appendChild(reactionBar);
                    }
                }

                // Create time and status container
                const timeStatusContainer = document.createElement('div');
                timeStatusContainer.className = 'flex items-center justify-end mt-1 space-x-1';
                
                const timeSpan = document.createElement('span');
                timeSpan.className = `text-xs ${isSender ? 'text-gray-600' : 'text-gray-400'}`;
                if (msg.timestamp && msg.timestamp.toDate) {
                    const date = msg.timestamp.toDate();
                    timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    timeSpan.textContent = '...';
                }
                
                // Add status indicators for sender's messages
                if (isSender) {
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'flex items-center';
                    
                    const status = msg.status || 'sent';
                    const readBy = msg.readBy || [];
                    const isRead = readBy.length > 0;
                    
                    // Determine the actual status to display
                    let displayStatus = status;
                    if (status === 'read' || isRead) {
                        displayStatus = 'read';
                    } else if (status === 'delivered') {
                        displayStatus = 'delivered';
                    } else if (status === 'sent') {
                        displayStatus = 'sent';
                    } else if (status === 'sending') {
                        displayStatus = 'sending';
                    }
                    
                    statusSpan.innerHTML = getStatusIcon(displayStatus);
                    
                    timeStatusContainer.appendChild(timeSpan);
                    timeStatusContainer.appendChild(statusSpan);
                } else {
                    timeStatusContainer.appendChild(timeSpan);
                }
                
                bubble.appendChild(timeStatusContainer);

                if (isSender) {
                    const actions = document.createElement('div');
                    actions.className = 'absolute -top-2 ' + (isSender ? '-left-2' : '-right-2') + ' hidden group-hover:flex space-x-1';
                    actions.innerHTML = `
                        <button class="bg-white border rounded px-1 text-xs" onclick="window.promptEditMessage('${msg.id}', '${encodeURIComponent(msg.content || '')}')">Edit</button>
                        <button class="bg-white border rounded px-1 text-xs text-red-600" onclick="window.confirmDeleteMessage('${msg.id}')">Del</button>
                    `;
                    bubble.appendChild(actions);
                    bubble.addEventListener('mouseenter', () => actions.classList.remove('hidden'));
                    bubble.addEventListener('mouseleave', () => actions.classList.add('hidden'));
                }

                // Remove always-visible reaction buttons - reactions will be triggered by long press only

                // Double-click (desktop)
                bubble.addEventListener('dblclick', (ev) => {
                    openReactionPicker(msg.id, ev.clientX, ev.clientY);
                });

                // Long press for reactions (mobile) - like WhatsApp
                let longPressTimer = null;
                let isLongPress = false;
                
                bubble.addEventListener('touchstart', (ev) => {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        const touch = ev.touches && ev.touches[0];
                        const x = touch ? touch.clientX : (ev.clientX || 0);
                        const y = touch ? touch.clientY : (ev.clientY || 0);
                        openReactionPicker(msg.id, x, y);
                        
                        // Add haptic feedback if available
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }, 500); // 500ms long press
                }, { passive: true });
                
                bubble.addEventListener('touchend', (ev) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    
                    // Only handle double tap if it wasn't a long press
                    if (!isLongPress) {
                        const now = Date.now();
                        const isSame = lastTapMessageId === msg.id;
                        if (isSame && (now - lastTapTime) < 350) {
                            const touch = ev.changedTouches && ev.changedTouches[0];
                            const x = touch ? touch.clientX : (ev.clientX || 0);
                            const y = touch ? touch.clientY : (ev.clientY || 0);
                            openReactionPicker(msg.id, x, y);
                            lastTapTime = 0;
                            lastTapMessageId = null;
                        } else {
                            lastTapTime = now;
                            lastTapMessageId = msg.id;
                        }
                    }
                    isLongPress = false;
                }, { passive: true });
                
                bubble.addEventListener('touchmove', () => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                }, { passive: true });

                messageDiv.appendChild(bubble);
                messageContainer.appendChild(messageDiv);
            });

            // Auto-scroll to bottom when chat opens or new messages arrive
            // Always scroll to bottom when chat is first opened (no previous scroll position)
            const isNewChat = !window.chatScrollPosition;
            const isMobile = window.innerWidth <= 768;
            
            // MOBILE: Smart scroll behavior - Start at bottom, stay at bottom (WhatsApp-like)
            if (isMobile) {
                console.log('📱 MOBILE DETECTED - Smart scroll behavior (WhatsApp-like)');
                
                // For new chats, always start at bottom
                if (isNewChat) {
                    console.log('📱 New chat - Starting at bottom');
                    display.scrollTop = display.scrollHeight;
                    
                    // A few gentle scrolls to ensure we're at bottom
                    setTimeout(() => {
                        display.scrollTop = display.scrollHeight;
                    }, 50);
                    setTimeout(() => {
                        display.scrollTop = display.scrollHeight;
                    }, 100);
                } else {
                    // For existing chats, check if user was at bottom
                    const wasAtBottom = window.chatScrollPosition >= (display.scrollHeight - display.clientHeight - 100);
                    
                    if (wasAtBottom) {
                        console.log('📱 User was at bottom - Staying at bottom');
                        display.scrollTop = display.scrollHeight;
                    } else {
                        console.log('📱 User was reading older messages - Not auto-scrolling');
                        // Don't auto-scroll, let user continue reading
                    }
                }
                
                // Start the smart mobile scroll monitor
                startMobileScrollMonitor();
            } else {
                // Desktop scrolling
                if (isNewChat) {
                    setTimeout(() => {
                        scrollToBottom(true);
                        setTimeout(() => {
                            scrollToBottom(true);
                        }, 100);
                    }, 50);
                } else {
                    setTimeout(() => {
                        scrollToBottom(false);
                    }, 50);
                }
            }
            
            // Store current scroll position for future reference
            window.chatScrollPosition = display.scrollTop;
            
            // Add scroll event listener to track manual scrolling
            if (!window.scrollListenerAdded) {
                display.addEventListener('scroll', () => {
                    window.chatScrollPosition = display.scrollTop;
                });
                window.scrollListenerAdded = true;
            }
            
            // Set up read receipt observer after messages are rendered (disabled to prevent blinking)
            // setTimeout(() => {
            //     setupReadReceiptObserver();
            // }, 100);
        }

        // ===== Message Edit/Delete Handlers =====
        window.promptEditMessage = function(messageId, encodedOld) {
            const oldContent = decodeURIComponent(encodedOld || '');
            const newText = prompt('Edit message:', oldContent);
            if (newText === null) return;
            window.updateMessageText(messageId, newText.trim());
        }

        window.updateMessageText = async function(messageId, newText) {
            if (!newText) return;
            try {
                const ref = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                await updateDoc(ref, { content: newText, editedAt: serverTimestamp() });
            } catch (e) {
                displayError('Failed to edit message: ' + e.message);
            }
        }

        window.confirmDeleteMessage = function(messageId) {
            if (confirm('Delete this message for everyone?')) {
                window.deleteMessage(messageId);
            }
        }

        window.deleteMessage = async function(messageId) {
            try {
                const ref = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                await deleteDoc(ref);
            } catch (e) {
                displayError('Failed to delete message: ' + e.message);
            }
        }

        // ===== Message Reaction Functions =====
        window.toggleReaction = async function(messageId, emoji) {
            if (!currentChatId || !messageId || !emoji) return;
            
            try {
                const messageRef = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                const messageSnap = await getDoc(messageRef);
                
                if (!messageSnap.exists) {
                    displayError('Message not found');
                    return;
                }
                
                const messageData = messageSnap.data();
                const reactions = messageData.reactions || {};
                const emojiReactions = reactions[emoji] || [];
                
                // Check if user already reacted with this emoji
                const userIndex = emojiReactions.indexOf(currentUserId);
                
                if (userIndex > -1) {
                    // Remove user's reaction
                    emojiReactions.splice(userIndex, 1);
                    if (emojiReactions.length === 0) {
                        delete reactions[emoji];
                    } else {
                        reactions[emoji] = emojiReactions;
                    }
                } else {
                    // Add user's reaction
                    reactions[emoji] = [...emojiReactions, currentUserId];
                }
                
                // Update the message with new reactions
                await updateDoc(messageRef, { reactions: reactions });
                
            } catch (error) {
                console.error('Error toggling reaction:', error);
                displayError('Failed to update reaction: ' + error.message);
            }
        }

        window.openReactionPicker = function(messageId, x, y) {
            // Create reaction picker modal
            const existingPicker = document.getElementById('reaction-picker');
            if (existingPicker) {
                existingPicker.remove();
            }
            
            const picker = document.createElement('div');
            picker.id = 'reaction-picker';
            picker.className = 'fixed z-50 bg-white rounded-lg shadow-lg border p-2 flex space-x-1';
            picker.style.left = Math.min(x - 100, window.innerWidth - 220) + 'px';
            picker.style.top = Math.max(y - 60, 10) + 'px';
            
            const emojis = ['👍', '❤️', '😂', '😮', '😢', '🔥', '👏', '🎉'];
            
            emojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.className = 'text-2xl p-2 hover:bg-gray-100 rounded transition-colors';
                button.onclick = () => {
                    window.toggleReaction(messageId, emoji);
                    picker.remove();
                };
                picker.appendChild(button);
            });
            
            document.body.appendChild(picker);
            
            // Close picker when clicking outside
            const closePicker = (e) => {
                if (!picker.contains(e.target)) {
                    picker.remove();
                    document.removeEventListener('click', closePicker);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closePicker);
            }, 100);
        }

        // ===== Image Modal Functions - WhatsApp-like =====
        let imageModalData = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            startX: 0,
            startY: 0,
            lastTouchDistance: 0
        };

        window.openImageModal = function(imageUrl) {
            // Remove existing modal if any
            const existingModal = document.getElementById('image-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Reset modal data
            imageModalData = {
                scale: 1,
                translateX: 0,
                translateY: 0,
                isDragging: false,
                startX: 0,
                startY: 0,
                lastTouchDistance: 0
            };
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'image-modal';
            modal.className = 'image-modal';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'image-modal-header';
            header.innerHTML = `
                <button class="image-modal-back" onclick="closeImageModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="image-modal-actions">
                    <button class="image-modal-action-btn" onclick="shareImage('${imageUrl}')" title="Share">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                    <button class="image-modal-action-btn" onclick="downloadImage('${imageUrl}')" title="Download">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Create content area
            const content = document.createElement('div');
            content.className = 'image-modal-content';
            
            // Create image
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'Chat Image';
            img.id = 'modal-image';
            img.draggable = false;
            
            // Add touch and mouse events for zoom and pan
            addImageModalEvents(img);
            
            // Create footer with zoom controls
            const footer = document.createElement('div');
            footer.className = 'image-modal-footer';
            footer.innerHTML = `
                <div class="image-modal-zoom-controls">
                    <button class="zoom-btn" onclick="zoomImage(-0.2)" title="Zoom Out">−</button>
                    <button class="zoom-btn" onclick="resetImageZoom()" title="Reset">⌂</button>
                    <button class="zoom-btn" onclick="zoomImage(0.2)" title="Zoom In">+</button>
                </div>
            `;
            
            // Assemble modal
            content.appendChild(img);
            modal.appendChild(header);
            modal.appendChild(content);
            modal.appendChild(footer);
            
            // Add to page
            document.body.appendChild(modal);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeImageModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function addImageModalEvents(img) {
            // Mouse events
            img.addEventListener('mousedown', handleMouseDown);
            img.addEventListener('mousemove', handleMouseMove);
            img.addEventListener('mouseup', handleMouseUp);
            img.addEventListener('wheel', handleWheel);
            
            // Touch events
            img.addEventListener('touchstart', handleTouchStart, { passive: false });
            img.addEventListener('touchmove', handleTouchMove, { passive: false });
            img.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // Double click to reset zoom
            img.addEventListener('dblclick', resetImageZoom);
        }

        function handleMouseDown(e) {
            if (imageModalData.scale > 1) {
                imageModalData.isDragging = true;
                imageModalData.startX = e.clientX - imageModalData.translateX;
                imageModalData.startY = e.clientY - imageModalData.translateY;
                e.preventDefault();
            }
        }

        function handleMouseMove(e) {
            if (imageModalData.isDragging && imageModalData.scale > 1) {
                imageModalData.translateX = e.clientX - imageModalData.startX;
                imageModalData.translateY = e.clientY - imageModalData.startY;
                updateImageTransform();
                e.preventDefault();
            }
        }

        function handleMouseUp(e) {
            imageModalData.isDragging = false;
        }

        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomImage(delta);
        }

        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                // Single touch - start dragging
                if (imageModalData.scale > 1) {
                    imageModalData.isDragging = true;
                    imageModalData.startX = e.touches[0].clientX - imageModalData.translateX;
                    imageModalData.startY = e.touches[0].clientY - imageModalData.translateY;
                }
            } else if (e.touches.length === 2) {
                // Two touches - pinch to zoom
                const distance = getTouchDistance(e.touches[0], e.touches[1]);
                imageModalData.lastTouchDistance = distance;
                e.preventDefault();
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 1 && imageModalData.isDragging && imageModalData.scale > 1) {
                // Single touch dragging
                imageModalData.translateX = e.touches[0].clientX - imageModalData.startX;
                imageModalData.translateY = e.touches[0].clientY - imageModalData.startY;
                updateImageTransform();
            } else if (e.touches.length === 2) {
                // Pinch to zoom
                const distance = getTouchDistance(e.touches[0], e.touches[1]);
                const scaleChange = distance / imageModalData.lastTouchDistance;
                const newScale = imageModalData.scale * scaleChange;
                
                if (newScale >= 0.5 && newScale <= 3) {
                    imageModalData.scale = newScale;
                    updateImageTransform();
                }
                
                imageModalData.lastTouchDistance = distance;
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            imageModalData.isDragging = false;
        }

        function getTouchDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function updateImageTransform() {
            const img = document.getElementById('modal-image');
            if (img) {
                img.style.transform = `scale(${imageModalData.scale}) translate(${imageModalData.translateX}px, ${imageModalData.translateY}px)`;
            }
        }

        window.closeImageModal = function() {
            const modal = document.getElementById('image-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        window.zoomImage = function(factor) {
            const newScale = Math.max(0.5, Math.min(3, imageModalData.scale + factor));
            imageModalData.scale = newScale;
            
            // Reset translation if zooming out to fit
            if (imageModalData.scale <= 1) {
                imageModalData.translateX = 0;
                imageModalData.translateY = 0;
            }
            
            updateImageTransform();
        }

        window.resetImageZoom = function() {
            imageModalData.scale = 1;
            imageModalData.translateX = 0;
            imageModalData.translateY = 0;
            updateImageTransform();
        }

        window.shareImage = async function(imageUrl) {
            if (navigator.share) {
                try {
                    // Fetch the image as blob
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const file = new File([blob], 'image.jpg', { type: blob.type });
                    
                    await navigator.share({
                        title: 'Shared Image',
                        text: 'Check out this image!',
                        files: [file]
                    });
                } catch (error) {
                    console.log('Share failed:', error);
                    fallbackShare(imageUrl);
                }
            } else {
                fallbackShare(imageUrl);
            }
        }

        function fallbackShare(imageUrl) {
            // Copy to clipboard as fallback
            navigator.clipboard.writeText(imageUrl).then(() => {
                displayError('Image URL copied to clipboard!');
            }).catch(() => {
                // Final fallback - open in new tab
                window.open(imageUrl, '_blank');
            });
        }

        window.downloadImage = async function(imageUrl) {
            try {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `whatsapp-image-${Date.now()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                displayError('Image downloaded successfully!');
            } catch (error) {
                console.error('Download failed:', error);
                displayError('Download failed. Please try again.');
            }
        }

        // ===== Attachment Menu Functions =====
        window.toggleAttachmentMenu = function() {
            const menu = document.getElementById('attachment-menu');
            menu.classList.toggle('hidden');
            
            // Close menu when clicking outside
            if (!menu.classList.contains('hidden')) {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && !e.target.closest('.attachment-btn')) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenu);
                    }
                };
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 100);
            }
        }

        window.selectPhotosAndVideos = function() {
            document.getElementById('image-input').click();
            document.getElementById('attachment-menu').classList.add('hidden');
        }

        window.openCamera = function() {
            document.getElementById('camera-input').click();
            document.getElementById('attachment-menu').classList.add('hidden');
        }

        window.selectDocument = function() {
            document.getElementById('document-input').click();
            document.getElementById('attachment-menu').classList.add('hidden');
        }

        // ===== Updated Button Visibility Logic =====
        function updateMessageButtons() {
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const micButton = document.getElementById('mic-button');
            const recordButton = document.getElementById('record-button');
            const stopRecordButton = document.getElementById('stop-record-button');
            
            const hasText = messageInput.value.trim().length > 0;
            const isRecording = window.mediaRecorder && window.mediaRecorder.state === 'recording';
            
            if (isRecording) {
                sendButton.classList.add('hidden');
                micButton.classList.add('hidden');
                recordButton.classList.add('hidden');
                stopRecordButton.classList.remove('hidden');
            } else if (hasText) {
                sendButton.classList.remove('hidden');
                micButton.classList.add('hidden');
                recordButton.classList.add('hidden');
                stopRecordButton.classList.add('hidden');
            } else {
                sendButton.classList.add('hidden');
                micButton.classList.remove('hidden');
                recordButton.classList.add('hidden');
                stopRecordButton.classList.add('hidden');
            }
        }

        // ===== File Icon Helper =====
        function getFileIcon(extension) {
            const iconMap = {
                'pdf': '📄',
                'doc': '📝',
                'docx': '📝',
                'txt': '📄',
                'rtf': '📄',
                'xls': '📊',
                'xlsx': '📊',
                'ppt': '📊',
                'pptx': '📊',
                'zip': '🗜️',
                'rar': '🗜️',
                '7z': '🗜️',
                'mp3': '🎵',
                'wav': '🎵',
                'mp4': '🎬',
                'avi': '🎬',
                'mov': '🎬',
                'jpg': '🖼️',
                'jpeg': '🖼️',
                'png': '🖼️',
                'gif': '🖼️',
                'svg': '🖼️'
            };
            return iconMap[extension] || '📎';
        }
        
        // ===================================
        // CLOUDINARY & MEDIA LOGIC (Unchanged)
        // ===================================

        async function uploadToCloudinary(file, resourceType) {
            if (CLOUDINARY_CLOUD_NAME === 'your_cloud_name') {
                displayError("Cloudinary is not configured. Please update CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET in the script.");
                return null;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
            
            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Cloudinary upload failed with status: ' + response.statusText);
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary upload error:", error);
                displayError(`Media upload failed: ${error.message}`);
                return null;
            }
        }

        window.handleFileSelect = async function(type) {
            const input = document.getElementById(`${type}-input`);
            const file = input.files[0];
            if (!file) return;

            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-text').textContent = `Uploading ${type}...`;
            
            let resourceType;
            let messageType;
            
            if (type === 'image' || type === 'camera') {
                resourceType = 'image';
                messageType = 'image';
            } else if (type === 'video') {
                resourceType = 'video';
                messageType = 'video';
            } else if (type === 'document') {
                resourceType = 'raw';
                messageType = 'document';
            }
            
            const url = await uploadToCloudinary(file, resourceType);
            
            document.getElementById('loading-indicator').classList.add('hidden');

            if (url) {
                sendMessage(messageType, url, file.name);
            }
            input.value = null;
        }

        // ===== Emoji & Stickers =====
        window.toggleEmojiPanel = function() {
            const p = document.getElementById('emoji-panel');
            if (p) p.classList.toggle('hidden');
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.add('hidden');
        }

        window.toggleStickerPanel = function() {
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.toggle('hidden');
            const p = document.getElementById('emoji-panel');
            if (p) p.classList.add('hidden');
        }

        window.insertEmoji = function(char) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart || input.value.length;
            const end = input.selectionEnd || input.value.length;
            input.value = input.value.slice(0, start) + char + input.value.slice(end);
            input.focus();
            const pos = start + char.length;
            input.setSelectionRange(pos, pos);
        }

        window.sendSticker = function(url) {
            if (!url) return;
            sendMessage('image', url);
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.add('hidden');
        }

        window.startRecording = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                window.mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                window.mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                window.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Show loading state
                    const recordButton = document.getElementById('record-button');
                    const stopRecordButton = document.getElementById('stop-record-button');
                    const sendButton = document.getElementById('send-button');
                    
                    if (recordButton) recordButton.classList.add('hidden');
                    if (stopRecordButton) stopRecordButton.classList.add('hidden');
                    if (sendButton) sendButton.classList.add('hidden');
                    
                    // Show loading indicator
                    const loadingIndicator = document.getElementById('loading-indicator');
                    const loadingText = document.getElementById('loading-text');
                    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                    if (loadingText) loadingText.textContent = 'Uploading audio...';

                    const url = await uploadToCloudinary(audioBlob, 'raw');

                    // Hide loading indicator
                    if (loadingIndicator) loadingIndicator.classList.add('hidden');
                    
                    // Reset buttons after upload attempt
                    updateMessageButtons();

                    if (url) {
                        sendMessage('audio', url);
                    }

                    stream.getTracks().forEach(track => track.stop());
                };

                window.mediaRecorder.start();
                
                // Update button visibility
                const recordButton = document.getElementById('record-button');
                const stopRecordButton = document.getElementById('stop-record-button');
                const sendButton = document.getElementById('send-button');
                
                if (recordButton) recordButton.classList.add('hidden');
                if (stopRecordButton) stopRecordButton.classList.remove('hidden');
                if (sendButton) sendButton.classList.add('hidden');

            } catch (error) {
                console.error("Error starting audio recording:", error);
                displayError("Microphone access denied or error: " + error.message);
            }
        }

        window.stopRecording = function() {
            if (window.mediaRecorder && window.mediaRecorder.state === 'recording') {
                window.mediaRecorder.stop();
            }
        }

        /**
         * Utility function to display non-alert messages.
         */
        function displayError(message) {
            const errorBox = document.getElementById('error-box');
            const displayMessage = message.includes("Missing or insufficient permissions") 
                ? "SECURITY ERROR: Missing or insufficient permissions. Please check Firebase Rules." 
                : message;

            errorBox.textContent = displayMessage;
            errorBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-600', 'bg-yellow-500');
            errorBox.classList.add(message.includes("SECURITY ERROR") ? 'bg-red-600' : 'bg-yellow-500');

            // Also display the error inside the auth container if visible
            const authError = document.getElementById('auth-error-message');
            if (authError && !document.getElementById('auth-container').classList.contains('hidden')) {
                authError.textContent = message;
            }

            setTimeout(() => {
                errorBox.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        // ===== Chat level actions =====
        window.toggleChatActions = function() {
            const menu = document.getElementById('chat-actions-menu');
            if (menu) menu.classList.toggle('hidden');
        }

        window.handleBackupChat = async function() {
            if (!currentChatId) return;
            try {
                const rows = [];
                const snap = await getDocs(getMessagesCollectionRef(currentChatId));
                snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
                const blob = new Blob([JSON.stringify({ chatId: currentChatId, messages: rows }, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_${currentChatId}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                displayError('Failed to export chat: ' + e.message);
            }
        }

        window.handleDeleteChat = async function() {
            if (!currentChatId || !selectedChat) return;
            if (!confirm('Delete this chat and all its messages?')) return;
            try {
                const snap = await getDocs(getMessagesCollectionRef(currentChatId));
                const deletions = [];
                snap.forEach(d => deletions.push(deleteDoc(doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, d.id))));
                await Promise.all(deletions);
                displayError('Chat cleared.');
            } catch (e) {
                displayError('Failed to delete chat: ' + e.message);
            }
        }

        // ===== Add members to group =====
        window.showAddMembersModal = async function() {
            if (!selectedChat || selectedChat.type !== 'group') { displayError('Select a group chat.'); return; }
            const listContainer = document.getElementById('add-members-list');
            listContainer.innerHTML = '<p class="text-center text-gray-500 p-3">Loading contacts...</p>';
            
            const members = selectedChat.members || [];
            const eligible = currentContacts.filter(c => !members.includes(c.uid));
            
            if (eligible.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-600 p-3">No eligible contacts to add.</p>';
            } else {
                // Load profile names for all eligible contacts first
                await Promise.all(eligible.map(contact => loadUserPublicProfile(contact.uid)));
                
                // Clear loading message
                listContainer.innerHTML = '';
                
                eligible.forEach(contact => {
                    // Get the actual profile name if available
                    const profile = userProfileCache[contact.uid];
                    const displayName = profile && profile.name ? profile.name : contact.name;
                    
                    listContainer.innerHTML += `
                        <div class="flex items-center p-2 border-b border-gray-100">
                            <input type="checkbox" id="add-${contact.uid}" value="${contact.uid}" class="w-4 h-4 text-green-600">
                            <label for="add-${contact.uid}" class="ml-3">${displayName}</label>
                        </div>`;
                });
            }
            document.getElementById('add-members-modal').classList.remove('hidden');
        }

        window.hideAddMembersModal = function() {
            document.getElementById('add-members-modal').classList.add('hidden');
            document.getElementById('add-members-status').textContent = '';
        }

        window.handleAddMembersToGroup = async function() {
            const status = document.getElementById('add-members-status');
            const checked = Array.from(document.querySelectorAll('#add-members-list input[type="checkbox"]:checked')).map(i => i.value);
            if (checked.length === 0) { status.textContent = 'Select at least one contact.'; return; }
            try {
                const groupRef = doc(db, `/artifacts/${appId}/public/data/group_directory`, selectedChat.id);
                const currentMembers = selectedChat.members || [];
                const merged = Array.from(new Set([...currentMembers, ...checked]));
                await updateDoc(groupRef, { members: merged });
                status.textContent = 'Members added!';
                setTimeout(window.hideAddMembersModal, 800);
            } catch (e) {
                status.textContent = 'Failed: ' + e.message;
            }
        }

        // ===== Group photo (owner only) =====
        window.showChangeGroupPhoto = function() {
            if (!selectedChat || selectedChat.type !== 'group') { displayError('Open a group to change its photo.'); return; }
            if (selectedChat.ownerId && selectedChat.ownerId !== currentUserId) { displayError('Only the group owner can change the photo.'); return; }
            const input = document.getElementById('change-group-photo-input');
            input.onchange = async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('loading-text').textContent = 'Uploading group photo...';
                const url = await uploadToCloudinary(file, 'image');
                document.getElementById('loading-indicator').classList.add('hidden');
                if (!url) return;
                try {
                    const groupRef = doc(db, `/artifacts/${appId}/public/data/group_directory`, selectedChat.id);
                    await updateDoc(groupRef, { photoURL: url });
                    // Update header immediately
                    const avatar = document.getElementById('chat-avatar');
                    if (avatar) avatar.innerHTML = `<img src="${url}" class="w-10 h-10 rounded-full object-cover">`;
                    displayError('Group photo updated.');
                } catch (e2) {
                    displayError('Failed to set group photo: ' + e2.message);
                }
            };
            input.click();
        }

        /**
         * Validates Firebase configuration and connection
         */
        function validateFirebaseConnection() {
            try {
                if (!app || !db || !auth) {
                    console.error("Firebase not properly initialized");
                    return false;
                }
                
                if (!currentUserId) {
                    console.warn("User not authenticated");
                    return false;
                }
                
                if (!currentChatId) {
                    console.warn("No chat selected");
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error("Firebase validation error:", error);
                return false;
            }
        }

        /**
         * Share the WhatsApp clone app using Web Share API or fallback methods
         */
        async function shareApp() {
            const shareData = {
                title: 'WhatsApp Clone - Real-time Chat App',
                text: 'Check out this amazing WhatsApp clone with real-time messaging, group chats, and more!',
                url: window.location.href
            };

            // Check if Web Share API is supported
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                    console.log('App shared successfully via Web Share API');
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error sharing via Web Share API:', error);
                        fallbackShare(shareData);
                    }
                }
            } else {
                // Fallback for browsers that don't support Web Share API
                fallbackShare(shareData);
            }
        }

        /**
         * Fallback sharing method for unsupported browsers
         */
        function fallbackShare(shareData) {
            // Try to copy URL to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareData.url).then(() => {
                    displayError('App link copied to clipboard! You can now share it with others.');
                }).catch(() => {
                    showShareModal(shareData);
                });
            } else {
                showShareModal(shareData);
            }
        }

        /**
         * Show a modal with sharing options
         */
        function showShareModal(shareData) {
            // Create share modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
                    <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Share WhatsApp Clone</h3>
                    <p class="text-sm text-gray-600 mb-4">Share this amazing chat app with your friends!</p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <p class="text-sm font-medium">App Link</p>
                                <p class="text-xs text-gray-500 break-all">${shareData.url}</p>
                            </div>
                            <button onclick="copyToClipboard('${shareData.url}')" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition duration-150">
                                Copy
                            </button>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="shareToWhatsApp('${shareData.url}')" class="flex-1 flex items-center justify-center space-x-2 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                </svg>
                                <span class="text-sm">WhatsApp</span>
                            </button>
                            
                            <button onclick="shareToTelegram('${shareData.url}')" class="flex-1 flex items-center justify-center space-x-2 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                                <span class="text-sm">Telegram</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-4">
                        <button onclick="this.closest('.modal-backdrop').remove()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        /**
         * Copy text to clipboard
         */
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    displayError('Link copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                displayError('Link copied to clipboard!');
            }
        }

        /**
         * Share to WhatsApp
         */
        function shareToWhatsApp(url) {
            const message = `Check out this amazing WhatsApp clone: ${url}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        /**
         * Share to Telegram
         */
        function shareToTelegram(url) {
            const message = `Check out this amazing WhatsApp clone: ${url}`;
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent('WhatsApp Clone - Real-time Chat App')}`;
            window.open(telegramUrl, '_blank');
        }

        /**
         * Update user avatar in header with initials
         */
        function updateUserAvatar() {
            const avatarElement = document.getElementById('current-user-avatar');
            if (avatarElement && currentUserName) {
                // Get initials from user name
                const initials = currentUserName
                    .split(' ')
                    .map(name => name.charAt(0))
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                
                avatarElement.textContent = initials;
            }
        }

        // ===================================
        // WELCOME ANIMATION & PERSISTENT LOGIN
        // ===================================
        
        /**
         * Shows the welcome animation screen
         */
        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const authContainer = document.getElementById('auth-container');
            const chatAppContainer = document.getElementById('chat-app-container');
            
            // Hide other screens
            if (authContainer) authContainer.classList.add('hidden');
            if (chatAppContainer) chatAppContainer.classList.add('hidden');
            
            // Show welcome screen
            welcomeScreen.classList.remove('hidden');
            
            // Animate elements in
            setTimeout(() => {
                const title = document.getElementById('welcome-title');
                const subtitle = document.getElementById('welcome-subtitle');
                if (title) title.classList.add('welcome-animate-in');
                if (subtitle) subtitle.classList.add('welcome-animate-in');
            }, 500);
        }
        
        /**
         * Hides the welcome animation screen
         */
        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.classList.add('welcome-animate-out');
                setTimeout(() => {
                    welcomeScreen.classList.add('hidden');
                    welcomeScreen.classList.remove('welcome-animate-out');
                }, 500);
            }
        }
        
        /**
         * Skips the welcome animation and goes directly to the app
         */
        window.skipWelcomeAnimation = function() {
            hideWelcomeScreen();
            setTimeout(() => {
                showChatScreen();
                renderApp();
            }, 500);
        }
        
        /**
         * Stores login state in localStorage
         */
        function storeLoginState(userId, userName) {
            try {
                const loginData = {
                    userId: userId,
                    userName: userName,
                    timestamp: Date.now(),
                    hasLoggedIn: true
                };
                localStorage.setItem('whatsapp_login_state', JSON.stringify(loginData));
            } catch (error) {
                console.warn('Could not store login state:', error);
            }
        }
        
        /**
         * Retrieves login state from localStorage
         */
        function getLoginState() {
            try {
                const loginData = localStorage.getItem('whatsapp_login_state');
                if (loginData) {
                    const parsed = JSON.parse(loginData);
                    // Check if login state is not too old (7 days)
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                    if (Date.now() - parsed.timestamp < maxAge) {
                        return parsed;
                    } else {
                        // Clear old login state
                        localStorage.removeItem('whatsapp_login_state');
                    }
                }
            } catch (error) {
                console.warn('Could not retrieve login state:', error);
            }
            return null;
        }
        
        /**
         * Clears login state from localStorage
         */
        function clearLoginState() {
            try {
                localStorage.removeItem('whatsapp_login_state');
            } catch (error) {
                console.warn('Could not clear login state:', error);
            }
        }
        
        /**
         * Gets a time-appropriate greeting
         */
        function getTimeBasedGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good morning';
            if (hour < 17) return 'Good afternoon';
            return 'Good evening';
        }
        
        /**
         * Checks if user has previously logged in and shows appropriate screen
         */
        function checkLoginState() {
            const loginState = getLoginState();
            
            if (loginState && loginState.hasLoggedIn) {
                // User has logged in before, show welcome animation
                showWelcomeScreen();
                
                // Update welcome message with user's name if available
                const title = document.getElementById('welcome-title');
                const subtitle = document.getElementById('welcome-subtitle');
                if (title && loginState.userName) {
                    const greeting = getTimeBasedGreeting();
                    title.textContent = `${greeting}, ${loginState.userName}!`;
                }
                if (subtitle) {
                    subtitle.textContent = 'Loading your messages...';
                }
                
                return true; // Indicates user has logged in before
            } else {
                // First time user, show auth screen directly
                showAuthScreen();
                return false; // Indicates first time user
            }
        }

        /**
         * Attempts to auto-login user if they have a valid session
         */
        async function attemptAutoLogin() {
            try {
                // Check if Firebase auth has a current user (persistent session)
                if (auth && auth.currentUser) {
                    const user = auth.currentUser;
                    const loginState = getLoginState();
                    
                    // Verify the stored login state matches current user
                    if (loginState && loginState.userId === user.uid) {
                        // User has valid session and stored login state
                        currentUserId = user.uid;
                        await setupUserProfile(user);
                        
                        // Update stored login state with current user name
                        storeLoginState(user.uid, currentUserName);
                        
                        startContactsListener();
                        startGroupsListener();
                        
                        // Show welcome animation then chat
                        showWelcomeScreen();
                        
                        // Update welcome message with time-based greeting
                        const title = document.getElementById('welcome-title');
                        const subtitle = document.getElementById('welcome-subtitle');
                        if (title && currentUserName) {
                            const greeting = getTimeBasedGreeting();
                            title.textContent = `${greeting}, ${currentUserName}!`;
                        }
                        if (subtitle) {
                            subtitle.textContent = 'Loading your messages...';
                        }
                        
                        setTimeout(() => {
                            hideWelcomeScreen();
                            setTimeout(() => {
                                showChatScreen();
                                renderApp();
                            }, 500);
                        }, 2000);
                        
                        return true; // Auto-login successful
                    }
                }
            } catch (error) {
                console.warn('Auto-login failed:', error);
            }
            return false; // Auto-login failed
        }

        // Initialize the application on load
        window.onload = async function() {
            // Check login state first
            const hasLoggedInBefore = checkLoginState();
            
            // Initialize Firebase
            await initFirebase();
            
            // If user has logged in before, try auto-login
            if (hasLoggedInBefore) {
                const autoLoginSuccess = await attemptAutoLogin();
                if (!autoLoginSuccess) {
                    // Auto-login failed, show auth screen
                    hideWelcomeScreen();
                    showAuthScreen();
                }
            }
        };
    </script>
</head>
<body class="bg-gray-100 p-0 sm:p-4">

    <!-- Welcome Animation Screen -->
    <div id="welcome-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-green-400 via-green-500 to-green-600 hidden">
        <div class="text-center text-white">
            <!-- WhatsApp Logo Animation -->
            <div class="mb-8">
                <div id="whatsapp-logo" class="w-24 h-24 mx-auto mb-4 bg-white rounded-full flex items-center justify-center shadow-2xl animate-pulse">
                    <svg class="w-12 h-12 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                    </svg>
                </div>
            </div>
            
            <!-- Welcome Text -->
            <div class="mb-8">
                <h1 id="welcome-title" class="text-3xl font-bold mb-2 opacity-0 transform translate-y-4 transition-all duration-1000">Welcome Back!</h1>
                <p id="welcome-subtitle" class="text-lg opacity-0 transform translate-y-4 transition-all duration-1000 delay-300">Loading your messages...</p>
            </div>
            
            <!-- Loading Animation -->
            <div class="flex justify-center space-x-2 mb-6">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            
            <!-- Skip Button -->
            <button id="skip-welcome-btn" onclick="skipWelcomeAnimation()" 
                    class="text-white/70 hover:text-white text-sm underline transition-colors duration-200">
                Skip animation
            </button>
        </div>
    </div>

    <!-- Error/Notification Box (Custom, non-alert) -->
    <div id="error-box" class="fixed top-4 right-4 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <!-- Error message will appear here -->
    </div>
    
    <!-- ADD CONTACT MODAL -->
    <div id="add-contact-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Add New Contact</h3>
            <p class="text-sm text-gray-600 mb-4">Enter the full UID of the user you want to chat with. Your UID is shown in Profile Settings.</p>
            
            <input type="text" id="contact-search-input" placeholder="User ID (Full UID)"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
            
            <p id="add-contact-status" class="text-sm text-red-500 h-5 mb-4"></p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideAddContactModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button onclick="handleAddContact()"
                        class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Add User
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW GROUP MODAL -->
    <div id="new-group-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Create New Group</h3>
            
            <input type="text" id="group-name-input" placeholder="Enter Group Name (e.g., Team Project)"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
            
            <h4 class="text-md font-semibold mb-2 text-gray-700">Select Members:</h4>
            <div id="group-contact-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg mb-4 bg-gray-50">
                <!-- Contacts will be populated here -->
            </div>
            
            <p id="group-status-message" class="text-sm text-red-500 h-5 mb-4"></p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideNewGroupModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button id="create-group-button" onclick="handleCreateGroup()"
                        class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Create Group
                </button>
            </div>
        </div>
    </div>

    <!-- VOICE MESSAGE RECORDING MODAL -->
    <div id="voice-recording-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4 text-center" style="color: var(--whatsapp-green);">🎤 Recording Voice Message</h3>
            
            <div class="flex flex-col items-center mb-6">
                <div id="recording-visualizer" class="w-full h-20 bg-gray-100 rounded-lg mb-4 flex items-center justify-center">
                    <div class="flex space-x-1">
                        <div class="voice-bar w-1 h-8 bg-green-500 rounded animate-pulse"></div>
                        <div class="voice-bar w-1 h-12 bg-green-500 rounded animate-pulse" style="animation-delay: 0.1s"></div>
                        <div class="voice-bar w-1 h-16 bg-green-500 rounded animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="voice-bar w-1 h-12 bg-green-500 rounded animate-pulse" style="animation-delay: 0.3s"></div>
                        <div class="voice-bar w-1 h-8 bg-green-500 rounded animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
                
                <div id="recording-timer" class="text-3xl font-mono font-bold text-gray-700">
                    00:00
                </div>
                
                <p class="text-sm text-gray-500 mt-2">Recording in progress...</p>
            </div>
            
            <div class="flex justify-center space-x-3">
                <button onclick="cancelVoiceRecording()"
                        class="px-6 py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200 bg-red-500 hover:bg-red-600">
                    ❌ Cancel
                </button>
                <button onclick="stopAndSendVoiceRecording()"
                        class="px-6 py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    ✓ Send
                </button>
            </div>
        </div>
    </div>

    <!-- STATUS CREATION MODAL -->
    <div id="status-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Add Status Update</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Status Type:</label>
                <div class="flex space-x-4">
                    <button onclick="selectStatusType('text')" id="text-status-btn" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150">
                        📝 Text
                    </button>
                    <button onclick="selectStatusType('photo')" id="photo-status-btn" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150">
                        📷 Photo
                    </button>
                </div>
            </div>
            
            <div id="text-status-input" class="mb-4">
                <textarea id="status-text-input" placeholder="What's on your mind?" 
                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150 h-24 resize-none"></textarea>
            </div>
            
            <div id="photo-status-input" class="mb-4 hidden">
                <input type="file" id="status-photo-input" accept="image/*" class="hidden" onchange="handleStatusPhotoSelect()">
                <button onclick="document.getElementById('status-photo-input').click()" 
                        class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 transition duration-150">
                    📷 Choose Photo
                </button>
                <div id="status-photo-preview" class="mt-3 hidden">
                    <img id="status-preview-img" class="w-full h-32 object-cover rounded-lg">
                </div>
            </div>
            
            <p id="status-error-message" class="text-sm text-red-500 h-5 mb-4"></p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideStatusModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button id="post-status-button" onclick="handlePostStatus()"
                        class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Post Status
                </button>
            </div>
        </div>
    </div>

    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-container" class="flex flex-col items-center justify-center">
        <div class="auth-card">
            <h2 class="text-3xl font-extrabold text-center mb-6" style="color: var(--whatsapp-green);">
                Chat Login
            </h2>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150"
                       required>
                <input type="password" id="auth-password" placeholder="Password (min 6 characters)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150"
                       required onkeyup="if(event.key === 'Enter') handleSignIn()">
                
                <p id="auth-error-message" class="text-sm text-red-500 text-center h-4"></p>
                
                <button onclick="handleSignIn()"
                        class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Sign In
                </button>
                <button onclick="handleSignUp()"
                        class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-green);">
                    Create Account
                </button>
            </div>
            <p class="text-xs text-gray-500 text-center mt-4">
                Your ID is safe. Please use a strong password.
            </p>
        </div>
    </div>


    <!-- CHAT APPLICATION CONTAINER (Multi-View) -->
    <div id="chat-app-container" class="app-main-container bg-white rounded-lg sm:rounded-xl overflow-hidden hidden">
        
        <!-- LEFT PANEL: Chats/Groups List -->
        <div id="left-panel" class="left-panel bg-white">
            
            <!-- Sidebar Header - WhatsApp Style -->
            <div class="header-bg mobile-header flex justify-between items-center text-white shadow-md flex-shrink-0 px-4 py-3">
                <!-- WhatsApp Logo -->
                <div class="flex items-center">
                    <div class="flex items-center space-x-3">
                        <!-- WhatsApp Logo -->
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Profile and Actions -->
                <div class="flex items-center space-x-3">
                    <!-- User Profile -->
                    <button onclick="navigateTo('profile')" class="flex items-center space-x-2 hover:bg-white hover:bg-opacity-10 rounded-full p-1 transition duration-150">
                        <div class="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center overflow-hidden">
                            <span id="current-user-avatar" class="text-sm font-bold text-white">
                                <!-- User avatar will be inserted here -->
                            </span>
                        </div>
                        <span id="current-user-name-display" class="text-sm font-medium text-white hidden sm:block">Loading...</span>
                    </button>
                    
                    <!-- Share Button -->
                    <button onclick="shareApp()" class="p-2 hover:bg-white hover:bg-opacity-10 rounded-full transition duration-150" title="Share App">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                    
                    <!-- Sign Out Button -->
                    <button onclick="handleSignOut()" class="p-2 hover:bg-white hover:bg-opacity-10 rounded-full transition duration-150" title="Sign Out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- WhatsApp-style Navigation Tabs -->
            <div class="bg-white border-b flex-shrink-0">
                <div class="flex">
                    <button onclick="switchTab('status')" id="status-tab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 hover:text-green-600 border-b-2 border-transparent hover:border-green-500 transition duration-150">
                        Status
                    </button>
                    <button onclick="switchTab('chats')" id="chats-tab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 hover:text-green-600 border-b-2 border-transparent hover:border-green-500 transition duration-150">
                        Chats
                    </button>
                    <button onclick="switchTab('contacts')" id="contacts-tab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 hover:text-green-600 border-b-2 border-transparent hover:border-green-500 transition duration-150">
                        Contacts
                    </button>
                    <button onclick="switchTab('groups')" id="groups-tab" class="flex-1 py-3 px-4 text-center font-medium text-gray-600 hover:text-green-600 border-b-2 border-transparent hover:border-green-500 transition duration-150">
                        Groups
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="p-2 border-b bg-white flex-shrink-0">
                <div class="relative">
                    <input id="chat-search-input" type="text" placeholder="Search chats, contacts, and groups..." class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" oninput="window.handleChatSearch(this.value)" onkeyup="window.handleChatSearch(this.value)">
                    <button onclick="clearMainSearch()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition duration-150" title="Clear search">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div id="search-results-info" class="text-xs text-gray-500 mt-1 hidden">
                    <span id="search-results-count">0</span> results found
                </div>
            </div>

            <!-- Status Tab Content -->
            <div id="status-content" class="flex-grow overflow-y-auto hidden">
                <div id="status-list" class="h-full">
                    <!-- My Status -->
                    <div class="p-3 border-b border-gray-100">
                        <div onclick="addMyStatus()" class="flex items-center p-2 cursor-pointer hover:bg-gray-50 rounded-lg transition duration-150">
                            <div class="relative">
                                <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg mr-3 overflow-hidden">
                                    <span id="my-status-avatar">+</span>
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center border-2 border-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">My Status</h3>
                                <p class="text-sm text-gray-500">Tap to add status update</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Updates -->
                    <div class="p-3">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">Recent Updates</h4>
                        <div id="status-updates-list">
                            <div class="p-3 text-center text-gray-500">No status updates yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chats Tab Content -->
            <div id="chats-content" class="flex-grow overflow-y-auto">
                <div id="chats-list" class="h-full">
                    <div class="p-3 text-center text-gray-500">Loading chats...</div>
                </div>
            </div>

            <!-- Contacts Tab Content -->
            <div id="contacts-content" class="flex-grow overflow-y-auto hidden">
                <div id="contacts-list" class="h-full">
                    <div class="p-3 text-center text-gray-500">Loading contacts...</div>
                </div>
            </div>

            <!-- Groups Tab Content -->
            <div id="groups-content" class="flex-grow overflow-y-auto hidden">
                <div id="groups-list" class="h-full">
                    <div class="p-3 text-center text-gray-500">Loading groups...</div>
                </div>
            </div>
            
            <!-- Action Bar -->
            <div class="p-3 border-t bg-white flex justify-around flex-shrink-0">
                <button onclick="showAddContactModal()" class="flex items-center text-whatsapp-green hover:text-green-700 font-semibold">
                    <!-- Add Contact -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                    Add Contact
                </button>
                <button onclick="showNewGroupModal()" class="flex items-center text-whatsapp-green hover:text-green-700 font-semibold">
                    <!-- New Group -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    New Group
                </button>
            </div>
        </div>

        <!-- RIGHT PANEL: Chat View / Profile Settings -->
        <div id="right-panel" class="right-panel">
            
            <!-- Loading Indicator (for file uploads) -->
            <div id="loading-indicator" class="hidden bg-yellow-500 text-white p-2 text-center text-sm absolute top-0 w-full z-20">
                <span id="loading-text"></span> (Please wait...)
            </div>

            <!-- CHAT VIEW -->
            <div id="chat-view" class="flex flex-col flex-grow h-full">

                <!-- Chat Header - WhatsApp Style -->
                <div class="header-bg chat-header-mobile flex justify-between items-center text-white shadow-md flex-shrink-0 px-4 py-3">
                    <div class="flex items-center">
                        <!-- Back button for mobile -->
                        <button onclick="navigateTo('contacts')" class="sm:hidden mr-3 p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <span id="chat-avatar" class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-white font-bold text-lg mr-3 overflow-hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </span>
                        <div class="flex flex-col">
                            <h1 id="chat-partner-name" class="text-lg font-semibold text-white">Select a Chat</h1>
                            <span class="text-xs opacity-70 text-white sm:hidden">WhatsApp</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Voice Call Button -->
                        <button onclick="startVoiceCall()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150" title="Voice call">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </button>
                        <!-- Video Call Button -->
                        <button onclick="startVideoCall()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150" title="Video call">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="23 7 16 12 23 17 23 7"/>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                            </svg>
                        </button>
                        <!-- Search Button -->
                        <button onclick="toggleChatMessageSearch()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150" title="Search messages">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="M21 21l-4.35-4.35"></path>
                            </svg>
                        </button>
                        <!-- Share Button for Mobile in Chat Header -->
                        <button onclick="shareApp()" class="sm:hidden p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150" title="Share App">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                        </button>
                        <div class="relative">
                            <button onclick="toggleChatActions()" class="p-2 rounded-full hover:bg-white hover:bg-opacity-10 transition duration-150" title="Chat actions">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </button>
                            <div id="chat-actions-menu" class="hidden absolute right-0 mt-2 bg-white text-gray-700 rounded shadow-lg z-30 min-w-[200px]">
                                <button onclick="shareApp()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Share App</button>
                                <button onclick="handleBackupChat()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Backup / Export JSON</button>
                                <button onclick="handleDeleteChat()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm text-red-600">Delete Chat</button>
                                <button onclick="showAddMembersModal()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Add Members (Group)</button>
                                <button onclick="showChangeGroupPhoto()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Change Group Photo</button>
                            </div>
                        </div>
                        <div class="text-xs opacity-70 text-white hidden sm:block">UID: <span id="user-id-display">...</span></div>
                    </div>
                </div>

                <!-- Chat Search Bar (hidden by default) -->
                <div id="chat-message-search-bar" class="hidden bg-white border-b flex-shrink-0 p-3">
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleChatMessageSearch()" class="p-2 text-gray-500 hover:text-gray-700 transition duration-150" title="Close search">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                        <input id="chat-message-search-input" type="text" placeholder="Search in this chat..." 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" 
                               oninput="handleChatMessageSearch(this.value)">
                        <button onclick="clearChatMessageSearch()" class="p-2 text-gray-500 hover:text-gray-700 transition duration-150" title="Clear search">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="chat-search-results" class="mt-2 text-sm text-gray-600 hidden">
                        <span id="search-results-count">0</span> results found
                    </div>
                </div>

                <!-- Message Display Area -->
                <div id="message-display" class="flex-grow flex flex-col space-y-2">
                    <div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>
                </div>

                <!-- Input Area - WhatsApp Style -->
                <div id="chat-input-area" class="border-t bg-white flex-shrink-0">
                    
                    <!-- Hidden File Inputs -->
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleFileSelect('image')">
                    <input type="file" id="video-input" accept="video/*" class="hidden" onchange="handleFileSelect('video')">
                    <input type="file" id="document-input" accept="*/*" class="hidden" onchange="handleFileSelect('document')">
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect('camera')">

                    <!-- WhatsApp-style Message Input Container -->
                    <div class="message-input-container">
                        
                        <!-- Emoji Button -->
                        <button onclick="window.toggleEmojiPanel()" class="emoji-btn" title="Emojis">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </button>

                        <!-- Attachment Button with Menu -->
                        <div class="relative">
                            <button onclick="toggleAttachmentMenu()" class="attachment-btn" title="Attach">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49"/>
                                </svg>
                            </button>
                            
                            <!-- Attachment Menu -->
                            <div id="attachment-menu" class="attachment-menu hidden">
                                <div class="attachment-menu-item" onclick="selectPhotosAndVideos()">
                                    <div class="attachment-menu-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </div>
                                    <div class="attachment-menu-text">Photos & videos</div>
                                </div>
                                
                                <div class="attachment-menu-item" onclick="openCamera()">
                                    <div class="attachment-menu-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                            <circle cx="12" cy="13" r="4"/>
                                        </svg>
                                    </div>
                                    <div class="attachment-menu-text">Camera</div>
                                </div>
                                
                                <div class="attachment-menu-item" onclick="selectDocument()">
                                    <div class="attachment-menu-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                            <line x1="16" y1="13" x2="8" y2="13"/>
                                            <line x1="16" y1="17" x2="8" y2="17"/>
                                            <polyline points="10 9 9 9 8 9"/>
                                        </svg>
                                    </div>
                                    <div class="attachment-menu-text">Document</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <input type="text" id="message-input" placeholder="Type a message" 
                               class="message-input" 
                               onkeyup="if(event.key === 'Enter') handleSendText()"
                               oninput="updateMessageButtons()">

                        <!-- Microphone Button (shown when input is empty) -->
                        <button id="mic-button" onclick="startRecording()" class="mic-btn" title="Record">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                            </svg>
                        </button>

                        <!-- Send Button (hidden by default, shown when input has text) -->
                        <button id="send-button" onclick="handleSendText()" class="send-btn hidden" title="Send">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>

                        <!-- Record Button (hidden by default) -->
                        <button id="record-button" onclick="startRecording()" class="send-btn hidden" title="Record">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="21" x2="12" y2="23"/>
                            </svg>
                        </button>

                        <!-- Stop Recording Button (hidden by default) -->
                        <button id="stop-record-button" onclick="stopRecording()" class="send-btn hidden" style="background-color: #dc2626;" title="Stop">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="6" width="12" height="12" rx="2" ry="2"/>
                            </svg>
                        </button>

                        <!-- Loading Indicator (hidden by default) -->
                        <div id="loading-indicator" class="send-btn hidden flex items-center justify-center" style="background-color: #6b7280;" title="Uploading...">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Loading Text -->
                    <div id="loading-text" class="hidden text-sm text-gray-500 text-center mt-2"></div>
                </div>

            </div>
            
            <!-- Emoji Panel -->
            <div id="emoji-panel" class="hidden absolute bottom-24 left-4 bg-white border rounded-lg shadow-lg p-2 max-w-sm w-72 z-20">
                <div class="grid grid-cols-8 gap-1 text-xl">
                    <button class="p-1" onclick="window.insertEmoji('😀')">😀</button>
                    <button class="p-1" onclick="window.insertEmoji('😂')">😂</button>
                    <button class="p-1" onclick="window.insertEmoji('😊')">😊</button>
                    <button class="p-1" onclick="window.insertEmoji('😍')">😍</button>
                    <button class="p-1" onclick="window.insertEmoji('😎')">😎</button>
                    <button class="p-1" onclick="window.insertEmoji('😉')">😉</button>
                    <button class="p-1" onclick="window.insertEmoji('😇')">😇</button>
                    <button class="p-1" onclick="window.insertEmoji('🤔')">🤔</button>
                    <button class="p-1" onclick="window.insertEmoji('😅')">😅</button>
                    <button class="p-1" onclick="window.insertEmoji('🥳')">🥳</button>
                    <button class="p-1" onclick="window.insertEmoji('🤩')">🤩</button>
                    <button class="p-1" onclick="window.insertEmoji('😢')">😢</button>
                    <button class="p-1" onclick="window.insertEmoji('😭')">😭</button>
                    <button class="p-1" onclick="window.insertEmoji('😤')">😤</button>
                    <button class="p-1" onclick="window.insertEmoji('❤️')">❤️</button>
                    <button class="p-1" onclick="window.insertEmoji('👍')">👍</button>
                    <button class="p-1" onclick="window.insertEmoji('👉')">👉</button>
                    <button class="p-1" onclick="window.insertEmoji('➡️')">➡️</button>
                    <button class="p-1" onclick="window.insertEmoji('✅')">✅</button>
                    <button class="p-1" onclick="window.insertEmoji('✔️')">✔️</button>
                    <button class="p-1" onclick="window.insertEmoji('☑️')">☑️</button>
                    <button class="p-1" onclick="window.insertEmoji('🙏')">🙏</button>
                    <button class="p-1" onclick="window.insertEmoji('🔥')">🔥</button>
                    <button class="p-1" onclick="window.insertEmoji('🎉')">🎉</button>
                    <button class="p-1" onclick="window.insertEmoji('💯')">💯</button>
                    <button class="p-1" onclick="window.insertEmoji('🌟')">🌟</button>
                    <button class="p-1" onclick="window.insertEmoji('🍕')">🍕</button>
                    <button class="p-1" onclick="window.insertEmoji('☕')">☕</button>
                    <button class="p-1" onclick="window.insertEmoji('✈️')">✈️</button>
                </div>
            </div>

            <!-- Sticker Panel -->
            <div id="sticker-panel" class="hidden absolute bottom-24 left-24 bg-white border rounded-lg shadow-lg p-2 max-w-md w-80 z-20">
                <div class="grid grid-cols-4 gap-2">
                    <!-- Right thumb sticker (teal) -->
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'><rect width='256' height='256' rx='30' ry='30' fill='%23e6f7f1'/><path d='M60 140h48l26-54c6-12 22-8 22 6v48h24c10 0 18 8 18 18 0 10-8 18-18 18h-80c-12 0-22-10-22-22v-14z' fill='%23128C7E'/></svg>" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <!-- Done/Check sticker (green tick) -->
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'><rect width='256' height='256' rx='30' ry='30' fill='%23eaf7ea'/><circle cx='128' cy='128' r='96' fill='%23cdeed2'/><path d='M86 130l22 22 62-62' fill='none' stroke='%23128C7E' stroke-width='16' stroke-linecap='round' stroke-linejoin='round'/></svg>" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/0r8ZK8C.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/7uZ8cE1.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/3bEfd0q.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/2mFQF7f.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/5H0x3wT.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/HhWJk2M.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/5Gk7oQy.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/0m8UQ1n.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                </div>
            </div>
            
            <!-- PROFILE SETTINGS VIEW -->
            <div id="profile-settings-view" class="p-8 bg-gray-50 flex-col items-center justify-start h-full hidden">
                <div class="w-full max-w-lg mx-auto">
                    <button onclick="navigateTo('contacts')" class="text-whatsapp-green mb-4 flex items-center hover:text-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Back to Chats
                    </button>
                    <h2 class="text-3xl font-bold mb-6 text-center" style="color: var(--whatsapp-green);">Profile Settings</h2>

                    <div class="flex flex-col items-center mb-8">
                        <div id="profile-avatar" class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-3xl mb-4 overflow-hidden">
                            <!-- Placeholder for Profile Picture -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <p class="text-sm text-gray-600">Your Full UID:</p>
                        <p id="profile-uid-display" class="font-mono text-sm text-gray-800 break-all"></p>
                    </div>

                    <div class="space-y-4">
                        <label for="current-profile-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                        <input type="text" id="current-profile-name" placeholder="Enter your name"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <div class="flex items-center space-x-3">
                            <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="handleUploadProfilePicture()">
                            <button onclick="document.getElementById('profile-picture-input').click()"
                                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Change Photo</button>
                        </div>
                        
                        <button onclick="handleUpdateProfile()"
                                class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                                style="background-color: var(--whatsapp-light-green);">
                            Save Profile
                        </button>
                        <p id="profile-status-message" class="text-sm text-center text-green-600 h-4"></p>
                    </div>
                </div>
            </div>

        </div> <!-- End Right Panel -->
    </div>

    <!-- ADD MEMBERS TO GROUP MODAL -->
    <div id="add-members-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Add Members</h3>
            <div id="add-members-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg mb-4 bg-gray-50"></div>
            <p id="add-members-status" class="text-sm text-red-500 h-5 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideAddMembersModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button onclick="handleAddMembersToGroup()" class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200" style="background-color: var(--whatsapp-light-green);">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- CHANGE GROUP PHOTO (owner only) -->
    <input type="file" id="change-group-photo-input" accept="image/*" class="hidden">

    <!-- CALL INTERFACE -->
    <div id="call-interface" class="fixed inset-0 z-50 bg-black hidden">
        <!-- Call Header -->
        <div class="absolute top-0 left-0 right-0 z-10 bg-gradient-to-b from-black/50 to-transparent p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button onclick="endCall()" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <div>
                        <h2 id="call-contact-name" class="text-white text-lg font-semibold">Contact Name</h2>
                        <p id="call-status" class="text-white/70 text-sm">Connecting...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="mute-button" onclick="toggleMute()" class="p-3 rounded-full bg-white/20 hover:bg-white/30 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                    </button>
                    <button id="video-toggle-button" onclick="toggleVideo()" class="p-3 rounded-full bg-white/20 hover:bg-white/30 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"/>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Streams -->
        <div class="flex-1 flex items-center justify-center relative">
            <!-- Remote Video (Partner's video) -->
            <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline></video>
            
            <!-- Local Video (Your video) - Picture in Picture -->
            <video id="local-video" class="absolute top-4 right-4 w-32 h-24 object-cover rounded-lg border-2 border-white/30" autoplay playsinline muted></video>
            
            <!-- Call Status Overlay -->
            <div id="call-status-overlay" class="absolute inset-0 flex items-center justify-center bg-black/50">
                <div class="text-center text-white">
                    <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-white/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <h3 id="call-status-text" class="text-xl font-semibold mb-2">Connecting...</h3>
                    <p id="call-timer" class="text-white/70">00:00</p>
                </div>
            </div>
        </div>

        <!-- Call Controls -->
        <div class="absolute bottom-0 left-0 right-0 z-10 bg-gradient-to-t from-black/50 to-transparent p-6">
            <div class="flex items-center justify-center space-x-6">
                <!-- Mute Button -->
                <button id="call-mute-button" onclick="toggleMute()" class="p-4 rounded-full bg-white/20 hover:bg-white/30 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    </svg>
                </button>
                
                <!-- Video Toggle Button -->
                <button id="call-video-button" onclick="toggleVideo()" class="p-4 rounded-full bg-white/20 hover:bg-white/30 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </button>
                
                <!-- End Call Button -->
                <button onclick="endCall()" class="p-4 rounded-full bg-red-600 hover:bg-red-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- INCOMING CALL NOTIFICATION -->
    <div id="incoming-call-notification" class="fixed inset-0 z-50 bg-black/80 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                </div>
                <h3 id="incoming-call-name" class="text-xl font-semibold mb-2">Incoming Call</h3>
                <p id="incoming-call-type" class="text-gray-600 mb-6">Voice Call</p>
                <div class="flex space-x-4">
                    <button onclick="declineCall()" class="flex-1 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-150">
                        Decline
                    </button>
                    <button onclick="acceptCall()" class="flex-1 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition duration-150">
                        Accept
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script to manage button visibility (Send vs. Record) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('message-input');

            // Initial state: Show record button, hide send button
            updateMessageButtons();

            messageInput.addEventListener('input', updateMessageButtons);

            // Make sure media buttons handle visibility correctly after recording logic
            const originalStopRecording = window.stopRecording;
            window.stopRecording = function() {
                originalStopRecording();
                // A small delay to allow the async upload process to start before resetting UI
                setTimeout(updateMessageButtons, 500);
            }
        });
        
        // Ensure the layout renders correctly on resize
        window.addEventListener('resize', () => {
            // Check for both existence and authentication status
            if (typeof window.auth !== 'undefined' && window.auth.currentUser) {
                renderApp();
            }
        });

        // ===== CHAT MESSAGE SEARCH FUNCTIONALITY =====
        let allMessages = []; // Store all messages for search
        let isSearching = false;

        /**
         * Toggle the chat message search bar
         */
        window.toggleChatMessageSearch = function() {
            const searchBar = document.getElementById('chat-message-search-bar');
            const searchInput = document.getElementById('chat-message-search-input');
            
            if (searchBar.classList.contains('hidden')) {
                // Show search bar
                searchBar.classList.remove('hidden');
                searchInput.focus();
                isSearching = true;
            } else {
                // Hide search bar
                searchBar.classList.add('hidden');
                clearChatMessageSearch();
                isSearching = false;
            }
        };

        /**
         * Clear the chat message search
         */
        window.clearChatMessageSearch = function() {
            const searchInput = document.getElementById('chat-message-search-input');
            const searchResults = document.getElementById('chat-search-results');
            
            searchInput.value = '';
            searchResults.classList.add('hidden');
            
            // Restore all messages
            if (allMessages.length > 0) {
                renderMessages(allMessages);
            }
        };

        /**
         * Handle chat message search
         */
        window.handleChatMessageSearch = function(searchTerm) {
            const searchResults = document.getElementById('chat-search-results');
            const resultsCount = document.getElementById('search-results-count');
            
            if (!searchTerm || searchTerm.trim() === '') {
                searchResults.classList.add('hidden');
                // Restore all messages
                if (allMessages.length > 0) {
                    renderMessages(allMessages);
                }
                return;
            }
            
            // Filter messages that contain the search term
            const filteredMessages = allMessages.filter(msg => {
                if (msg.type === 'text' && msg.content) {
                    return msg.content.toLowerCase().includes(searchTerm.toLowerCase());
                }
                return false;
            });
            
            // Update results count
            resultsCount.textContent = filteredMessages.length;
            searchResults.classList.remove('hidden');
            
            // Render filtered messages
            renderMessages(filteredMessages);
        };

        /**
         * Store messages for search functionality
         */
        function storeMessagesForSearch(messages) {
            allMessages = messages;
        }

        // Override the renderMessages function to store messages for search
        const originalRenderMessages = window.renderMessages;
        window.renderMessages = function(messages) {
            // Store messages for search if not currently searching
            if (!isSearching) {
                storeMessagesForSearch(messages);
            }
            
            // Call the original function
            return originalRenderMessages(messages);
        };

        // ===== CALL & VIDEO CALL FUNCTIONALITY =====
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callState = 'idle'; // idle, calling, ringing, connected, ended
        let callTimer = null;
        let callStartTime = null;
        let isMuted = false;
        let isVideoEnabled = true;
        let currentCallType = 'voice'; // voice or video

        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        /**
         * Start a voice call
         */
        window.startVoiceCall = async function() {
            if (!selectedChat || selectedChat.type === 'group') {
                displayError('Voice calls are only available for individual contacts');
                return;
            }
            
            currentCallType = 'voice';
            await initiateCall();
        };

        /**
         * Start a video call
         */
        window.startVideoCall = async function() {
            if (!selectedChat || selectedChat.type === 'group') {
                displayError('Video calls are only available for individual contacts');
                return;
            }
            
            currentCallType = 'video';
            await initiateCall();
        };

        /**
         * Initiate a call
         */
        async function initiateCall() {
            try {
                // Request media permissions
                const constraints = {
                    audio: true,
                    video: currentCallType === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set up call interface
                setupCallInterface();
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Set up remote stream handling
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    const remoteVideo = document.getElementById('remote-video');
                    remoteVideo.srcObject = remoteStream;
                };
                
                // Set up ICE candidate handling
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // In a real app, you would send this to the other user via Firebase
                        console.log('ICE candidate:', event.candidate);
                    }
                };
                
                // Update call state
                callState = 'calling';
                updateCallStatus('Calling...');
                
                // Show call interface
                document.getElementById('call-interface').classList.remove('hidden');
                
                // In a real app, you would send a call invitation to the other user via Firebase
                // For demo purposes, we'll simulate the call being answered after 3 seconds
                setTimeout(() => {
                    simulateCallAnswered();
                }, 3000);
                
            } catch (error) {
                console.error('Error starting call:', error);
                displayError('Failed to start call. Please check your camera and microphone permissions.');
                endCall();
            }
        }

        /**
         * Simulate call being answered (for demo purposes)
         */
        function simulateCallAnswered() {
            if (callState === 'calling') {
                callState = 'connected';
                updateCallStatus('Connected');
                startCallTimer();
                hideCallStatusOverlay();
            }
        }

        /**
         * Accept an incoming call
         */
        window.acceptCall = async function() {
            try {
                // Request media permissions
                const constraints = {
                    audio: true,
                    video: currentCallType === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Hide incoming call notification
                document.getElementById('incoming-call-notification').classList.add('hidden');
                
                // Show call interface
                setupCallInterface();
                document.getElementById('call-interface').classList.remove('hidden');
                
                callState = 'connected';
                updateCallStatus('Connected');
                startCallTimer();
                hideCallStatusOverlay();
                
            } catch (error) {
                console.error('Error accepting call:', error);
                displayError('Failed to accept call. Please check your camera and microphone permissions.');
                endCall();
            }
        };

        /**
         * Decline an incoming call
         */
        window.declineCall = function() {
            document.getElementById('incoming-call-notification').classList.add('hidden');
            callState = 'ended';
            // In a real app, you would notify the caller that the call was declined
        };

        /**
         * End the current call
         */
        window.endCall = function() {
            // Stop all tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Stop call timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Hide call interface
            document.getElementById('call-interface').classList.add('hidden');
            document.getElementById('incoming-call-notification').classList.add('hidden');
            
            // Reset call state
            callState = 'idle';
            callStartTime = null;
            isMuted = false;
            isVideoEnabled = true;
            
            // Clear video elements
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('local-video').srcObject = null;
            
            // In a real app, you would notify the other user that the call ended
        };

        /**
         * Toggle mute/unmute
         */
        window.toggleMute = function() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    updateMuteButton();
                }
            }
        };

        /**
         * Toggle video on/off
         */
        window.toggleVideo = function() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoEnabled = videoTrack.enabled;
                    updateVideoButton();
                    
                    // Show/hide local video
                    const localVideo = document.getElementById('local-video');
                    if (isVideoEnabled) {
                        localVideo.style.display = 'block';
                    } else {
                        localVideo.style.display = 'none';
                    }
                }
            }
        };

        /**
         * Set up the call interface
         */
        function setupCallInterface() {
            // Set contact name
            const contactName = selectedChat ? selectedChat.name : 'Unknown';
            document.getElementById('call-contact-name').textContent = contactName;
            
            // Set up local video
            const localVideo = document.getElementById('local-video');
            localVideo.srcObject = localStream;
            
            // Update buttons
            updateMuteButton();
            updateVideoButton();
            
            // Show/hide video elements based on call type
            if (currentCallType === 'voice') {
                localVideo.style.display = 'none';
                document.getElementById('remote-video').style.display = 'none';
            } else {
                localVideo.style.display = 'block';
                document.getElementById('remote-video').style.display = 'block';
            }
        }

        /**
         * Update call status
         */
        function updateCallStatus(status) {
            document.getElementById('call-status').textContent = status;
            document.getElementById('call-status-text').textContent = status;
        }

        /**
         * Hide call status overlay
         */
        function hideCallStatusOverlay() {
            document.getElementById('call-status-overlay').style.display = 'none';
        }

        /**
         * Start call timer
         */
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('call-timer').textContent = timeString;
            }, 1000);
        }

        /**
         * Update mute button appearance
         */
        function updateMuteButton() {
            const muteButtons = document.querySelectorAll('#mute-button, #call-mute-button');
            muteButtons.forEach(button => {
                if (isMuted) {
                    button.classList.add('bg-red-500');
                    button.classList.remove('bg-white/20');
                } else {
                    button.classList.remove('bg-red-500');
                    button.classList.add('bg-white/20');
                }
            });
        }

        /**
         * Update video button appearance
         */
        function updateVideoButton() {
            const videoButtons = document.querySelectorAll('#video-toggle-button, #call-video-button');
            videoButtons.forEach(button => {
                if (!isVideoEnabled) {
                    button.classList.add('bg-red-500');
                    button.classList.remove('bg-white/20');
                } else {
                    button.classList.remove('bg-red-500');
                    button.classList.add('bg-white/20');
                }
            });
        }

        /**
         * Simulate incoming call (for demo purposes)
         */
        function simulateIncomingCall() {
            if (callState === 'idle' && selectedChat) {
                currentCallType = Math.random() > 0.5 ? 'voice' : 'video';
                
                document.getElementById('incoming-call-name').textContent = selectedChat.name;
                document.getElementById('incoming-call-type').textContent = currentCallType === 'voice' ? 'Voice Call' : 'Video Call';
                
                document.getElementById('incoming-call-notification').classList.remove('hidden');
                
                // Auto-decline after 30 seconds
                setTimeout(() => {
                    if (callState === 'idle') {
                        declineCall();
                    }
                }, 30000);
            }
        }

        // Add keyboard shortcuts for call controls
        document.addEventListener('keydown', (event) => {
            if (callState === 'connected') {
                switch(event.key) {
                    case 'm':
                    case 'M':
                        toggleMute();
                        break;
                    case 'v':
                    case 'V':
                        if (currentCallType === 'video') {
                            toggleVideo();
                        }
                        break;
                    case 'Escape':
                        endCall();
                        break;
                }
            }
        });

        // Global mobile initialization - ensures perfect mobile experience
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're on mobile and start scroll monitoring
            if (window.innerWidth <= 768) {
                console.log('📱 Mobile detected on page load - initializing mobile system...');
                
                // Request notification permission for mobile
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        console.log('📱 Requesting notification permission on page load...');
                        Notification.requestPermission().then(permission => {
                            console.log('📱 Notification permission:', permission);
                            if (permission === 'granted') {
                                console.log('📱 Notifications enabled for mobile');
                            }
                        });
                    } else if (Notification.permission === 'granted') {
                        console.log('📱 Notifications already enabled');
                    } else {
                        console.log('📱 Notifications denied by user');
                    }
                } else {
                    console.log('📱 Notifications not supported on this device');
                }
                
                // Start mobile scroll monitor immediately
                setTimeout(() => {
                    startMobileScrollMonitor();
                }, 1000);
                
                // Also add a global scroll trigger for any chat that gets opened
                const originalStartChatListener = window.startChatListener;
                window.startChatListener = function(chatId) {
                    originalStartChatListener(chatId);
                    
                    // Ensure mobile scroll works for any chat
                    if (window.innerWidth <= 768) {
                        setTimeout(() => {
                            const display = document.getElementById('message-display');
                            if (display) {
                                display.scrollTop = display.scrollHeight;
                            }
                        }, 100);
                    }
                };
            }
        });

        // Also trigger on window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                console.log('📱 Mobile resize detected - ensuring scroll system is active...');
                startMobileScrollMonitor();
            } else {
                stopMobileScrollMonitor();
            }
        });

    </script>
</body>
</html>

</html>
