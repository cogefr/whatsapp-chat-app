<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --whatsapp-green: #075E54;
            --whatsapp-light-green: #128C7E;
            --message-bg-sender: #DCF8C6;
            --message-bg-receiver: #FFFFFF;
            --bg-body: #ECE5DD;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
        }
        /* Full height for auth screen */
        #auth-container {
            min-height: 100vh;
            background-color: var(--bg-body);
        }
        .auth-card {
            background-color: white;
            padding: 2.5rem;
            max-width: 400px;
            width: 90%;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .app-main-container {
            max-width: 1200px;
            height: 95vh;
            margin: 0 auto;
            border: 1px solid #ccc;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex; /* Enable flex for split view */
        }
        .header-bg {
            background-color: var(--whatsapp-green);
        }
        .sender-bubble {
            background-color: var(--message-bg-sender);
            border-radius: 10px 10px 0 10px;
            max-width: 80%;
            padding: 8px 10px;
            word-wrap: break-word;
        }
        .receiver-bubble {
            background-color: var(--message-bg-receiver);
            border-radius: 10px 10px 10px 0;
            max-width: 80%;
            padding: 8px 10px;
            word-wrap: break-word;
        }
        #message-display {
            overflow-y: auto;
            height: calc(100% - 78px); /* Adjusted for new chat layout */
            padding: 16px;
            /* WhatsApp-like light green + cream doodle pattern */
            background-color: #f7f5ef; /* soft cream */
            background-image: 
                linear-gradient(135deg, #f9f7f2 0%, #eaf7ea 100%),
                url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='360' height='360' viewBox='0 0 360 360'><defs><pattern id='doodles' width='180' height='180' patternUnits='userSpaceOnUse'><g fill='none' stroke='%2374b49b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' opacity='0.45'><path d='M20 20c0-8 12-8 12 0s-12 8-12 0z'/><path d='M52 22l14 8-14 8z'/><path d='M86 18h20v14H86z'/><path d='M130 15a10 10 0 1 0 0.1 0z'/><path d='M18 70l22-6 22 6-22 6z'/><path d='M74 64c8 0 8 12 0 12s-8-12 0-12z'/><path d='M110 60l10 10 10-10'/><path d='M148 50v20'/><path d='M26 118c10-8 26-8 36 0M26 130c10-8 26-8 36 0'/><path d='M80 112l10 22h-20z'/><path d='M114 110h28v16H114z m6-6h16'/><path d='M150 106l14 6-6 14-14-6z'/></g></pattern></defs><rect width='100%' height='100%' fill='transparent'/><rect width='100%' height='100%' fill='url(%23doodles)'/></svg>");
            background-size: cover, 520px 520px; /* gradient cover + crisp pattern */
            background-attachment: fixed, fixed;
        }
        .media-button {
            transition: all 0.2s;
        }
        .media-button:hover {
            transform: scale(1.1);
        }
        .recording-indicator {
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        /* Responsive Split View */
        .left-panel {
            width: 35%;
            min-width: 300px;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow-y: hidden; /* Main panel overflow handled by children */
        }
        .right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 768px) {
            .app-main-container {
                height: 100vh;
                box-shadow: none;
                border: none;
            }
            .left-panel {
                width: 100%;
                min-width: unset;
                border-right: none;
            }
            .right-panel {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                z-index: 10; /* Bring chat view to front */
            }
            #message-display {
                height: calc(100vh - 78px);
            }
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
    <!-- Firebase Compat (non-ESM) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        // Enable verbose Firestore logs
        if (firebase && firebase.firestore && firebase.firestore.setLogLevel) {
            firebase.firestore.setLogLevel('debug');
        }

        // === Modular API compatibility wrappers (map to compat SDK) ===
        const initializeApp = (config) => firebase.initializeApp(config);
        const getFirestore = (app) => firebase.firestore();
        const getAuth = (app) => firebase.auth();
        const signInWithEmailAndPassword = (auth, email, password) => firebase.auth().signInWithEmailAndPassword(email, password);
        const createUserWithEmailAndPassword = (auth, email, password) => firebase.auth().createUserWithEmailAndPassword(email, password);
        const onAuthStateChanged = (auth, cb) => firebase.auth().onAuthStateChanged(cb);
        const signOut = (auth) => firebase.auth().signOut();
        const signInWithCustomToken = (auth, token) => firebase.auth().signInWithCustomToken(token);

        const serverTimestamp = () => firebase.firestore.FieldValue.serverTimestamp();
        const arrayUnion = (...args) => firebase.firestore.FieldValue.arrayUnion(...args);
        const arrayRemove = (...args) => firebase.firestore.FieldValue.arrayRemove(...args);
        const FieldPath = firebase.firestore.FieldPath;

        const collection = (db, ...segments) => db.collection(segments.join('/'));
        const doc = (db, ...segments) => db.doc(segments.join('/'));
        const setDoc = (ref, data) => ref.set(data);
        const addDoc = (colRef, data) => colRef.add(data);
        const updateDoc = (ref, data) => ref.update(data);
        const deleteDoc = (ref) => ref.delete();
        const getDoc = (ref) => ref.get();
        const getDocs = (q) => q.get();
        const where = (field, op, value) => ({ __type: 'where', field, op, value });
        const query = (ref, ...clauses) => {
            let q = ref;
            clauses.forEach(c => { if (c && c.__type === 'where') { q = q.where(c.field, c.op, c.value); } });
            return q;
        };
        const onSnapshot = (q, next, error) => q.onSnapshot(next, error);

        // === FIREBASE CONFIGURATION ===
        const userProvidedConfig = {
            apiKey: "AIzaSyBvK-1Stea6-28HAopJqII4k4f78iLPq9E",
            authDomain: "chatapptry-1164e.firebaseapp.com",
            projectId: "chatapptry-1164e",
            storageBucket: "chatapptry-1164e.firebasestorage.app",
            messagingSenderId: "506480059651",
            appId: "1:506480059651:web:1c3bf7e8d2e64fa456f536",
            measurementId: "G-K5G581E348"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-whatsapp-clone';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;
        let currentUserName = "User"; // Default name
        let currentUserPhotoUrl = null;
        let currentChatId = null; // ID of the currently active chat (1:1 or Group ID)
        let selectedChat = null; // Object {id, name, type, uid? } of the current conversation
        let currentContacts = []; // Array of user's contacts (for 1:1)
        let currentGroups = []; // Array of groups the user belongs to
        let currentView = 'contacts'; // FIX: Initialize currentView to prevent ReferenceError
        let chatSearchTerm = '';
        const userProfileCache = {}; // uid -> { name, photoURL }
        // Enforce Firebase-only (no local demo mode)
        const isDemoMode = false;

        let unsubscribeMessages = null; // To manage real-time message listener
        let unsubscribeContacts = null; // To manage real-time contacts listener
        let unsubscribeGroups = null; // To manage real-time groups listener

        window.mediaRecorder = null; 
        let audioChunks = [];

        // === CLOUDINARY CONFIGURATION START ===
        // !!! IMPORTANT: REPLACE THESE WITH YOUR CLOUDINARY CREDENTIALS !!!
        const CLOUDINARY_CLOUD_NAME = 'dbx4azfjo'; 
        const CLOUDINARY_UPLOAD_PRESET = 'cheque_uploads'; 
        // === CLOUDINARY CONFIGURATION END ===
        
        // ===================================
        // UTILITIES & NAVIGATION
        // ===================================

        function showChatScreen() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('chat-app-container').classList.remove('hidden');
            document.body.classList.remove('bg-gray-100', 'p-0', 'sm:p-4');
            renderApp(); // Render the initial view
        }

        function showAuthScreen() {
            document.getElementById('chat-app-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            document.body.classList.add('bg-gray-100', 'p-0', 'sm:p-4'); 
        }

        /**
         * Switches the application view and potentially sets a new chat.
         * @param {string} view - 'contacts', 'chat', 'profile'
         * @param {Object} chatObject - { id, name, type, uid? }
         */
        window.navigateTo = function(view, chatObject = null) {
            currentView = view;
            
            if (view === 'chat' && chatObject) {
                selectedChat = chatObject;
                
                if (selectedChat.type === 'contact') {
                    currentChatId = getPrivateChatId(currentUserId, selectedChat.uid);
                    document.getElementById('chat-partner-name').textContent = selectedChat.name;
                    // Load avatar for contact in header
                    loadUserPublicProfile(selectedChat.uid).then((p) => {
                        const avatar = document.getElementById('chat-avatar');
                        if (avatar && p && p.photoURL) {
                            avatar.innerHTML = `<img src="${p.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'">`;
                        } else if (avatar) {
                            avatar.innerHTML = defaultHeaderAvatarIcon();
                        }
                    });
                } else if (selectedChat.type === 'group') {
                    currentChatId = selectedChat.id;
                    document.getElementById('chat-partner-name').textContent = selectedChat.name + ' (Group)';
                    const avatar = document.getElementById('chat-avatar');
                    if (avatar) {
                        if (selectedChat.photoURL) {
                            avatar.innerHTML = `<img src="${selectedChat.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.style.display='none'">`;
                        } else {
                            avatar.innerHTML = defaultHeaderAvatarIcon();
                        }
                    }
                } else {
                    currentChatId = null;
                }
                
                // Clear and restart the message listener
                startChatListener(currentChatId);
                
                // Hide the left panel on mobile when navigating to chat
                const leftPanel = document.getElementById('left-panel');
                if (window.innerWidth <= 768) {
                    leftPanel.classList.add('hidden');
                }
            } else if (view === 'contacts') {
                // Show the left panel on mobile when navigating back to contacts
                if (window.innerWidth <= 768) {
                    const leftPanel = document.getElementById('left-panel');
                    leftPanel.classList.remove('hidden');
                }
            }
            
            renderApp();
        }

        function defaultHeaderAvatarIcon() {
            return `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
        }
        
        /**
         * Main render function to decide which view components to show/hide.
         */
        function renderApp() {
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const chatView = document.getElementById('chat-view');
            const profileView = document.getElementById('profile-settings-view');
            
            // Handle Responsive Display
            if (window.innerWidth <= 768) {
                // Mobile: Only show one full-screen panel
                leftPanel.classList.toggle('hidden', currentView !== 'contacts');
                chatView.classList.toggle('hidden', currentView !== 'chat');
                profileView.classList.toggle('hidden', currentView !== 'profile');
                rightPanel.classList.toggle('hidden', currentView === 'contacts');
                
            } else {
                // Desktop: Always show left panel, switch content in right panel
                leftPanel.classList.remove('hidden');
                chatView.classList.toggle('hidden', currentView !== 'chat');
                profileView.classList.toggle('hidden', currentView !== 'profile');
                rightPanel.classList.toggle('hidden', false);
            }
            
            if (currentView === 'profile') {
                renderProfileSettings();
            }

            // Update header button text
            document.getElementById('current-user-name-display').textContent = currentUserName;
        }

        // ===================================
        // FIREBASE AUTHENTICATION & PROFILES
        // ===================================

        async function initFirebase() {
            // Environment checks to improve mobile reliability (Android browsers/WebView)
            if (!navigator.onLine) {
                displayError('You appear to be offline. Check your internet connection.');
            }
            if (!firebaseConfig) {
                displayError('Firebase configuration is missing. Cannot initialize the application.');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Expose auth so environment checks and listeners that rely on it work consistently across devices
                window.auth = auth;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        await setupUserProfile(user);
                        startContactsListener(); // Start listening to real contacts
                        startGroupsListener(); // Start listening to groups
                        showChatScreen();
                        renderApp(); 
                    } else {
                        currentUserId = null;
                        currentChatId = null;
                        selectedChat = null;
                        if (unsubscribeMessages) unsubscribeMessages();
                        if (unsubscribeContacts) unsubscribeContacts();
                        if (unsubscribeGroups) unsubscribeGroups();
                        showAuthScreen();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                displayError(`Failed to initialize Firebase: ${error.message}`);
            }
        }
        
        /**
         * Ensures a user profile exists upon authentication and populates the public directory.
         */
        async function setupUserProfile(user) {
            const userProfileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, user.uid);
            
            let profile;
            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    profile = docSnap.data();
                    currentUserName = profile.name || `User-${user.uid.substring(0, 6)}`;
                    currentUserPhotoUrl = profile.photoURL || null;
                } else {
                    // Create initial profile if it doesn't exist
                    currentUserName = `User-${user.uid.substring(0, 6)}`;
                    profile = { 
                        uid: user.uid,
                        name: currentUserName, 
                        email: user.email || null,
                        createdAt: serverTimestamp(),
                        photoURL: null
                    };
                    await setDoc(userProfileRef, profile);
                }
                
                // Update or create the public directory entry
                await setDoc(userDirectoryRef, {
                    uid: user.uid,
                    name: currentUserName,
                    photoURL: currentUserPhotoUrl || null,
                });
                
                document.getElementById('user-id-display').textContent = currentUserId.substring(0, 8);
                document.getElementById('profile-uid-display').textContent = currentUserId; // Show full UID in profile
            } catch (error) {
                console.error("Error setting up user profile or directory:", error);
                displayError(`Profile setup failed: ${error.message}`);
            }
        }

        /**
         * Handles user sign-in.
         */
        window.handleSignIn = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) { displayError("Email and password are required."); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error-message').textContent = '';
            } catch (error) {
                const msg =
                    error.message.includes('auth/unauthorized-domain') ?
                        'Unauthorized domain. Add this domain in Firebase Console > Authentication > Settings > Authorized domains.' :
                    error.message.includes('auth/invalid-credential') ?
                        'Invalid Email or Password.' :
                    error.message;
                document.getElementById('auth-error-message').textContent = `Sign In Failed: ${msg}`;
                if (error.message.includes('auth/unauthorized-domain') || location.protocol === 'file:') {
                    displayError('Login blocked by environment. Host the file via HTTP/HTTPS (not file://) and add the domain to Firebase Authorized domains.');
                }
            }
        }

        /**
         * Handles user sign-up.
         */
        window.handleSignUp = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            if (!email || !password) { displayError("Email and password are required."); return; }
            if (password.length < 6) { document.getElementById('auth-error-message').textContent = "Password must be at least 6 characters."; return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById('auth-error-message').textContent = '';
            } catch (error) {
                const msg = error.message.includes('auth/unauthorized-domain') ?
                    'Unauthorized domain. Add this domain in Firebase Console > Authentication > Settings > Authorized domains.' : error.message;
                document.getElementById('auth-error-message').textContent = `Sign Up Failed: ${msg}`;
                if (error.message.includes('auth/unauthorized-domain') || location.protocol === 'file:') {
                    displayError('Sign up blocked by environment. Host the file via HTTP/HTTPS (not file://) and add the domain to Firebase Authorized domains.');
                }
            }
        }

        /**
         * Handles user sign-out.
         */
        window.handleSignOut = async function() {
            try {
                await signOut(auth);
                displayError("Signed out successfully.");
            } catch (error) {
                displayError(`Sign out failed: ${error.message}`);
            }
        }

        // ===================================
        // PROFILE SETTINGS LOGIC
        // ===================================

        function renderProfileSettings() {
            document.getElementById('current-profile-name').value = currentUserName;
            document.getElementById('profile-uid-display').textContent = currentUserId;
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar) {
                if (currentUserPhotoUrl) {
                    profileAvatar.innerHTML = `<img src="${currentUserPhotoUrl}" class="w-24 h-24 rounded-full object-cover" onerror="this.style.display='none'">`;
                }
            }
        }

        window.handleUpdateProfile = async function() {
            const newName = document.getElementById('current-profile-name').value.trim();
            const photoInput = document.getElementById('profile-picture-input');
            if (!newName) {
                displayError("Profile name cannot be empty.");
                return;
            }

            const userProfileRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, currentUserId);

            try {
                // 1. Update private profile
                const updates = { name: newName };
                if (currentUserPhotoUrl) updates.photoURL = currentUserPhotoUrl;
                await updateDoc(userProfileRef, updates);
                // 2. Update public directory
                const dirUpdates = { name: newName };
                if (currentUserPhotoUrl) dirUpdates.photoURL = currentUserPhotoUrl;
                await updateDoc(userDirectoryRef, dirUpdates);
                
                currentUserName = newName;
                document.getElementById('profile-status-message').textContent = "Profile updated successfully!";
                setTimeout(() => { document.getElementById('profile-status-message').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error updating profile:", error);
                document.getElementById('profile-status-message').textContent = "Failed to update profile.";
            }
        }

        window.handleUploadProfilePicture = async function() {
            const fileInput = document.getElementById('profile-picture-input');
            const file = fileInput.files && fileInput.files[0];
            if (!file) { displayError('Please choose a profile picture.'); return; }
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Uploading profile picture...';
            const url = await uploadToCloudinary(file, 'image');
            document.getElementById('loading-indicator').classList.add('hidden');
            if (!url) return;
            currentUserPhotoUrl = url;
            const userProfileRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profiles`, 'main');
            const userDirectoryRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, currentUserId);
            try {
                await updateDoc(userProfileRef, { photoURL: url });
                await updateDoc(userDirectoryRef, { photoURL: url });
                const profileAvatar = document.getElementById('profile-avatar');
                if (profileAvatar) {
                    profileAvatar.innerHTML = `<img src="${url}" class="w-24 h-24 rounded-full object-cover">`;
                }
                document.getElementById('profile-status-message').textContent = 'Photo updated!';
                setTimeout(() => { document.getElementById('profile-status-message').textContent = ''; }, 2000);
            } catch (e) {
                displayError('Failed to save profile picture: ' + e.message);
            }
        }

        // ===================================
        // CONTACTS & GROUP LIST LOGIC
        // ===================================

        function startContactsListener() {
            if (unsubscribeContacts) unsubscribeContacts();
            if (!currentUserId) return;

            // Path: /artifacts/{appId}/users/{userId}/contacts
            const contactsRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/contacts`);
            const q = query(contactsRef);

            unsubscribeContacts = onSnapshot(q, async (snapshot) => {
                currentContacts = [];
                const uidsToFetch = [];
                snapshot.forEach(doc => {
                    // Convert contact to a universal chat object type
                    currentContacts.push({ 
                        id: doc.id, 
                        name: doc.data().name, 
                        uid: doc.data().uid,
                        type: 'contact',
                        ...doc.data() 
                    });
                    if (!userProfileCache[doc.data().uid]) uidsToFetch.push(doc.data().uid);
                });
                // Load public profiles for contacts so avatars show to everyone
                await Promise.all(uidsToFetch.map(uid => loadUserPublicProfile(uid)));
                renderChatList();
            }, (error) => {
                console.error("Error listening to contacts:", error);
            });
        }
        
        function startGroupsListener() {
            if (unsubscribeGroups) unsubscribeGroups();
            if (!currentUserId) return;

            // Path: /artifacts/{appId}/public/data/group_directory
            const groupsRef = collection(db, `/artifacts/${appId}/public/data/group_directory`);
            // Query for groups where the current user is a member (requires 'members' field to be an array)
            const q = query(groupsRef, where('members', 'array-contains', currentUserId));

            unsubscribeGroups = onSnapshot(q, (snapshot) => {
                currentGroups = [];
                snapshot.forEach(doc => {
                    // Convert group to a universal chat object type
                    currentGroups.push({ 
                        id: doc.id, 
                        name: doc.data().name, 
                        type: 'group',
                        ...doc.data() 
                    });
                });
                renderChatList();
            }, (error) => {
                console.error("Error listening to groups:", error);
                displayError("Group list error: Check Firebase security rules for 'group_directory'.");
            });
        }

        function renderChatList() {
            const chatsListDiv = document.getElementById('chats-list');
            chatsListDiv.innerHTML = '';
            
            const term = (chatSearchTerm || '').toLowerCase();
            const allChats = [...currentGroups, ...currentContacts].filter(c => {
                if (!term) return true;
                const name = (c.name || '').toLowerCase();
                const uid = (c.uid || '').toLowerCase();
                return name.includes(term) || (uid && uid.startsWith(term));
            });
            
            if (allChats.length === 0) {
                 chatsListDiv.innerHTML = '<p class="p-4 text-center text-gray-500">No chats or groups. Add a contact or create a group!</p>';
                 return;
            }

            // Sort by a combination of creation/added time (or just alphabetically for simplicity)
            allChats.sort((a, b) => a.name.localeCompare(b.name));

            const chatItem = (chat) => {
                const isGroup = chat.type === 'group';
                const nameDisplay = chat.name + (isGroup ? ' (Group)' : (chat.uid === currentUserId ? ' (Self)' : ''));
                const subText = isGroup ? `${chat.members.length} members` : `UID: ${chat.uid.substring(0, 8)}...`;
                const profile = !isGroup && userProfileCache[chat.uid] ? userProfileCache[chat.uid] : null;
                const icon = isGroup ? 'ðŸ‘¥' : chat.name.charAt(0).toUpperCase();

                return `
                    <div onclick="navigateTo('chat', {id: '${chat.id}', name: '${chat.name}', uid: '${chat.uid || ''}', type: '${chat.type}'})"
                        class="flex items-center p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-150">
                        <div class="w-12 h-12 rounded-full ${isGroup ? 'bg-blue-400' : 'bg-gray-300'} flex items-center justify-center text-white font-bold text-lg mr-3 flex-shrink-0 overflow-hidden">
                            ${isGroup ? (chat.photoURL ? `<img src='${chat.photoURL}' class='w-full h-full object-cover' onerror=\"this.style.display='none'\">` : icon) : (profile && profile.photoURL ? `<img src='${profile.photoURL}' class='w-full h-full object-cover' onerror=\"this.style.display='none'\">` : icon)}
                        </div>
                        <div class="truncate">
                            <p class="font-semibold text-gray-800 truncate">${nameDisplay}</p>
                            <p class="text-xs text-gray-500">${subText}</p>
                        </div>
                    </div>
                `;
            };

            chatsListDiv.innerHTML = allChats.map(chatItem).join('');
        }

        // Search handler for chat list
        window.handleChatSearch = function(value) {
            chatSearchTerm = value || '';
            renderChatList();
        }

        async function loadUserPublicProfile(uid) {
            try {
                if (userProfileCache[uid]) return userProfileCache[uid];
                const ref = doc(db, `/artifacts/${appId}/public/data/user_directory`, uid);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    userProfileCache[uid] = { name: data.name, photoURL: data.photoURL || null };
                    return userProfileCache[uid];
                } else {
                    userProfileCache[uid] = { name: '', photoURL: null };
                    return userProfileCache[uid];
                }
            } catch (e) {
                console.warn('Failed to load public profile for', uid, e);
                return null;
            }
        }
        
        // ===================================
        // ADD CONTACT MODAL LOGIC (Unchanged)
        // ===================================

        window.showAddContactModal = function() {
            document.getElementById('add-contact-modal').classList.remove('hidden');
        }

        window.hideAddContactModal = function() {
            document.getElementById('add-contact-modal').classList.add('hidden');
            document.getElementById('add-contact-status').textContent = '';
            document.getElementById('contact-search-input').value = '';
        }

        window.handleAddContact = async function() {
            const targetUid = document.getElementById('contact-search-input').value.trim();
            const statusMessage = document.getElementById('add-contact-status');
            statusMessage.textContent = 'Searching...';

            if (!targetUid || targetUid.length < 8) {
                statusMessage.textContent = 'Please enter a valid User ID.';
                return;
            }
            if (targetUid === currentUserId) {
                statusMessage.textContent = 'You cannot add yourself.';
                return;
            }
            if (currentContacts.some(c => c.uid === targetUid)) {
                statusMessage.textContent = 'This user is already in your contacts.';
                return;
            }

            try {
                const targetRef = doc(db, `/artifacts/${appId}/public/data/user_directory`, targetUid);
                const targetSnap = await getDoc(targetRef);

                if (targetSnap.exists()) {
                    const targetUser = targetSnap.data();
                    
                    // Add the user to the current user's private contacts subcollection
                    const newContactRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/contacts`, targetUid);
                    await setDoc(newContactRef, {
                        uid: targetUser.uid,
                        name: targetUser.name,
                        addedAt: serverTimestamp()
                    });

                    statusMessage.textContent = `Success! Added ${targetUser.name} to your contacts.`;
                    document.getElementById('contact-search-input').value = '';
                    setTimeout(window.hideAddContactModal, 2000);

                } else {
                    statusMessage.textContent = 'User not found. Please check the UID.';
                }
            } catch (error) {
                console.error("Error adding contact:", error);
                statusMessage.textContent = 'An error occurred while adding the contact.';
            }
        }
        
        // ===================================
        // NEW GROUP MODAL LOGIC
        // ===================================
        
        window.showNewGroupModal = function() {
            const listContainer = document.getElementById('group-contact-list');
            listContainer.innerHTML = '';
            
            if (currentContacts.length === 0) {
                listContainer.innerHTML = '<p class="text-red-500 text-center">Please add at least one contact first to create a group.</p>';
                document.getElementById('create-group-button').classList.add('hidden');
            } else {
                document.getElementById('create-group-button').classList.remove('hidden');
                
                // Add the current user first (they are always a member)
                const selfCheck = `
                    <div class="flex items-center p-2 border-b border-gray-100">
                        <input type="checkbox" id="member-${currentUserId}" name="group-member" value="${currentUserId}" 
                                data-name="${currentUserName}" class="w-4 h-4 text-green-600 bg-gray-100 rounded focus:ring-green-500" 
                                checked disabled>
                        <label for="member-${currentUserId}" class="ml-3 font-semibold text-gray-800 flex-grow">
                            ${currentUserName} (You, Owner)
                        </label>
                    </div>
                `;
                listContainer.innerHTML += selfCheck;

                // Add contacts
                currentContacts.forEach(contact => {
                    const item = `
                        <div class="flex items-center p-2 border-b border-gray-100">
                            <input type="checkbox" id="member-${contact.uid}" name="group-member" value="${contact.uid}" 
                                    data-name="${contact.name}" class="w-4 h-4 text-green-600 bg-gray-100 rounded focus:ring-green-500">
                            <label for="member-${contact.uid}" class="ml-3 font-medium text-gray-700 flex-grow">
                                ${contact.name}
                            </label>
                        </div>
                    `;
                    listContainer.innerHTML += item;
                });
            }

            document.getElementById('new-group-modal').classList.remove('hidden');
        }
        
        window.hideNewGroupModal = function() {
            document.getElementById('new-group-modal').classList.add('hidden');
            document.getElementById('group-status-message').textContent = '';
            document.getElementById('group-name-input').value = '';
        }
        
        window.handleCreateGroup = async function() {
            const groupName = document.getElementById('group-name-input').value.trim();
            const statusMessage = document.getElementById('group-status-message');
            
            if (!groupName) {
                statusMessage.textContent = 'Group name is required.';
                return;
            }
            if (groupName.length > 30) {
                 statusMessage.textContent = 'Group name must be 30 characters or less.';
                 return;
            }

            // Get selected members (including the current user, who is disabled but its UID is used)
            const selectedMemberUids = [currentUserId]; // Start with the owner
            
            document.querySelectorAll('input[name="group-member"]:checked:not(:disabled)').forEach(input => {
                selectedMemberUids.push(input.value);
            });
            
            // Need at least one other member besides self
            if (selectedMemberUids.length < 2) {
                statusMessage.textContent = 'A group needs at least two members (You + 1 contact).';
                return;
            }
            
            statusMessage.textContent = 'Creating group...';
            
            try {
                // 1. Create the group document in the public directory
                const groupRef = collection(db, `/artifacts/${appId}/public/data/group_directory`);
                const newGroupDoc = await addDoc(groupRef, {
                    name: groupName,
                    members: selectedMemberUids,
                    ownerId: currentUserId,
                    createdAt: serverTimestamp()
                });
                
                statusMessage.textContent = `Group \"${groupName}\" created successfully!`;
                
                // 2. Navigate to the new group chat
                navigateTo('chat', { 
                    id: newGroupDoc.id, 
                    name: groupName, 
                    type: 'group' 
                });
                
                // 3. Hide modal after a short delay
                setTimeout(window.hideNewGroupModal, 1000);
            } catch (error) {
                console.error("Error creating group:", error);
                statusMessage.textContent = `Failed to create group: ${error.message}. Check Rules.`;
            }
        }

        // ===================================
        // CHAT DATA & MESSAGING LOGIC (Updated to use selectedChat)
        // ===================================

        /**
         * Generates a deterministic chat ID for a 1:1 conversation by sorting UIDs.
         */
        function getPrivateChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        /**
         * Gets the Firestore collection path for messages in the current chat.
         */
        function getMessagesCollectionRef(chatId) {
            // Path: /artifacts/{appId}/public/data/chats/{chatId}/messages
            return collection(db, `/artifacts/${appId}/public/data/chats/${chatId}/messages`);
        }

        // ===== Reactions (emoji) =====
        const REACTION_EMOJIS = ['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥'];

        // Floating reaction picker (dblclick / double-tap)
        let activeReactionPicker = null; // DOM element
        let activeReactionMessageId = null;
        let lastTapTime = 0;
        let lastTapMessageId = null;

        function closeReactionPicker() {
            if (activeReactionPicker && activeReactionPicker.parentNode) {
                activeReactionPicker.parentNode.removeChild(activeReactionPicker);
            }
            activeReactionPicker = null;
            activeReactionMessageId = null;
            document.removeEventListener('click', onOutsideClickClose, true);
        }

        function onOutsideClickClose(evt) {
            if (!activeReactionPicker) return;
            if (!activeReactionPicker.contains(evt.target)) {
                closeReactionPicker();
            }
        }

        function openReactionPicker(messageId, clientX, clientY) {
            closeReactionPicker();
            activeReactionMessageId = messageId;
            const picker = document.createElement('div');
            picker.id = 'reaction-picker';
            picker.className = 'fixed z-50 bg-white/95 backdrop-blur border shadow-lg rounded-full px-2 py-1 flex space-x-1';
            picker.style.left = Math.max(8, clientX - 100) + 'px';
            picker.style.top = Math.max(8, clientY - 50) + 'px';
            REACTION_EMOJIS.forEach(e => {
                const btn = document.createElement('button');
                btn.className = 'text-lg px-1';
                btn.textContent = e;
                btn.onclick = () => { window.toggleReaction(activeReactionMessageId, e); closeReactionPicker(); };
                picker.appendChild(btn);
            });
            document.body.appendChild(picker);
            activeReactionPicker = picker;
            setTimeout(() => document.addEventListener('click', onOutsideClickClose, true), 0);
        }

        /**
         * Toggle a reaction for the current user on a message.
         * Message doc will have field: reactions: { [emoji]: string[] } where array holds userIds
         */
        window.toggleReaction = async function(messageId, emoji) {
            try {
                const messageRef = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                const snap = await getDoc(messageRef);
                if (!snap.exists()) return;
                const data = snap.data() || {};
                const reactions = data.reactions || {};
                const currentArray = Array.isArray(reactions[emoji]) ? reactions[emoji] : [];
                const hasReacted = currentArray.includes(currentUserId);

                // Use atomic array operations on nested field using string path
                const fieldKey = `reactions.${emoji}`;
                await updateDoc(messageRef, {
                    [fieldKey]: hasReacted ? arrayRemove(currentUserId) : arrayUnion(currentUserId)
                });
            } catch (e) {
                displayError('Failed to react: ' + e.message);
            }
        }

        /**
         * Starts the real-time listener for messages.
         */
        function startChatListener(chatId) {
            if (unsubscribeMessages) {
                unsubscribeMessages(); // Stop previous listener
                unsubscribeMessages = null;
            }
            
            document.getElementById('message-display').innerHTML = '<div class="text-center text-gray-500 p-4">Loading messages...</div>';

            if (!chatId || !selectedChat) {
                document.getElementById('message-display').innerHTML = '<div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>';
                return;
            }

            const messagesRef = getMessagesCollectionRef(chatId);
            const q = query(messagesRef);

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // Sort client-side since Firestore query ordering is complex for this path
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                renderMessages(messages);
            }, (error) => {
                console.error("Error listening to messages:", error);
                displayError("Real-time update error: Missing or insufficient permissions. (Did you set the Firebase Rules?)");
            });
        }

        /**
         * Sends a message to Firestore.
         */
        async function sendMessage(type, content) {
            if (!currentChatId || !currentUserId || !selectedChat) {
                displayError("Chat not selected or user not authenticated. Cannot send message.");
                return;
            }
            if (!content) return;

            const newMessage = {
                userId: currentUserId,
                userName: currentUserName,
                type: type,
                content: content,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(getMessagesCollectionRef(currentChatId), newMessage);
            } catch (error) {
                console.error("Error sending message:", error);
                displayError(`Failed to send message: ${error.message}`);
            }
        }

        /**
         * Handles the click event for sending a text message.
         */
        window.handleSendText = function() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (text) {
                sendMessage('text', text);
                input.value = ''; // Clear input field
            }
        }

        /**
         * Renders the list of messages in the display area.
         */
        function renderMessages(messages) {
            const display = document.getElementById('message-display');
            display.innerHTML = ''; 
            
            if (messages.length === 0 && selectedChat) {
                 display.innerHTML = `<div class="text-center text-gray-500 p-4">Start a conversation with ${selectedChat.name}!</div>`;
            } else if (!selectedChat) {
                 display.innerHTML = '<div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>';
            }

            messages.forEach(msg => {
                const isSender = msg.userId === currentUserId;
                const alignment = isSender ? 'justify-end' : 'justify-start';
                const bubbleClass = isSender ? 'sender-bubble' : 'receiver-bubble';
                const showSenderName = selectedChat && selectedChat.type === 'group' && !isSender;

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${alignment} mb-2`;

                let contentHTML = '';
                
                switch (msg.type) {
                    case 'text':
                        contentHTML = msg.content;
                        break;
                    case 'image':
                        contentHTML = `<div class=\"relative\">\n` +
                            `<img src=\"${msg.content}\" class=\"w-full max-h-64 object-cover rounded-lg cursor-pointer\" onclick=\"window.open('${msg.content}', '_blank')\" onerror=\"this.onerror=null;this.src='https://placehold.co/200x150/ff0000/ffffff?text=Image+Load+Error';\" alt=\"Image Message\">` +
                            (!isSender ? `\n<div class=\"absolute -bottom-3 left-2 right-2 flex items-center space-x-2 sm:opacity-0 sm:group-hover:opacity-100 transition\">\n` +
                                `<div class=\"bg-white/90 backdrop-blur px-2 py-1 rounded-full shadow border flex items-center space-x-1 overflow-x-auto\">\n` +
                                    `${['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢','ðŸ”¥'].map(e => `<button class=\\\"text-sm\\\" onclick=\\\"window.toggleReaction('${msg.id}','${e}')\\\">${e}</button>`).join('')}` +
                                `</div>\n` +
                            `</div>` : '') +
                        `</div>`;
                        break;
                    case 'video':
                        contentHTML = `<video src="${msg.content}" controls class="w-full max-h-64 rounded-lg bg-black"></video>`;
                        break;
                    case 'audio':
                        contentHTML = `<audio src="${msg.content}" controls class="w-full"></audio>`;
                        break;
                }

                const bubble = document.createElement('div');
                bubble.className = `${bubbleClass} flex flex-col p-2 shadow-md relative group`;
                bubble.dataset.messageId = msg.id;
                
                if (msg.type === 'text') {
                    bubble.textContent = contentHTML;
                } else {
                    bubble.innerHTML = contentHTML;
                }
                
                if (showSenderName && msg.userName) {
                    const userIdText = document.createElement('span');
                    userIdText.className = 'text-xs font-semibold mb-1' + (msg.userName ? ' text-green-700' : ' text-gray-500');
                    userIdText.textContent = msg.userName;
                    bubble.prepend(userIdText);
                }

                // Reactions summary (below content)
                if (msg.reactions && typeof msg.reactions === 'object') {
                    const entries = Object.entries(msg.reactions).filter(([k, v]) => Array.isArray(v) && v.length > 0);
                    if (entries.length > 0) {
                        const reactionBar = document.createElement('div');
                        reactionBar.className = 'mt-1 self-start text-xs flex flex-wrap gap-1';
                        entries.forEach(([emoji, users]) => {
                            const pill = document.createElement('span');
                            const me = Array.isArray(users) && users.includes(currentUserId);
                            pill.className = 'px-2 py-0.5 rounded-full border bg-white ' + (me ? 'border-green-500' : 'border-gray-200');
                            pill.textContent = `${emoji} ${users.length}`;
                            pill.onclick = () => window.toggleReaction(msg.id, emoji);
                            reactionBar.appendChild(pill);
                        });
                        bubble.appendChild(reactionBar);
                    }
                }

                const timeSpan = document.createElement('span');
                timeSpan.className = `text-xs mt-1 self-end ${isSender ? 'text-gray-600' : 'text-gray-400'}`;
                if (msg.timestamp && msg.timestamp.toDate) {
                    const date = msg.timestamp.toDate();
                    timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else {
                    timeSpan.textContent = '...';
                }
                bubble.appendChild(timeSpan);

                if (isSender) {
                    const actions = document.createElement('div');
                    actions.className = 'absolute -top-2 ' + (isSender ? '-left-2' : '-right-2') + ' hidden group-hover:flex space-x-1';
                    actions.innerHTML = `
                        <button class="bg-white border rounded px-1 text-xs" onclick="window.promptEditMessage('${msg.id}', '${encodeURIComponent(msg.content || '')}')">Edit</button>
                        <button class="bg-white border rounded px-1 text-xs text-red-600" onclick="window.confirmDeleteMessage('${msg.id}')">Del</button>
                    `;
                    bubble.appendChild(actions);
                    bubble.addEventListener('mouseenter', () => actions.classList.remove('hidden'));
                    bubble.addEventListener('mouseleave', () => actions.classList.add('hidden'));
                }

                // Double-click (desktop)
                bubble.addEventListener('dblclick', (ev) => {
                    openReactionPicker(msg.id, ev.clientX, ev.clientY);
                });

                // Double-tap (mobile)
                bubble.addEventListener('touchend', (ev) => {
                    const now = Date.now();
                    const isSame = lastTapMessageId === msg.id;
                    if (isSame && (now - lastTapTime) < 350) {
                        const touch = ev.changedTouches && ev.changedTouches[0];
                        const x = touch ? touch.clientX : (ev.clientX || 0);
                        const y = touch ? touch.clientY : (ev.clientY || 0);
                        openReactionPicker(msg.id, x, y);
                        lastTapTime = 0;
                        lastTapMessageId = null;
                    } else {
                        lastTapTime = now;
                        lastTapMessageId = msg.id;
                    }
                }, { passive: true });

                messageDiv.appendChild(bubble);
                display.appendChild(messageDiv);
            });

            // Scroll to bottom only if the user is near the bottom
            const scrollThreshold = 200;
            if (display.scrollHeight - display.scrollTop < display.clientHeight + scrollThreshold) {
                display.scrollTop = display.scrollHeight;
            }
        }

        // ===== Message Edit/Delete Handlers =====
        window.promptEditMessage = function(messageId, encodedOld) {
            const oldContent = decodeURIComponent(encodedOld || '');
            const newText = prompt('Edit message:', oldContent);
            if (newText === null) return;
            window.updateMessageText(messageId, newText.trim());
        }

        window.updateMessageText = async function(messageId, newText) {
            if (!newText) return;
            try {
                const ref = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                await updateDoc(ref, { content: newText, editedAt: serverTimestamp() });
            } catch (e) {
                displayError('Failed to edit message: ' + e.message);
            }
        }

        window.confirmDeleteMessage = function(messageId) {
            if (confirm('Delete this message for everyone?')) {
                window.deleteMessage(messageId);
            }
        }

        window.deleteMessage = async function(messageId) {
            try {
                const ref = doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, messageId);
                await deleteDoc(ref);
            } catch (e) {
                displayError('Failed to delete message: ' + e.message);
            }
        }
        
        // ===================================
        // CLOUDINARY & MEDIA LOGIC (Unchanged)
        // ===================================

        async function uploadToCloudinary(file, resourceType) {
            if (CLOUDINARY_CLOUD_NAME === 'your_cloud_name') {
                displayError("Cloudinary is not configured. Please update CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET in the script.");
                return null;
            }
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
            
            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Cloudinary upload failed with status: ' + response.statusText);
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary upload error:", error);
                displayError(`Media upload failed: ${error.message}`);
                return null;
            }
        }

        window.handleFileSelect = async function(type) {
            const input = document.getElementById(`${type}-input`);
            const file = input.files[0];
            if (!file) return;

            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('loading-text').textContent = `Uploading ${type}...`;
            
            const resourceType = type === 'image' ? 'image' : 'video';
            const url = await uploadToCloudinary(file, resourceType);
            
            document.getElementById('loading-indicator').classList.add('hidden');

            if (url) {
                sendMessage(type, url);
            }
            input.value = null;
        }

        // ===== Emoji & Stickers =====
        window.toggleEmojiPanel = function() {
            const p = document.getElementById('emoji-panel');
            if (p) p.classList.toggle('hidden');
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.add('hidden');
        }

        window.toggleStickerPanel = function() {
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.toggle('hidden');
            const p = document.getElementById('emoji-panel');
            if (p) p.classList.add('hidden');
        }

        window.insertEmoji = function(char) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart || input.value.length;
            const end = input.selectionEnd || input.value.length;
            input.value = input.value.slice(0, start) + char + input.value.slice(end);
            input.focus();
            const pos = start + char.length;
            input.setSelectionRange(pos, pos);
        }

        window.sendSticker = function(url) {
            if (!url) return;
            sendMessage('image', url);
            const s = document.getElementById('sticker-panel');
            if (s) s.classList.add('hidden');
        }

        window.startRecording = async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                window.mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                window.mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                window.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    document.getElementById('record-button').style.display = 'none';
                    document.getElementById('stop-record-button').classList.add('hidden');
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    document.getElementById('loading-text').textContent = 'Uploading audio...';

                    const url = await uploadToCloudinary(audioBlob, 'raw');

                    document.getElementById('loading-indicator').classList.add('hidden');
                    
                    // Reset buttons after upload attempt
                    document.getElementById('record-icon').classList.remove('recording-indicator');
                    if (document.getElementById('message-input').value.trim().length === 0) {
                        document.getElementById('record-button').style.display = 'block';
                    } else {
                        document.getElementById('send-text-button').style.display = 'block';
                    }

                    if (url) {
                        sendMessage('audio', url);
                    }

                    stream.getTracks().forEach(track => track.stop());
                };

                window.mediaRecorder.start();
                document.getElementById('record-button').style.display = 'none';
                document.getElementById('stop-record-button').classList.remove('hidden');
                document.getElementById('send-text-button').style.display = 'none';
                document.getElementById('record-icon').classList.add('recording-indicator');

            } catch (error) {
                console.error("Error starting audio recording:", error);
                displayError("Microphone access denied or error: " + error.message);
            }
        }

        window.stopRecording = function() {
            if (window.mediaRecorder && window.mediaRecorder.state === 'recording') {
                window.mediaRecorder.stop();
            }
        }

        /**
         * Utility function to display non-alert messages.
         */
        function displayError(message) {
            const errorBox = document.getElementById('error-box');
            const displayMessage = message.includes("Missing or insufficient permissions") 
                ? "SECURITY ERROR: Missing or insufficient permissions. Please check Firebase Rules." 
                : message;

            errorBox.textContent = displayMessage;
            errorBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-600', 'bg-yellow-500');
            errorBox.classList.add(message.includes("SECURITY ERROR") ? 'bg-red-600' : 'bg-yellow-500');

            // Also display the error inside the auth container if visible
            const authError = document.getElementById('auth-error-message');
            if (authError && !document.getElementById('auth-container').classList.contains('hidden')) {
                authError.textContent = message;
            }

            setTimeout(() => {
                errorBox.classList.add('opacity-0', 'pointer-events-none');
            }, 5000);
        }

        // ===== Chat level actions =====
        window.toggleChatActions = function() {
            const menu = document.getElementById('chat-actions-menu');
            if (menu) menu.classList.toggle('hidden');
        }

        window.handleBackupChat = async function() {
            if (!currentChatId) return;
            try {
                const rows = [];
                const snap = await getDocs(getMessagesCollectionRef(currentChatId));
                snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
                const blob = new Blob([JSON.stringify({ chatId: currentChatId, messages: rows }, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat_${currentChatId}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                displayError('Failed to export chat: ' + e.message);
            }
        }

        window.handleDeleteChat = async function() {
            if (!currentChatId || !selectedChat) return;
            if (!confirm('Delete this chat and all its messages?')) return;
            try {
                const snap = await getDocs(getMessagesCollectionRef(currentChatId));
                const deletions = [];
                snap.forEach(d => deletions.push(deleteDoc(doc(db, `/artifacts/${appId}/public/data/chats/${currentChatId}/messages`, d.id))));
                await Promise.all(deletions);
                displayError('Chat cleared.');
            } catch (e) {
                displayError('Failed to delete chat: ' + e.message);
            }
        }

        // ===== Add members to group =====
        window.showAddMembersModal = function() {
            if (!selectedChat || selectedChat.type !== 'group') { displayError('Select a group chat.'); return; }
            const listContainer = document.getElementById('add-members-list');
            listContainer.innerHTML = '';
            const members = selectedChat.members || [];
            const eligible = currentContacts.filter(c => !members.includes(c.uid));
            if (eligible.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-600 p-3">No eligible contacts to add.</p>';
            } else {
                eligible.forEach(contact => {
                    listContainer.innerHTML += `
                        <div class="flex items-center p-2 border-b border-gray-100">
                            <input type="checkbox" id="add-${contact.uid}" value="${contact.uid}" class="w-4 h-4 text-green-600">
                            <label for="add-${contact.uid}" class="ml-3">${contact.name}</label>
                        </div>`;
                });
            }
            document.getElementById('add-members-modal').classList.remove('hidden');
        }

        window.hideAddMembersModal = function() {
            document.getElementById('add-members-modal').classList.add('hidden');
            document.getElementById('add-members-status').textContent = '';
        }

        window.handleAddMembersToGroup = async function() {
            const status = document.getElementById('add-members-status');
            const checked = Array.from(document.querySelectorAll('#add-members-list input[type="checkbox"]:checked')).map(i => i.value);
            if (checked.length === 0) { status.textContent = 'Select at least one contact.'; return; }
            try {
                const groupRef = doc(db, `/artifacts/${appId}/public/data/group_directory`, selectedChat.id);
                const currentMembers = selectedChat.members || [];
                const merged = Array.from(new Set([...currentMembers, ...checked]));
                await updateDoc(groupRef, { members: merged });
                status.textContent = 'Members added!';
                setTimeout(window.hideAddMembersModal, 800);
            } catch (e) {
                status.textContent = 'Failed: ' + e.message;
            }
        }

        // ===== Group photo (owner only) =====
        window.showChangeGroupPhoto = function() {
            if (!selectedChat || selectedChat.type !== 'group') { displayError('Open a group to change its photo.'); return; }
            if (selectedChat.ownerId && selectedChat.ownerId !== currentUserId) { displayError('Only the group owner can change the photo.'); return; }
            const input = document.getElementById('change-group-photo-input');
            input.onchange = async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('loading-text').textContent = 'Uploading group photo...';
                const url = await uploadToCloudinary(file, 'image');
                document.getElementById('loading-indicator').classList.add('hidden');
                if (!url) return;
                try {
                    const groupRef = doc(db, `/artifacts/${appId}/public/data/group_directory`, selectedChat.id);
                    await updateDoc(groupRef, { photoURL: url });
                    // Update header immediately
                    const avatar = document.getElementById('chat-avatar');
                    if (avatar) avatar.innerHTML = `<img src="${url}" class="w-10 h-10 rounded-full object-cover">`;
                    displayError('Group photo updated.');
                } catch (e2) {
                    displayError('Failed to set group photo: ' + e2.message);
                }
            };
            input.click();
        }

        // Initialize the application on load
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 p-0 sm:p-4">

    <!-- Error/Notification Box (Custom, non-alert) -->
    <div id="error-box" class="fixed top-4 right-4 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <!-- Error message will appear here -->
    </div>
    
    <!-- ADD CONTACT MODAL -->
    <div id="add-contact-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Add New Contact</h3>
            <p class="text-sm text-gray-600 mb-4">Enter the full UID of the user you want to chat with. Your UID is shown in Profile Settings.</p>
            
            <input type="text" id="contact-search-input" placeholder="User ID (Full UID)"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
            
            <p id="add-contact-status" class="text-sm text-red-500 h-5 mb-4"></p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideAddContactModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button onclick="handleAddContact()"
                        class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Add User
                </button>
            </div>
        </div>
    </div>
    
    <!-- NEW GROUP MODAL -->
    <div id="new-group-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Create New Group</h3>
            
            <input type="text" id="group-name-input" placeholder="Enter Group Name (e.g., Team Project)"
                   class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
            
            <h4 class="text-md font-semibold mb-2 text-gray-700">Select Members:</h4>
            <div id="group-contact-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg mb-4 bg-gray-50">
                <!-- Contacts will be populated here -->
            </div>
            
            <p id="group-status-message" class="text-sm text-red-500 h-5 mb-4"></p>
            
            <div class="flex justify-end space-x-3">
                <button onclick="hideNewGroupModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button id="create-group-button" onclick="handleCreateGroup()"
                        class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Create Group
                </button>
            </div>
        </div>
    </div>


    <!-- AUTHENTICATION SCREEN -->
    <div id="auth-container" class="flex flex-col items-center justify-center">
        <div class="auth-card">
            <h2 class="text-3xl font-extrabold text-center mb-6" style="color: var(--whatsapp-green);">
                Chat Login
            </h2>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150"
                       required>
                <input type="password" id="auth-password" placeholder="Password (min 6 characters)"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150"
                       required onkeyup="if(event.key === 'Enter') handleSignIn()">
                
                <p id="auth-error-message" class="text-sm text-red-500 text-center h-4"></p>
                
                <button onclick="handleSignIn()"
                        class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-light-green);">
                    Sign In
                </button>
                <button onclick="handleSignUp()"
                        class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                        style="background-color: var(--whatsapp-green);">
                    Create Account
                </button>
            </div>
            <p class="text-xs text-gray-500 text-center mt-4">
                Your ID is safe. Please use a strong password.
            </p>
        </div>
    </div>


    <!-- CHAT APPLICATION CONTAINER (Multi-View) -->
    <div id="chat-app-container" class="app-main-container bg-white rounded-lg sm:rounded-xl overflow-hidden hidden">
        
        <!-- LEFT PANEL: Chats/Groups List -->
        <div id="left-panel" class="left-panel bg-white">
            
            <!-- Sidebar Header -->
            <div class="header-bg p-3 flex justify-between items-center text-white shadow-md flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <button onclick="navigateTo('profile')" class="text-xl font-bold p-1 rounded-full border border-white hover:bg-white hover:text-green-800 transition duration-150">
                        <!-- Profile Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </button>
                    <span id="current-user-name-display" class="text-sm font-medium">Loading...</span>
                </div>
                
                <div class="flex items-center space-x-2">
                     <button onclick="handleSignOut()" class="text-xs px-2 py-1 border border-white rounded-full hover:bg-white hover:text-green-800 transition duration-150">
                        Sign Out
                     </button>
                </div>
            </div>
            
            <!-- Chats/Groups Search + List -->
            <div class="p-2 border-b bg-white flex-shrink-0">
                <input id="chat-search-input" type="text" placeholder="Search chats or users..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" oninput="window.handleChatSearch(this.value)">
            </div>
            <div id="chats-list" class="flex-grow overflow-y-auto">
                <div class="p-3 text-center text-gray-500">Loading chats...</div>
            </div>
            
            <!-- Contact/Group Action Bar -->
            <div class="p-3 border-t flex justify-around flex-shrink-0">
                <button onclick="showAddContactModal()" class="flex items-center text-whatsapp-green hover:text-green-700 font-semibold">
                    <!-- Add Contact -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                    Add Contact
                </button>
                <button onclick="showNewGroupModal()" class="flex items-center text-whatsapp-green hover:text-green-700 font-semibold">
                    <!-- New Group -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    New Group
                </button>
            </div>
        </div>

        <!-- RIGHT PANEL: Chat View / Profile Settings -->
        <div id="right-panel" class="right-panel">
            
            <!-- Loading Indicator (for file uploads) -->
            <div id="loading-indicator" class="hidden bg-yellow-500 text-white p-2 text-center text-sm absolute top-0 w-full z-20">
                <span id="loading-text"></span> (Please wait...)
            </div>

            <!-- CHAT VIEW -->
            <div id="chat-view" class="flex flex-col flex-grow h-full">

                <!-- Chat Header -->
                <div class="header-bg p-3 flex justify-between items-center text-white shadow-md flex-shrink-0">
                    <div class="flex items-center">
                        <!-- Back button for mobile -->
                        <button onclick="navigateTo('contacts')" class="sm:hidden mr-2 p-1 rounded-full hover:bg-white hover:text-green-800 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <span id="chat-avatar" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-lg mr-3 overflow-hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </span>
                        <h1 id="chat-partner-name" class="text-lg font-bold">Select a Chat</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <button onclick="toggleChatActions()" class="p-1 rounded hover:bg-white hover:text-green-800 transition duration-150" title="Chat actions">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                            </button>
                            <div id="chat-actions-menu" class="hidden absolute right-0 mt-2 bg-white text-gray-700 rounded shadow-lg z-30 min-w-[200px]">
                                <button onclick="handleBackupChat()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Backup / Export JSON</button>
                                <button onclick="handleDeleteChat()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm text-red-600">Delete Chat</button>
                                <button onclick="showAddMembersModal()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Add Members (Group)</button>
                                <button onclick="showChangeGroupPhoto()" class="block w-full text-left px-3 py-2 hover:bg-gray-100 text-sm">Change Group Photo</button>
                            </div>
                        </div>
                        <div class="text-xs opacity-70">UID: <span id="user-id-display">...</span></div>
                    </div>
                </div>

                <!-- Message Display Area -->
                <div id="message-display" class="flex-grow flex flex-col space-y-2">
                    <div class="text-center text-gray-500 p-4">Select a chat to begin messaging.</div>
                </div>

                <!-- Input Area -->
                <div id="chat-input-area" class="p-3 border-t bg-gray-50 flex items-center shadow-inner flex-shrink-0">
                    
                    <!-- Hidden File Inputs -->
                    <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleFileSelect('image')">
                    <input type="file" id="video-input" accept="video/*" class="hidden" onchange="handleFileSelect('video')">

                    <!-- Media Attachments -->
                    <button onclick="window.toggleEmojiPanel()" class="media-button text-gray-600 hover:text-green-500 p-2 rounded-full" title="Emojis">
                        <!-- Emoji Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                    </button>
                    <button onclick="window.toggleStickerPanel()" class="media-button text-gray-600 hover:text-green-500 p-2 rounded-full" title="Stickers">
                        <!-- Sticker Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14v4a2 2 0 0 1-2 2h-4"/><path d="M14 20H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h11a2 2 0 0 1 2 2v7z"/></svg>
                    </button>
                    <button onclick="document.getElementById('image-input').click()" class="media-button text-gray-600 hover:text-green-500 p-2 rounded-full">
                        <!-- Image Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 8v.01"></path><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><path d="M4 15l4-4c.983-.983 2.14-1.474 3.473-1.474s2.49.491 3.473 1.474l4 4"></path></svg>
                    </button>
                    <button onclick="document.getElementById('video-input').click()" class="media-button text-gray-600 hover:text-green-500 p-2 rounded-full">
                        <!-- Video Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 7l-7 5 7 5V7z"></path><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    </button>
                    
                    <!-- Message Input -->
                    <input type="text" id="message-input" placeholder="Type a message..." 
                           class="flex-grow mx-2 p-3 border-2 border-gray-300 rounded-full focus:outline-none focus:border-green-500" 
                           onkeyup="if(event.key === 'Enter') handleSendText()">

                    <!-- Audio Recording / Send Button -->
                    <div class="relative flex items-center">
                        <!-- Record Button -->
                        <button id="record-button" onclick="startRecording()" 
                                class="media-button bg-whatsapp-light-green text-white p-3 rounded-full shadow-lg hover:bg-whatsapp-green transition duration-150">
                            <svg id="record-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="21" x2="12" y2="23"></line></svg>
                        </button>
                        
                        <!-- Stop Recording Button -->
                        <button id="stop-record-button" onclick="stopRecording()" 
                                class="hidden media-button bg-red-600 text-white p-3 rounded-full shadow-lg hover:bg-red-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect></svg>
                        </button>

                        <!-- Send Text Button (appears when typing) -->
                        <button id="send-text-button" onclick="handleSendText()"
                                class="media-button bg-whatsapp-light-green text-white p-3 rounded-full shadow-lg hover:bg-whatsapp-green transition duration-150 absolute right-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>

                    </div>
                </div>

            </div>
            
            <!-- Emoji Panel -->
            <div id="emoji-panel" class="hidden absolute bottom-24 left-4 bg-white border rounded-lg shadow-lg p-2 max-w-sm w-72 z-20">
                <div class="grid grid-cols-8 gap-1 text-xl">
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜€')">ðŸ˜€</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜‚')">ðŸ˜‚</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜Š')">ðŸ˜Š</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜')">ðŸ˜</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜Ž')">ðŸ˜Ž</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜‰')">ðŸ˜‰</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜‡')">ðŸ˜‡</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ¤”')">ðŸ¤”</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜…')">ðŸ˜…</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ¥³')">ðŸ¥³</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ¤©')">ðŸ¤©</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜¢')">ðŸ˜¢</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜­')">ðŸ˜­</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ˜¤')">ðŸ˜¤</button>
                    <button class="p-1" onclick="window.insertEmoji('â¤ï¸')">â¤ï¸</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ‘')">ðŸ‘</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ‘‰')">ðŸ‘‰</button>
                    <button class="p-1" onclick="window.insertEmoji('âž¡ï¸')">âž¡ï¸</button>
                    <button class="p-1" onclick="window.insertEmoji('âœ…')">âœ…</button>
                    <button class="p-1" onclick="window.insertEmoji('âœ”ï¸')">âœ”ï¸</button>
                    <button class="p-1" onclick="window.insertEmoji('â˜‘ï¸')">â˜‘ï¸</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ™')">ðŸ™</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ”¥')">ðŸ”¥</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸŽ‰')">ðŸŽ‰</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ’¯')">ðŸ’¯</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸŒŸ')">ðŸŒŸ</button>
                    <button class="p-1" onclick="window.insertEmoji('ðŸ•')">ðŸ•</button>
                    <button class="p-1" onclick="window.insertEmoji('â˜•')">â˜•</button>
                    <button class="p-1" onclick="window.insertEmoji('âœˆï¸')">âœˆï¸</button>
                </div>
            </div>

            <!-- Sticker Panel -->
            <div id="sticker-panel" class="hidden absolute bottom-24 left-24 bg-white border rounded-lg shadow-lg p-2 max-w-md w-80 z-20">
                <div class="grid grid-cols-4 gap-2">
                    <!-- Right thumb sticker (teal) -->
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'><rect width='256' height='256' rx='30' ry='30' fill='%23e6f7f1'/><path d='M60 140h48l26-54c6-12 22-8 22 6v48h24c10 0 18 8 18 18 0 10-8 18-18 18h-80c-12 0-22-10-22-22v-14z' fill='%23128C7E'/></svg>" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <!-- Done/Check sticker (green tick) -->
                    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'><rect width='256' height='256' rx='30' ry='30' fill='%23eaf7ea'/><circle cx='128' cy='128' r='96' fill='%23cdeed2'/><path d='M86 130l22 22 62-62' fill='none' stroke='%23128C7E' stroke-width='16' stroke-linecap='round' stroke-linejoin='round'/></svg>" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/0r8ZK8C.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/7uZ8cE1.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/3bEfd0q.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/2mFQF7f.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/5H0x3wT.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/HhWJk2M.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/5Gk7oQy.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                    <img src="https://i.imgur.com/0m8UQ1n.png" class="w-16 h-16 object-contain cursor-pointer" onclick="window.sendSticker(this.src)">
                </div>
            </div>
            
            <!-- PROFILE SETTINGS VIEW -->
            <div id="profile-settings-view" class="p-8 bg-gray-50 flex-col items-center justify-start h-full hidden">
                <div class="w-full max-w-lg mx-auto">
                    <button onclick="navigateTo('contacts')" class="text-whatsapp-green mb-4 flex items-center hover:text-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        Back to Chats
                    </button>
                    <h2 class="text-3xl font-bold mb-6 text-center" style="color: var(--whatsapp-green);">Profile Settings</h2>

                    <div class="flex flex-col items-center mb-8">
                        <div id="profile-avatar" class="w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold text-3xl mb-4 overflow-hidden">
                            <!-- Placeholder for Profile Picture -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </div>
                        <p class="text-sm text-gray-600">Your Full UID:</p>
                        <p id="profile-uid-display" class="font-mono text-sm text-gray-800 break-all"></p>
                    </div>

                    <div class="space-y-4">
                        <label for="current-profile-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                        <input type="text" id="current-profile-name" placeholder="Enter your name"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <div class="flex items-center space-x-3">
                            <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="handleUploadProfilePicture()">
                            <button onclick="document.getElementById('profile-picture-input').click()"
                                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Change Photo</button>
                        </div>
                        
                        <button onclick="handleUpdateProfile()"
                                class="w-full py-3 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200"
                                style="background-color: var(--whatsapp-light-green);">
                            Save Profile
                        </button>
                        <p id="profile-status-message" class="text-sm text-center text-green-600 h-4"></p>
                    </div>
                </div>
            </div>

        </div> <!-- End Right Panel -->
    </div>

    <!-- ADD MEMBERS TO GROUP MODAL -->
    <div id="add-members-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4" style="color: var(--whatsapp-green);">Add Members</h3>
            <div id="add-members-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg mb-4 bg-gray-50"></div>
            <p id="add-members-status" class="text-sm text-red-500 h-5 mb-4"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideAddMembersModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button onclick="handleAddMembersToGroup()" class="px-4 py-2 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition duration-200" style="background-color: var(--whatsapp-light-green);">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- CHANGE GROUP PHOTO (owner only) -->
    <input type="file" id="change-group-photo-input" accept="image/*" class="hidden">

    <!-- Script to manage button visibility (Send vs. Record) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('message-input');
            const recordButton = document.getElementById('record-button');
            const sendTextButton = document.getElementById('send-text-button');
            const stopRecordButton = document.getElementById('stop-record-button');

            // Initial state: Show record button, hide send button
            sendTextButton.style.display = 'none';

            messageInput.addEventListener('input', () => {
                // FIX: Check for the existence of window.mediaRecorder before checking its state
                const isRecording = window.mediaRecorder && window.mediaRecorder.state === 'recording';

                if (messageInput.value.trim().length > 0) {
                    recordButton.style.display = 'none';
                    stopRecordButton.classList.add('hidden'); // Ensure stop is hidden when typing
                    if (!isRecording) {
                        sendTextButton.style.display = 'block';
                    }
                } else {
                    sendTextButton.style.display = 'none';
                    // Safely check for mediaRecorder existence on the window object.
                    if (!isRecording) {
                         recordButton.style.display = 'block';
                    }
                }
            });

            // Make sure media buttons handle visibility correctly after recording logic
            const updateButtonsAfterMedia = () => {
                // If input is empty, revert to record button.
                if (messageInput.value.trim().length === 0) {
                    recordButton.style.display = 'block';
                    sendTextButton.style.display = 'none';
                }
                stopRecordButton.classList.add('hidden');
            };

            const originalStopRecording = window.stopRecording;
            window.stopRecording = function() {
                originalStopRecording();
                // A small delay to allow the async upload process to start before resetting UI
                setTimeout(updateButtonsAfterMedia, 500);
            }
        });
        
        // Ensure the layout renders correctly on resize
        window.addEventListener('resize', () => {
            // Check for both existence and authentication status
            if (typeof window.auth !== 'undefined' && window.auth.currentUser) {
                renderApp();
            }
        });

    </script>
</body>
</html>
